<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Archalo</title>
    <link rel="icon" type="image/png" href="owlcheologists.png">
    <script src="https://www.google.com/recaptcha/enterprise.js?render=6LfiAjYsAAAAABjnkEQXCk7t9qBN0Ut8V9R-8tyX"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
        }
        
        /* Hero section */
        .hero {
            background: linear-gradient(135deg, #d4a574, #8b6f47);
            color: white;
            padding: clamp(3rem, 6vw, 4rem) 2rem;
            text-align: center;
        }
        
        .hero h1 {
            font-size: clamp(2.5rem, 6vw, 3.5rem);
            margin-bottom: 1rem;
            font-weight: 700;
            letter-spacing: -1px;
        }
        
        .hero p {
            font-size: clamp(1rem, 3vw, 1.2rem);
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        /* Admin container */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: clamp(2rem, 4vw, 3rem) 2rem;
        }
        
        /* Login section */
        .login-section {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }
        
        .login-section h2 {
            color: #2c3e50;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #3498db;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            width: 100%;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* Admin panel sections */
        .admin-panel {
            display: none;
        }
        
        .user-info {
            background: #e8f5e9;
            border: 1px solid #81c784;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .user-info p {
            color: #2e7d32;
            margin: 0;
            font-weight: 600;
        }
        
        .logout-btn {
            padding: 0.6rem 1.5rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .section-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .section-card h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        .section-card h3 {
            color: #2c3e50;
            margin: 1.5rem 0 1rem 0;
            font-size: 1.3rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .search-result {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .search-result:hover {
            background: #e3f2fd;
            border-color: #3498db;
            transform: translateY(-2px);
        }
        
        .search-result h4 {
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }
        
        .search-result p {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .search-result .actions {
            margin-top: 0.8rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .search-result button {
            padding: 0.4rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .edit-btn {
            background: #3498db;
            color: white;
        }
        
        .edit-btn:hover {
            background: #2980b9;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .warning-banner {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: #856404;
        }
        
        .warning-banner strong {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        /* Admin Layout */
        .admin-panel-wrapper {
            display: flex;
            gap: 2rem;
            position: relative;
        }
        
        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: sticky;
            top: 1rem;
            left: 0;
            z-index: 1001;
            padding: 0.8rem 1rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            width: fit-content;
        }
        
        .mobile-menu-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(52, 152, 219, 0.4);
        }
        
        /* Admin Navigation Sidebar */
        .admin-nav {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 280px;
            flex-shrink: 0;
            position: sticky;
            top: 20px;
            align-self: flex-start;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .admin-nav-separator {
            height: 1px;
            background: #e0e0e0;
            margin: 0.5rem 0;
        }
        
        .admin-nav-tab {
            padding: 1rem 1.2rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .admin-nav-tab:hover {
            background: #ecf0f1;
            color: #2c3e50;
            transform: translateX(4px);
        }
        
        .admin-nav-tab.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            transform: translateX(0);
        }
        
        .admin-content-wrapper {
            flex: 1;
            min-width: 0;
        }
        
        .admin-section-content {
            display: none;
        }
        
        .admin-section-content.active {
            display: block;
        }
        
        /* Mobile Responsive */
        @media (max-width: 968px) {
            .mobile-menu-toggle {
                display: block !important;
            }
            
            .admin-panel-wrapper {
                flex-direction: column;
            }
            
            .admin-nav {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                max-height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                border-radius: 0;
                padding-top: 1.5rem;
            }
            
            .admin-nav.mobile-open {
                left: 0;
            }
            
            .mobile-menu-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            .mobile-menu-overlay.active {
                display: block;
            }
            
            .admin-content-wrapper {
                margin-top: 3rem;
            }
        }
        
        /* Contact Management Styles */
        .contact-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .contact-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .contact-item-header h5 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.1rem;
        }
        
        .remove-contact-btn {
            padding: 0.5rem 1rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .remove-contact-btn:hover {
            background: #c0392b;
        }
        
        .contact-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .contact-fields .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .law-type {
            text-transform: uppercase;
        }
        
        .law-type.federal {
            background: #3498db;
            color: white;
        }
        
        .law-type.state {
            background: #27ae60;
            color: white;
        }
        
        .law-type.county {
            background: #f39c12;
            color: white;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                text-align: center;
                justify-content: center;
            }
            
            .contact-fields {
                grid-template-columns: 1fr;
            }
            
            .admin-container {
                padding: clamp(1rem, 4vw, 3rem) 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation loaded by shared_nav.js -->
    <script src="js/shared_nav.js"></script>

    <section class="hero">
        <h1>üîê Admin Panel</h1>
        <p>Manage archaeology laws and resources</p>
    </section>

    <section class="admin-container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>Admin Login</h2>
            <div class="form-group">
                <label for="adminEmail">Email</label>
                <input type="email" id="adminEmail" placeholder="admin@example.com" required>
            </div>
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" placeholder="Enter password" required>
            </div>
            <button id="loginBtn" class="btn">Login</button>
            <div id="loginMessage" style="margin-top: 1rem;"></div>
        </div>

        <!-- Admin Panel (shown after login) -->
        <div id="adminPanel" class="admin-panel">
            <div class="user-info">
                <p>üë§ Logged in as: <span id="userEmail"></span></p>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>

            <div class="warning-banner">
                <strong>‚ö†Ô∏è Important:</strong>
                Please ensure to verify that all information is accurate before creating, editing, or deleting laws.
            </div>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞ Menu</button>
            
            <!-- Mobile Menu Overlay -->
            <div class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>
            
            <div class="admin-panel-wrapper">
                <!-- Admin Navigation Sidebar -->
                <div class="admin-nav" id="adminNav">
                    <button class="admin-nav-tab active" onclick="switchAdminSection('laws')">üìö Laws</button>
                    <div class="admin-nav-separator"></div>
                    <button class="admin-nav-tab" onclick="switchAdminSection('artifacts')">üè∫ Artifact Instructions</button>
                    <div class="admin-nav-separator"></div>
                    <button class="admin-nav-tab" onclick="switchAdminSection('education')">üìñ Educational Resources</button>
                    <div class="admin-nav-separator"></div>
                    <button class="admin-nav-tab" onclick="switchAdminSection('announcements')">üì¢ Announcements</button>
                    <div class="admin-nav-separator"></div>
                    <button class="admin-nav-tab" onclick="switchAdminSection('credits')">‚úçÔ∏è Credits Page</button>
                    <div class="admin-nav-separator"></div>
                    <button class="admin-nav-tab" onclick="switchAdminSection('parcelViewers')">üó∫Ô∏è Parcel Viewers</button>
                    <div class="admin-nav-separator"></div>
                    <button class="admin-nav-tab" onclick="switchAdminSection('artifactOfDay')">üè∫ Artifact of the Day</button>
                </div>
                
                <div class="admin-content-wrapper">

            <!-- Laws Section -->
            <div id="lawsSection" class="admin-section-content active">
            <div class="warning-banner">
                <strong>‚ö†Ô∏è Important:</strong>
                Please ensure to verify that all information is accurate before creating, editing, or deleting laws.
            </div>

            <!-- Search & Edit Section -->
            <div class="section-card">
                <h2>üîç Search & Edit Laws</h2>
                <div class="form-row">
                    <input type="text" id="lawSearchInput" placeholder="Search by title, year, or tags..." 
                           style="padding: 0.8rem 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    <button onclick="searchLaws()" class="btn" style="width: auto;">Search</button>
                </div>
                <div id="lawSearchResults" style="margin-top: 1.5rem;"></div>
            </div>

            <!-- Edit Law Section (hidden by default) -->
            <div id="editLawSection" class="section-card" style="display: none;">
                <h2>‚úèÔ∏è Edit Law</h2>
                <input type="hidden" id="editLawId">
                
                <div class="form-group">
                    <label for="editLawType">Law Type</label>
                    <select id="editLawType">
                        <option value="federal">Federal</option>
                        <option value="state">State</option>
                        <option value="county">County</option>
                    </select>
                </div>

                <div id="editJurisdictionFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editLawState">State</label>
                            <select id="editLawState">
                                <option value="">Select State...</option>
                            </select>
                        </div>
                        <div class="form-group" id="editCountyField" style="display: none;">
                            <label for="editLawCounty">County (Optional)</label>
                            <input type="text" id="editLawCounty" placeholder="e.g., Los Angeles County">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editLawTitle">Law Title *</label>
                    <input type="text" id="editLawTitle" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editLawYear">Year Enacted *</label>
                        <input type="text" id="editLawYear" required>
                    </div>
                    <div class="form-group">
                        <label for="editLawIcon">Icon (emoji)</label>
                        <input type="text" id="editLawIcon" maxlength="2" placeholder="‚öñÔ∏è">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editLawSummary">Summary *</label>
                    <textarea id="editLawSummary" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editLawSignificance">Significance *</label>
                    <textarea id="editLawSignificance" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editLawEnforcement">Enforcement *</label>
                    <textarea id="editLawEnforcement" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editLawFullText">Full Text (Excerpt) *</label>
                    <textarea id="editLawFullText" required style="min-height: 150px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editLawTags">Tags (comma-separated)</label>
                    <input type="text" id="editLawTags" placeholder="e.g., ARPA, Permits, Federal Lands">
                </div>
                
                <div class="form-group">
                    <label for="editLawNotes">Notes (Optional)</label>
                    <textarea id="editLawNotes"></textarea>
                </div>
                
                <div class="form-row">
                    <button onclick="updateLaw()" class="btn btn-success">Update Law</button>
                    <button onclick="cancelEdit()" class="btn btn-secondary">Cancel</button>
                </div>
                <div id="editMessage"></div>
            </div>

            <!-- Add New Law Section -->
            <div class="section-card">
                <h2>‚ûï Add New Law</h2>
                
                <div class="form-group">
                    <label for="lawType">Law Type</label>
                    <select id="lawType">
                        <option value="federal">Federal</option>
                        <option value="state">State</option>
                        <option value="county">County</option>
                    </select>
                </div>

                <div id="jurisdictionFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="lawState">State</label>
                            <select id="lawState">
                                <option value="">Select State...</option>
                            </select>
                        </div>
                        <div class="form-group" id="countyField" style="display: none;">
                            <label for="lawCounty">County (Optional)</label>
                            <input type="text" id="lawCounty" placeholder="e.g., Los Angeles County">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="lawTitle">Law Title *</label>
                    <input type="text" id="lawTitle" placeholder="e.g., Archaeological Resources Protection Act" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="lawYear">Year Enacted *</label>
                        <input type="text" id="lawYear" placeholder="e.g., 1979" required>
                    </div>
                    <div class="form-group">
                        <label for="lawIcon">Icon (emoji)</label>
                        <input type="text" id="lawIcon" placeholder="e.g., ‚öñÔ∏è" maxlength="2">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="lawSummary">Summary *</label>
                    <textarea id="lawSummary" placeholder="Brief summary of the law..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="lawSignificance">Significance *</label>
                    <textarea id="lawSignificance" placeholder="Why is this law important?" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="lawEnforcement">Enforcement *</label>
                    <textarea id="lawEnforcement" placeholder="Who enforces this law?" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="lawFullText">Full Text (Excerpt) *</label>
                    <textarea id="lawFullText" placeholder="Full text or excerpt of the law..." required style="min-height: 150px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="lawTags">Tags (comma-separated)</label>
                    <input type="text" id="lawTags" placeholder="e.g., ARPA, Permits, Federal Lands">
                </div>
                
                <div class="form-group">
                    <label for="lawNotes">Notes (Optional)</label>
                    <textarea id="lawNotes" placeholder="Additional notes or comments about this law..."></textarea>
                </div>
                
                <button onclick="submitLaw()" class="btn btn-success" id="submitBtn">
                    Add Law to Database
                </button>
                
                <div id="submitMessage"></div>
            </div>
            
            </div>
            <!-- End Laws Section -->
            
            <!-- Artifact Instructions Section -->
            <div id="artifactsSection" class="admin-section-content">
                        <div class="warning-banner">
                <strong>‚ö†Ô∏è Important:</strong>
                Do not make click "View Property Information" to find parcel data, go to "parcel viewers" tab to find parcel data. 
            </div>

            <!-- Search & Edit Instructions Section -->
            <div class="section-card">
                <h2>üîç Search & Edit Instructions</h2>
                <div class="form-row">
                    <input type="text" id="instructionSearchInput" placeholder="Search by state, city, owner, keywords..." 
                           style="padding: 0.8rem 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    <button onclick="searchInstructions()" class="btn" style="width: auto;">Search</button>
                </div>
                <div id="instructionSearchResults" style="margin-top: 1.5rem;"></div>
            </div>

            <!-- Edit Instruction Section (hidden by default) -->
            <div id="editInstructionSection" class="section-card" style="display: none;">
                <h2>‚úèÔ∏è Edit Instruction</h2>
                <input type="hidden" id="editInstructionId">
                
                <h3>Location Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editInstructionState">State (2-letter code)</label>
                        <input type="text" id="editInstructionState" maxlength="2" placeholder="e.g., CA">
                    </div>
                    <div class="form-group">
                        <label for="editInstructionCity">City</label>
                        <input type="text" id="editInstructionCity" placeholder="e.g., Los Angeles">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editInstructionJurisdiction">Jurisdiction</label>
                        <input type="text" id="editInstructionJurisdiction" placeholder="e.g., County, Federal Land">
                    </div>
                    <div class="form-group">
                        <label for="editInstructionOwner">Land Owner</label>
                        <input type="text" id="editInstructionOwner" placeholder="e.g., BLM, Forest Service">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editInstructionKeywords">Keywords (comma-separated)</label>
                    <input type="text" id="editInstructionKeywords" placeholder="e.g., federal, blm, public lands">
                    <div id="editKeywordPreview" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                </div>
                
                <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                
                <h3>üìû Contacts</h3>
                <div id="editContactsList">
                    <!-- Contacts will be added here dynamically -->
                </div>
                
                <button type="button" onclick="addEditContactField()" class="btn" style="background: #27ae60; margin-bottom: 1rem;">
                    ‚ûï Add Contact
                </button>
                
                <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                
                <h3>‚öñÔ∏è Applicable Laws</h3>
                <button type="button" onclick="loadAvailableLaws('editLawsSelection', 'editSelectedLawsPreview')" class="btn" style="background: #9b59b6; margin-bottom: 1rem;">üìú Load Available Laws</button>
                <div id="editLawsSelection" style="display: none; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <!-- Laws checkboxes will be loaded here -->
                </div>
                <div id="editSelectedLawsPreview" style="margin-top: 1rem;"></div>
                
                <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                
                <h3>Special Instructions</h3>
                <div class="form-group">
                    <label for="editInstructionProbability">Artifact Likelihood Level (Optional)</label>
                    <select id="editInstructionProbability">
                        <option value="">-- None / Not Shown --</option>
                        <option value="low">üü¢ Low - Few known archaeological findings in this area</option>
                        <option value="moderate">üü° Moderate - Some historical or archaeological activity nearby</option>
                        <option value="elevated">üü† Elevated - Area with documented archaeological sensitivity</option>
                        <option value="high">üî¥ High - Area known for significant archaeological presence</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 0.5rem; display: block;">Educational estimate based on available records. Leave empty to hide this indicator.</small>
                </div>
                
                <div class="form-group">
                    <label for="editInstructionSpecial">Special Instructions (Optional)</label>
                    <textarea id="editInstructionSpecial" placeholder="Important specific steps or requirements for this location..."></textarea>
                </div>
                
                <h3>General Notes</h3>
                <div class="form-group">
                    <label for="editInstructionGeneral">General Notes & Instructions (Optional)</label>
                    <textarea id="editInstructionGeneral" placeholder="Additional guidance, procedures, legal requirements, or general information..."></textarea>
                </div>
                
                <div class="form-row">
                    <button onclick="updateInstruction()" class="btn btn-success">Update Instruction</button>
                    <button onclick="cancelEditInstruction()" class="btn btn-secondary">Cancel</button>
                </div>
                <div id="editInstructionMessage"></div>
            </div>

            <!-- Add New Instruction Section -->
            <div class="section-card">
                <h2>‚ûï Add New Instruction</h2>
                
                <h3>Location Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="instructionState">State (2-letter code)</label>
                        <input type="text" id="instructionState" maxlength="2" placeholder="e.g., CA">
                    </div>
                    <div class="form-group">
                        <label for="instructionCity">City</label>
                        <input type="text" id="instructionCity" placeholder="e.g., Los Angeles">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="instructionJurisdiction">Jurisdiction</label>
                        <input type="text" id="instructionJurisdiction" placeholder="e.g., County, Federal Land">
                    </div>
                    <div class="form-group">
                        <label for="instructionOwner">Land Owner</label>
                        <input type="text" id="instructionOwner" placeholder="e.g., BLM, Forest Service">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="instructionKeywords">Keywords (comma-separated)</label>
                    <input type="text" id="instructionKeywords" placeholder="e.g., federal, blm, public lands">
                    <div id="keywordPreview" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                </div>
                
                <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                
                <h3>üìû Contacts</h3>
                <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Add the contact information for authorities who should be notified when an artifact is found.</p>
                
                <div id="contactsList">
                    <!-- Contacts will be added here dynamically -->
                </div>
                
                <button type="button" onclick="addContactField()" class="btn" style="background: #27ae60; margin-bottom: 1rem;">
                    ‚ûï Add Contact
                </button>
                
                <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                
                <h3>‚öñÔ∏è Applicable Laws</h3>
                <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Select which laws apply to this location. If no laws are selected, the laws section will be hidden for this instruction.</p>
                <button type="button" onclick="loadAvailableLaws('lawsSelection', 'selectedLawsPreview')" class="btn" style="background: #9b59b6; margin-bottom: 1rem;">üìú Load Available Laws</button>
                <div id="lawsSelection" style="display: none; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <!-- Laws checkboxes will be loaded here -->
                </div>
                <div id="selectedLawsPreview" style="margin-top: 1rem;"></div>
                
                <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                
                <h3>Special Instructions</h3>
                <div class="form-group">
                    <label for="instructionProbability">Artifact Likelihood Level (Optional)</label>
                    <select id="instructionProbability">
                        <option value="">-- None / Not Shown --</option>
                        <option value="low">üü¢ Low - Few known archaeological findings in this area</option>
                        <option value="moderate">üü° Moderate - Some historical or archaeological activity nearby</option>
                        <option value="elevated">üü† Elevated - Area with documented archaeological sensitivity</option>
                        <option value="high">üî¥ High - Area known for significant archaeological presence</option>
                    </select>
                    <small style="color: #7f8c8d; margin-top: 0.5rem; display: block;">Educational estimate based on available records. Leave empty to hide this indicator.</small>
                </div>
                
                <div class="form-group">
                    <label for="instructionSpecial">Special Instructions (Optional)</label>
                    <textarea id="instructionSpecial" placeholder="Important specific steps or requirements for this location..."></textarea>
                </div>
                
                <h3>General Notes</h3>
                <div class="form-group">
                    <label for="instructionGeneral">General Notes & Instructions (Optional)</label>
                    <textarea id="instructionGeneral" placeholder="Additional guidance, procedures, legal requirements, or general information..."></textarea>
                </div>
                
                <button onclick="submitInstruction()" class="btn btn-success" id="submitInstructionBtn">
                    üíæ Save Instruction
                </button>
                
                <div id="submitInstructionMessage"></div>
            </div>
            
            </div>
            <!-- End Artifact Instructions Section -->
            
            <!-- Educational Resources Section -->
            <div id="educationSection" class="admin-section-content">
            
            <!-- Search & Edit Resources Section -->
            <div class="section-card">
                <h2>üîç Search & Edit Resources</h2>
                <div class="form-row">
                    <input type="text" id="resourceSearchInput" placeholder="Search by title or keywords..." 
                           style="padding: 0.8rem 1rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
                    <button onclick="searchResources()" class="btn" style="width: auto;">Search</button>
                </div>
                <div id="resourceSearchResults" style="margin-top: 1.5rem;"></div>
            </div>

            <!-- Edit Resource Section (hidden by default) -->
            <div id="editResourceSection" class="section-card" style="display: none;">
                <h2>‚úèÔ∏è Edit Resource</h2>
                <input type="hidden" id="editResourceId">
                
                <div class="form-group">
                    <label for="editResourceIcon">Icon (emoji) *</label>
                    <input type="text" id="editResourceIcon" maxlength="5" placeholder="e.g., üìñ" required>
                </div>
                
                <div class="form-group">
                    <label for="editResourceTitle">Resource Title *</label>
                    <input type="text" id="editResourceTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="editResourceContent">Content (Markdown) *</label>
                    <textarea id="editResourceContent" required style="min-height: 300px;" placeholder="Use markdown formatting..."></textarea>
                </div>
                
                <div class="form-row">
                    <button onclick="updateResource()" class="btn btn-success">Update Resource</button>
                    <button onclick="cancelResourceEdit()" class="btn btn-secondary">Cancel</button>
                </div>
                <div id="editResourceMessage"></div>
            </div>

            <!-- Add New Resource Section -->
            <div class="section-card">
                <h2>‚ûï Add New Resource</h2>
                
                <div class="form-group">
                    <label for="resourceIcon">Icon (emoji) *</label>
                    <input type="text" id="resourceIcon" maxlength="5" placeholder="e.g., üìñ" required>
                </div>
                
                <div class="form-group">
                    <label for="resourceTitle">Resource Title *</label>
                    <input type="text" id="resourceTitle" placeholder="e.g., Understanding Archaeological Sites" required>
                </div>
                
                <div class="form-group">
                    <label for="resourceContent">Content (Markdown) *</label>
                    <textarea id="resourceContent" placeholder="# Heading 1&#10;&#10;## Heading 2&#10;&#10;Your content here...&#10;&#10;**Bold text**&#10;*Italic text*&#10;&#10;- Bullet point 1&#10;- Bullet point 2" 
                              required style="min-height: 300px;"></textarea>
                    <small style="color: #7f8c8d; margin-top: 0.5rem; display: block;">Use Markdown formatting. Support for headers, bold, italic, lists, links, etc.</small>
                </div>
                
                <button onclick="submitResource()" class="btn btn-success" id="submitResourceBtn">
                    Add Resource
                </button>
                
                <div id="submitResourceMessage"></div>
            </div>
            
            </div>
            <!-- End Educational Resources Section -->
            
            <!-- Announcements Section -->
            <div id="announcementsSection" class="admin-section-content">
            
            <div class="section-card">
                <h2>üì¢ Edit Announcements</h2>
                <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Manage announcements displayed on different pages.</p>
                
                <div class="form-group">
                    <label for="mainAnnouncement">Home Page Announcement</label>
                    <textarea id="mainAnnouncementText" 
                              placeholder="Enter announcement text for Home page... Leave blank to remove announcement." 
                              style="min-height: 150px;"></textarea>
                    <small style="color: #7f8c8d; margin-top: 0.5rem; display: block;">This announcement will appear on the Home page. Leave empty to hide the announcement.</small>
                </div>
                
                <div class="form-group">
                    <label for="artifactHelpAnnouncement">Artifact Help Page Announcement</label>
                    <textarea id="artifactHelpAnnouncementText" 
                              placeholder="Enter announcement text for 'I Found an Artifact' page... Leave blank to remove announcement." 
                              style="min-height: 150px;"></textarea>
                    <small style="color: #7f8c8d; margin-top: 0.5rem; display: block;">This announcement will appear on the "I Found an Artifact" page. Leave empty to hide the announcement.</small>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="loadAnnouncement()" class="btn" style="background: #3498db; flex: 1;">
                        üîÑ Load Current
                    </button>
                    <button onclick="saveAnnouncement()" class="btn btn-success" style="flex: 1;">
                        üíæ Save Announcements
                    </button>
                </div>
                
                <div id="announcementMessage" style="margin-top: 1rem;"></div>
            </div>
            
            </div>
            <!-- End Announcements Section -->
            
            <!-- Credits Page Section -->
            <div id="creditsSection" class="admin-section-content">
            
            <div class="section-card">
                <h2>‚úçÔ∏è Edit Credits Page</h2>
                <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Edit the Credits & Attributions page content using Markdown formatting.</p>
                
                <div class="form-group">
                    <label for="creditsMarkdown">Credits Content (Markdown)</label>
                    <textarea id="creditsMarkdown" 
                              placeholder="# Credits & Attributions&#10;&#10;## Project Name&#10;Description here...&#10;&#10;**Bold text** *Italic text*" 
                              style="min-height: 400px; font-family: 'Courier New', monospace;"></textarea>
                    <small style="color: #7f8c8d; margin-top: 0.5rem; display: block;">Use Markdown formatting. Supports headers (#), bold (**), italic (*), lists, links, etc.</small>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="loadCredits()" class="btn" style="background: #3498db; flex: 1;">
                        üîÑ Load Current
                    </button>
                    <button onclick="saveCredits()" class="btn btn-success" style="flex: 1;">
                        üíæ Save Credits Page
                    </button>
                </div>
                
                <div id="creditsMessage" style="margin-top: 1rem;"></div>
            </div>
            
            </div>
            <!-- End Credits Page Section -->
            
            <!-- Parcel Viewers Section -->
            <div id="parcelViewersSection" class="admin-section-content">
            
            <div class="section-card">
                <h2>üó∫Ô∏è Manage Parcel Viewers</h2>
                <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Manage parcel viewer links organized by state and county.</p>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 2rem;">
                    <button onclick="loadParcelViewers()" class="btn" style="background: #3498db; flex: 1;">
                        üîÑ Load Parcel Viewers
                    </button>
                    <button onclick="saveParcelViewers()" class="btn btn-success" style="flex: 1;">
                        üíæ Save All Changes
                    </button>
                </div>
                
                <div id="parcelViewersMessage" style="margin-bottom: 1rem;"></div>
                
                <!-- Add New Entry Form -->
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h3 style="color: #2c3e50; margin-bottom: 1rem;">‚ûï Add New Parcel Viewer</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="newParcelState">State</label>
                            <input type="text" id="newParcelState" placeholder="e.g., Washington" />
                        </div>
                        <div class="form-group">
                            <label for="newParcelCounty">County</label>
                            <input type="text" id="newParcelCounty" placeholder="e.g., King County" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newParcelUrl">Parcel Viewer URL</label>
                        <input type="url" id="newParcelUrl" placeholder="https://example.com/parcel-viewer" />
                    </div>
                    <button onclick="addParcelViewer()" class="btn btn-success">
                        ‚ûï Add Parcel Viewer
                    </button>
                </div>
                
                <!-- Parcel Viewers List -->
                <div id="parcelViewersList" style="margin-top: 2rem;">
                    <p style="color: #7f8c8d; text-align: center; padding: 2rem;">Click "Load Parcel Viewers" to view existing entries</p>
                </div>
            </div>
            
            </div>
            <!-- End Parcel Viewers Section -->

            <!-- Artifact of the Day Section -->
            <div id="artifactOfDaySection" class="admin-section-content">
                <div class="section-card">
                    <h2>üè∫ Artifact of the Day Management</h2>
                    <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Manage the daily featured artifact displayed on the homepage.</p>
                    
                    <div class="warning-banner">
                        <strong>‚ÑπÔ∏è How it works:</strong>
                        The artifact of the day is automatically fetched from the Smithsonian API. You can manually set a specific artifact for any date, or clear an existing entry to allow automatic fetching.
                    </div>

                    <!-- Current Artifact Display -->
                    <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h3 style="color: #1976d2; margin-bottom: 1rem;">üìÖ Today's Artifact</h3>
                        <div id="currentArtifactDisplay">
                            <p style="color: #7f8c8d; text-align: center;">Loading...</p>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button onclick="loadTodaysArtifact()" class="btn btn-secondary" style="width: auto;">üîÑ Refresh</button>
                            <button onclick="clearTodaysArtifact()" class="btn btn-danger" style="width: auto;">üóëÔ∏è Clear Today's Artifact</button>
                        </div>
                    </div>

                    <!-- Set Artifact for Specific Date -->
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h3 style="color: #2c3e50; margin-bottom: 1rem;">üìÜ Set Artifact for Specific Date</h3>
                        
                        <div class="form-group">
                            <label for="artifactDate">Date</label>
                            <input type="date" id="artifactDate" />
                        </div>

                        <div class="form-group">
                            <label for="artifactTitle">Artifact Title</label>
                            <input type="text" id="artifactTitle" placeholder="Enter artifact title" />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="artifactCulture">Culture</label>
                                <input type="text" id="artifactCulture" placeholder="e.g., Ancestral Puebloan, Native Americans" />
                            </div>
                            <div class="form-group">
                                <label for="artifactPeriod">Date/Period</label>
                                <input type="text" id="artifactPeriod" placeholder="e.g., 900-1150 CE" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="artifactPlace">Place/Location</label>
                                <input type="text" id="artifactPlace" placeholder="e.g., USA, New Mexico" />
                            </div>
                            <div class="form-group">
                                <label for="artifactUnitCode">Collection/Unit Code</label>
                                <input type="text" id="artifactUnitCode" placeholder="e.g., NMAI" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="artifactDescription">Description</label>
                            <textarea id="artifactDescription" placeholder="Enter artifact description" rows="4"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="artifactImageUrl">Image URL</label>
                            <input type="url" id="artifactImageUrl" placeholder="https://ids.si.edu/ids/deliveryService?id=..." />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="artifactRecordLink">Record Link (ark URL)</label>
                                <input type="url" id="artifactRecordLink" placeholder="http://n2t.net/ark:/65665/..." />
                            </div>
                            <div class="form-group">
                                <label for="artifactUrl">EDAN ID/URL</label>
                                <input type="text" id="artifactUrl" placeholder="edanmdm:NMAI_..." />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="artifactId">Artifact ID (optional)</label>
                            <input type="text" id="artifactId" placeholder="Auto-generated if left empty" />
                        </div>

                        <div id="artifactMessage" style="margin: 1rem 0;"></div>

                        <div style="display: flex; gap: 1rem;">
                            <button onclick="setArtifactForDate()" class="btn btn-success" style="width: auto;">üíæ Save Artifact</button>
                            <button onclick="clearArtifactForm()" class="btn btn-secondary" style="width: auto;">üîÑ Clear Form</button>
                        </div>
                    </div>

                    <!-- View Artifacts by Date -->
                    <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 12px; padding: 1.5rem;">
                        <h3 style="color: #e65100; margin-bottom: 1rem;">üîç View Artifact by Date</h3>
                        
                        <div style="display: flex; gap: 1rem; align-items: end;">
                            <div class="form-group" style="flex: 1; margin: 0;">
                                <label for="viewArtifactDate">Select Date</label>
                                <input type="date" id="viewArtifactDate" />
                            </div>
                            <button onclick="viewArtifactByDate()" class="btn" style="width: auto; height: fit-content;">üîç View</button>
                        </div>

                        <div id="viewArtifactDisplay" style="margin-top: 1.5rem;">
                            <p style="color: #7f8c8d; text-align: center;">Select a date to view its artifact</p>
                        </div>

                        <div id="viewArtifactActions" style="margin-top: 1rem; display: none; gap: 1rem;">
                            <button onclick="editViewedArtifact()" class="btn btn-secondary" style="width: auto;">‚úèÔ∏è Edit This Artifact</button>
                            <button onclick="clearViewedArtifact()" class="btn btn-danger" style="width: auto;">üóëÔ∏è Clear This Artifact</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Artifact of the Day Section -->
            
                </div><!-- End admin-content-wrapper -->
            </div><!-- End admin-panel-wrapper -->

        </div>
    </section>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { initializeAppCheck, ReCaptchaEnterpriseProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCYpXOczp5nRRP1S2Gdb1ADjIAHeJQVq0",
            authDomain: "owlcheologists.firebaseapp.com",
            projectId: "owlcheologists",
            storageBucket: "owlcheologists.firebasestorage.app",
            messagingSenderId: "323297596743",
            appId: "1:323297596743:web:c9455e40779b7c09522862",
            measurementId: "G-2CFYWTQCQ4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Initialize App Check with reCAPTCHA Enterprise
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaEnterpriseProvider('6LfiAjYsAAAAABjnkEQXCk7t9qBN0Ut8V9R-8tyX'),
            isTokenAutoRefreshEnabled: true
        });

        let currentUser = null;
        let isAuthenticated = false;

        // US States array
        const usStates = [
            'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut',
            'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa',
            'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan',
            'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire',
            'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio',
            'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota',
            'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington', 'West Virginia',
            'Wisconsin', 'Wyoming'
        ];

        // Check auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAuthenticated = true;
                console.log('User logged in:', user.email);
                showAdminPanel(user);
            } else {
                currentUser = null;
                isAuthenticated = false;
                console.log('User logged out');
                showLoginSection();
            }
        });

        // Show login section
        function showLoginSection() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        // Show admin panel
        function showAdminPanel(user) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            
            // Populate state dropdowns
            populateStateDropdowns();
            
            // Add one contact field by default
            if (document.getElementById('contactsList').children.length === 0) {
                addContactField();
            }
            
            // Setup event listeners for artifact section
            setupArtifactEventListeners();
        }
        
        // Setup artifact section event listeners
        function setupArtifactEventListeners() {
            // Auto-uppercase state abbreviations
            const stateInputs = [
                document.getElementById('instructionState'),
                document.getElementById('editInstructionState')
            ];
            stateInputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', function() {
                        this.value = this.value.toUpperCase();
                    });
                }
            });
            
            // Keyword preview for add form
            const keywordsInput = document.getElementById('instructionKeywords');
            if (keywordsInput) {
                keywordsInput.addEventListener('input', function() {
                    const keywords = this.value.split(',').map(k => k.trim()).filter(k => k);
                    const preview = document.getElementById('keywordPreview');
                    if (preview) {
                        preview.innerHTML = keywords.map(keyword => 
                            `<span style="background: #3498db; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">${keyword}</span>`
                        ).join('');
                    }
                });
            }
            
            // Keyword preview for edit form
            const editKeywordsInput = document.getElementById('editInstructionKeywords');
            if (editKeywordsInput) {
                editKeywordsInput.addEventListener('input', function() {
                    const keywords = this.value.split(',').map(k => k.trim()).filter(k => k);
                    const preview = document.getElementById('editKeywordPreview');
                    if (preview) {
                        preview.innerHTML = keywords.map(keyword => 
                            `<span style="background: #3498db; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">${keyword}</span>`
                        ).join('');
                    }
                });
            }
        }

        // Login functionality
        document.getElementById('loginBtn').addEventListener('click', async function() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const messageDiv = document.getElementById('loginMessage');

            if (!email || !password) {
                messageDiv.innerHTML = '<div class="error-message">Please enter both email and password</div>';
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Login successful:', userCredential.user.email);
                messageDiv.innerHTML = '<div class="success-message">‚úì Login successful!</div>';
            } catch (error) {
                console.error('Login error:', error);
                messageDiv.innerHTML = `<div class="error-message">Login failed: ${error.message}</div>`;
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await signOut(auth);
                console.log('Logout successful');
            } catch (error) {
                console.error('Logout error:', error);
                alert(`Logout failed: ${error.message}`);
            }
        });

        // Populate state dropdowns
        function populateStateDropdowns() {
            const lawStateSelect = document.getElementById('lawState');
            const editLawStateSelect = document.getElementById('editLawState');
            
            [lawStateSelect, editLawStateSelect].forEach(select => {
                if (select && select.options.length <= 1) {
                    select.innerHTML = '<option value="">Select State...</option>';
                    usStates.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = state;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Handle law type change (Add form)
        document.getElementById('lawType').addEventListener('change', function() {
            const jurisdictionFields = document.getElementById('jurisdictionFields');
            const countyField = document.getElementById('countyField');
            
            if (this.value === 'state' || this.value === 'county') {
                jurisdictionFields.style.display = 'block';
                if (this.value === 'county') {
                    countyField.style.display = 'block';
                } else {
                    countyField.style.display = 'none';
                }
            } else {
                jurisdictionFields.style.display = 'none';
            }
        });

        // Handle law type change (Edit form)
        document.getElementById('editLawType').addEventListener('change', function() {
            const editJurisdictionFields = document.getElementById('editJurisdictionFields');
            const editCountyField = document.getElementById('editCountyField');
            
            if (this.value === 'state' || this.value === 'county') {
                editJurisdictionFields.style.display = 'block';
                if (this.value === 'county') {
                    editCountyField.style.display = 'block';
                } else {
                    editCountyField.style.display = 'none';
                }
            } else {
                editJurisdictionFields.style.display = 'none';
            }
        });

        // Search laws
        window.searchLaws = async function() {
            if (!isAuthenticated) {
                alert('You must be logged in to search laws');
                return;
            }

            const searchInput = document.getElementById('lawSearchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('lawSearchResults');

            if (!searchInput) {
                resultsDiv.innerHTML = '<p style="color: #7f8c8d;">Enter a search term to find laws</p>';
                return;
            }

            resultsDiv.innerHTML = '<p style="color: #7f8c8d;">Searching...</p>';

            try {
                const lawsRef = collection(db, 'archaeologyLaws');
                const snapshot = await getDocs(lawsRef);
                const laws = [];

                snapshot.forEach(doc => {
                    const law = { id: doc.id, ...doc.data() };
                    const searchStr = `${law.title} ${law.year} ${(law.tags || []).join(' ')} ${law.summary || ''}`.toLowerCase();
                    if (searchStr.includes(searchInput)) {
                        laws.push(law);
                    }
                });

                if (laws.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: #7f8c8d;">No laws found matching your search</p>';
                } else {
                    resultsDiv.innerHTML = laws.map(law => `
                        <div class="search-result">
                            <h4>${law.icon || '‚öñÔ∏è'} ${law.title}</h4>
                            <p>Year: ${law.year} | Type: ${law.type || 'federal'} | ID: ${law.id}</p>
                            <div class="actions">
                                <button class="edit-btn" onclick="editLaw('${law.id}')">‚úèÔ∏è Edit</button>
                                <button class="delete-btn" onclick="deleteLaw('${law.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error searching laws:', error);
                resultsDiv.innerHTML = '<div class="error-message">Error searching laws. Please try again.</div>';
            }
        };

        // Edit law
        window.editLaw = async function(lawId) {
            if (!isAuthenticated) {
                alert('You must be logged in to edit laws');
                return;
            }

            try {
                const lawRef = doc(db, 'archaeologyLaws', lawId);
                const lawSnap = await getDoc(lawRef);

                if (!lawSnap.exists()) {
                    alert('Law not found');
                    return;
                }

                const law = lawSnap.data();

                document.getElementById('editLawId').value = lawId;
                document.getElementById('editLawType').value = law.type || 'federal';
                document.getElementById('editLawTitle').value = law.title || '';
                document.getElementById('editLawYear').value = law.year || '';
                document.getElementById('editLawIcon').value = law.icon || '';
                document.getElementById('editLawSummary').value = law.summary || '';
                document.getElementById('editLawSignificance').value = law.significance || '';
                document.getElementById('editLawEnforcement').value = law.enforcement || '';
                document.getElementById('editLawFullText').value = law.fullText || '';
                document.getElementById('editLawTags').value = (law.tags || []).join(', ');
                document.getElementById('editLawNotes').value = law.notes || '';

                const editJurisdictionFields = document.getElementById('editJurisdictionFields');
                const editCountyField = document.getElementById('editCountyField');

                if (law.type === 'state' || law.type === 'county') {
                    editJurisdictionFields.style.display = 'block';
                    document.getElementById('editLawState').value = law.state || '';

                    if (law.type === 'county') {
                        editCountyField.style.display = 'block';
                        document.getElementById('editLawCounty').value = law.county || '';
                    } else {
                        editCountyField.style.display = 'none';
                    }
                } else {
                    editJurisdictionFields.style.display = 'none';
                }

                document.getElementById('editLawSection').style.display = 'block';
                document.getElementById('editLawSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading law for edit:', error);
                alert('Error loading law data. Please try again.');
            }
        };

        // Update law
        window.updateLaw = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to update laws');
                return;
            }

            const messageDiv = document.getElementById('editMessage');
            const lawId = document.getElementById('editLawId').value;

            if (!lawId) {
                messageDiv.innerHTML = '<div class="error-message">No law selected for editing</div>';
                return;
            }

            try {
                const lawType = document.getElementById('editLawType').value;
                const title = document.getElementById('editLawTitle').value.trim();
                const year = document.getElementById('editLawYear').value.trim();
                const icon = document.getElementById('editLawIcon').value.trim() || '‚öñÔ∏è';
                const summary = document.getElementById('editLawSummary').value.trim();
                const significance = document.getElementById('editLawSignificance').value.trim();
                const enforcement = document.getElementById('editLawEnforcement').value.trim();
                const fullText = document.getElementById('editLawFullText').value.trim();
                const tagsInput = document.getElementById('editLawTags').value.trim();
                const notes = document.getElementById('editLawNotes').value.trim();

                if (!title || !year || !summary || !significance || !enforcement || !fullText) {
                    messageDiv.innerHTML = '<div class="error-message">Please fill in all required fields (*)</div>';
                    return;
                }

                let state = '';
                let county = '';
                if (lawType === 'state' || lawType === 'county') {
                    state = document.getElementById('editLawState').value;
                    if (!state) {
                        messageDiv.innerHTML = '<div class="error-message">Please select a state</div>';
                        return;
                    }
                    if (lawType === 'county') {
                        county = document.getElementById('editLawCounty').value.trim();
                    }
                }

                const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);

                const lawData = {
                    title: title,
                    year: year,
                    icon: icon,
                    summary: summary,
                    significance: significance,
                    enforcement: enforcement,
                    fullText: fullText,
                    tags: tags,
                    type: lawType,
                    lastModified: new Date().toISOString()
                };

                if (state) lawData.state = state;
                if (county) lawData.county = county;
                if (notes) lawData.notes = notes;

                await setDoc(doc(db, 'archaeologyLaws', lawId), lawData, { merge: true });

                messageDiv.innerHTML = '<div class="success-message">‚úì Law updated successfully!</div>';

                setTimeout(() => {
                    cancelEdit();
                    searchLaws();
                }, 1500);

            } catch (error) {
                console.error('Error updating law:', error);
                messageDiv.innerHTML = '<div class="error-message">Error updating law. Please try again.</div>';
            }
        };

        // Delete law
        window.deleteLaw = async function(lawId) {
            if (!isAuthenticated) {
                alert('You must be authenticated to delete laws');
                return;
            }

            if (!confirm('Are you sure you want to delete this law? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'archaeologyLaws', lawId));
                alert('Law deleted successfully!');
                searchLaws();
            } catch (error) {
                console.error('Error deleting law:', error);
                alert('Error deleting law. Please try again.');
            }
        };

        // Cancel edit
        window.cancelEdit = function() {
            document.getElementById('editLawSection').style.display = 'none';
            document.getElementById('editMessage').innerHTML = '';
        };

        // Submit new law
        window.submitLaw = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to add laws');
                return;
            }

            const messageDiv = document.getElementById('submitMessage');
            const submitBtn = document.getElementById('submitBtn');

            try {
                const lawType = document.getElementById('lawType').value;
                const title = document.getElementById('lawTitle').value.trim();
                const year = document.getElementById('lawYear').value.trim();
                const icon = document.getElementById('lawIcon').value.trim() || '‚öñÔ∏è';
                const summary = document.getElementById('lawSummary').value.trim();
                const significance = document.getElementById('lawSignificance').value.trim();
                const enforcement = document.getElementById('lawEnforcement').value.trim();
                const fullText = document.getElementById('lawFullText').value.trim();
                const tagsInput = document.getElementById('lawTags').value.trim();
                const notes = document.getElementById('lawNotes').value.trim();

                if (!title || !year || !summary || !significance || !enforcement || !fullText) {
                    messageDiv.innerHTML = '<div class="error-message">Please fill in all required fields (*)</div>';
                    return;
                }

                let state = '';
                let county = '';
                if (lawType === 'state' || lawType === 'county') {
                    state = document.getElementById('lawState').value;
                    if (!state) {
                        messageDiv.innerHTML = '<div class="error-message">Please select a state</div>';
                        return;
                    }
                    if (lawType === 'county') {
                        county = document.getElementById('lawCounty').value.trim();
                    }
                }

                const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
                const lawId = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

                const lawData = {
                    title: title,
                    year: year,
                    icon: icon,
                    summary: summary,
                    significance: significance,
                    enforcement: enforcement,
                    fullText: fullText,
                    tags: tags,
                    type: lawType,
                    createdAt: new Date().toISOString()
                };

                if (state) lawData.state = state;
                if (county) lawData.county = county;
                if (notes) lawData.notes = notes;

                submitBtn.disabled = true;
                submitBtn.textContent = 'Adding Law...';

                await setDoc(doc(db, 'archaeologyLaws', lawId), lawData);

                messageDiv.innerHTML = '<div class="success-message">‚úì Law added successfully!</div>';

                // Clear form
                document.getElementById('lawTitle').value = '';
                document.getElementById('lawYear').value = '';
                document.getElementById('lawIcon').value = '';
                document.getElementById('lawSummary').value = '';
                document.getElementById('lawSignificance').value = '';
                document.getElementById('lawEnforcement').value = '';
                document.getElementById('lawFullText').value = '';
                document.getElementById('lawTags').value = '';
                document.getElementById('lawNotes').value = '';
                document.getElementById('lawType').value = 'federal';
                document.getElementById('jurisdictionFields').style.display = 'none';

                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Law to Database';

                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error adding law:', error);
                messageDiv.innerHTML = '<div class="error-message">Error adding law. Please try again.</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Law to Database';
            }
        };

        // ============== ARTIFACT INSTRUCTIONS FUNCTIONS ==============
        
        // Contact management
        let contactCounter = 0;
        let editContactCounter = 0;
        
        window.addContactField = function() {
            contactCounter++;
            const contactsList = document.getElementById('contactsList');
            
            const contactItem = document.createElement('div');
            contactItem.className = 'contact-item';
            contactItem.dataset.contactId = contactCounter;
            
            contactItem.innerHTML = `
                <div class="contact-item-header">
                    <h5>Contact ${contactCounter}</h5>
                    <button type="button" class="remove-contact-btn" onclick="removeContact(${contactCounter})">
                        üóëÔ∏è Remove
                    </button>
                </div>
                <div class="contact-fields">
                    <div class="form-group">
                        <label>Contact Name *</label>
                        <input type="text" class="contact-name" placeholder="e.g., John Smith" required>
                    </div>
                    <div class="form-group">
                        <label>Role/Title</label>
                        <input type="text" class="contact-role" placeholder="e.g., County Archaeologist">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="contact-email" placeholder="e.g., contact@example.com">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" class="contact-phone" placeholder="e.g., (555) 123-4567">
                    </div>
                    <div class="form-group full-width">
                        <label>Physical Address</label>
                        <input type="text" class="contact-address" placeholder="e.g., 123 Main St, City, State ZIP">
                    </div>
                    <div class="form-group full-width">
                        <label>Special Instructions</label>
                        <textarea class="contact-instructions" placeholder="e.g., Call between 9 AM - 5 PM" rows="2"></textarea>
                    </div>
                </div>
            `;
            
            contactsList.appendChild(contactItem);
        };
        
        window.addEditContactField = function(contactData = null) {
            editContactCounter++;
            const contactsList = document.getElementById('editContactsList');
            
            const contactItem = document.createElement('div');
            contactItem.className = 'contact-item';
            contactItem.dataset.contactId = editContactCounter;
            
            contactItem.innerHTML = `
                <div class="contact-item-header">
                    <h5>Contact ${editContactCounter}</h5>
                    <button type="button" class="remove-contact-btn" onclick="removeEditContact(${editContactCounter})">
                        üóëÔ∏è Remove
                    </button>
                </div>
                <div class="contact-fields">
                    <div class="form-group">
                        <label>Contact Name *</label>
                        <input type="text" class="contact-name" placeholder="e.g., John Smith" value="${contactData?.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Role/Title</label>
                        <input type="text" class="contact-role" placeholder="e.g., County Archaeologist" value="${contactData?.role || ''}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="contact-email" placeholder="e.g., contact@example.com" value="${contactData?.email || ''}">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" class="contact-phone" placeholder="e.g., (555) 123-4567" value="${contactData?.phone || ''}">
                    </div>
                    <div class="form-group full-width">
                        <label>Physical Address</label>
                        <input type="text" class="contact-address" placeholder="e.g., 123 Main St, City, State ZIP" value="${contactData?.address || ''}">
                    </div>
                    <div class="form-group full-width">
                        <label>Special Instructions</label>
                        <textarea class="contact-instructions" placeholder="e.g., Call between 9 AM - 5 PM" rows="2">${contactData?.specialInstructions || ''}</textarea>
                    </div>
                </div>
            `;
            
            contactsList.appendChild(contactItem);
        };
        
        window.removeContact = function(contactId) {
            const contactItem = document.querySelector(`#contactsList [data-contact-id="${contactId}"]`);
            if (contactItem) {
                contactItem.remove();
            }
        };
        
        window.removeEditContact = function(contactId) {
            const contactItem = document.querySelector(`#editContactsList [data-contact-id="${contactId}"]`);
            if (contactItem) {
                contactItem.remove();
            }
        };
        
        function getContactsData() {
            const contacts = [];
            const contactItems = document.querySelectorAll('#contactsList .contact-item');
            
            contactItems.forEach((item) => {
                const name = item.querySelector('.contact-name').value.trim();
                const role = item.querySelector('.contact-role').value.trim();
                const email = item.querySelector('.contact-email').value.trim();
                const phone = item.querySelector('.contact-phone').value.trim();
                const address = item.querySelector('.contact-address').value.trim();
                const instructions = item.querySelector('.contact-instructions').value.trim();
                
                if (name) {
                    contacts.push({
                        name: name,
                        role: role || '',
                        email: email || '',
                        phone: phone || '',
                        address: address || '',
                        specialInstructions: instructions || ''
                    });
                }
            });
            
            return contacts;
        }
        
        function getEditContactsData() {
            const contacts = [];
            const contactItems = document.querySelectorAll('#editContactsList .contact-item');
            
            contactItems.forEach((item) => {
                const name = item.querySelector('.contact-name').value.trim();
                const role = item.querySelector('.contact-role').value.trim();
                const email = item.querySelector('.contact-email').value.trim();
                const phone = item.querySelector('.contact-phone').value.trim();
                const address = item.querySelector('.contact-address').value.trim();
                const instructions = item.querySelector('.contact-instructions').value.trim();
                
                if (name) {
                    contacts.push({
                        name: name,
                        role: role || '',
                        email: email || '',
                        phone: phone || '',
                        address: address || '',
                        specialInstructions: instructions || ''
                    });
                }
            });
            
            return contacts;
        }
        
        // Generate HTML from contacts
        function generateHTMLFromContacts(contacts, selectedLaws, probability, specialInstructions, generalNotes) {
            let html = '<div class="emergency-note">\n';
            html += '    <strong>‚ö†Ô∏è STOP! Do not disturb the artifact or the surrounding area.</strong>\n';
            html += '</div>\n\n';
            
            if (specialInstructions) {
                html += '<div class="contact-card" style="background: #fff3cd; border-color: #ffeaa7;">\n';
                html += '    <h4>‚ö†Ô∏è Special Instructions</h4>\n';
                html += `    <div class="contact-info"><p>${specialInstructions.replace(/\n/g, '<br>')}</p></div>\n`;
                html += '</div>\n\n';
            }
            
            contacts.forEach((contact, index) => {
                html += '<div class="contact-card">\n';
                html += `    <h4>üìû Contact ${index + 1}: ${contact.name}</h4>\n`;
                html += '    <div class="contact-info">\n';
                
                if (contact.role) {
                    html += `        <p><strong>Role:</strong> ${contact.role}</p>\n`;
                }
                if (contact.email) {
                    html += `        <p><strong>Email:</strong> <a href="mailto:${contact.email}">${contact.email}</a></p>\n`;
                }
                if (contact.phone) {
                    html += `        <p><strong>Phone:</strong> <a href="tel:${contact.phone}">${contact.phone}</a></p>\n`;
                }
                if (contact.address) {
                    html += `        <p><strong>Address:</strong> ${contact.address}</p>\n`;
                }
                if (contact.specialInstructions) {
                    html += `        <p><strong>Instructions:</strong> ${contact.specialInstructions}</p>\n`;
                }
                
                html += '    </div>\n';
                html += '</div>\n\n';
            });
            
            // Add artifact likelihood indicator if provided
            if (probability && probability.trim()) {
                const levels = {
                    low: { emoji: 'üü¢', label: 'Low', desc: 'Few known archaeological findings in this area', bg: '#d4edda', border: '#c3e6cb' },
                    moderate: { emoji: 'üü°', label: 'Moderate', desc: 'Some historical or archaeological activity nearby', bg: '#fff3cd', border: '#ffeaa7' },
                    elevated: { emoji: 'üü†', label: 'Elevated', desc: 'Area with documented archaeological sensitivity', bg: '#ffe5cc', border: '#ffcc99' },
                    high: { emoji: 'üî¥', label: 'High', desc: 'Area known for significant archaeological presence', bg: '#f8d7da', border: '#f5c6cb' }
                };
                
                const level = levels[probability.toLowerCase()];
                if (level) {
                    html += `<div class="contact-card" style="background: ${level.bg}; border-color: ${level.border}; border-width: 2px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">\n`;
                    html += '    <h4 style="margin-bottom: 1rem; font-size: 1.1rem;">Artifact Likelihood Indicator</h4>\n';
                    html += `    <div style="text-align: center; padding: 1rem 0; border-bottom: 2px solid ${level.border}; margin-bottom: 1rem;">\n`;
                    html += `        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${level.emoji}</div>\n`;
                    html += `        <div style="font-size: 1.3rem; font-weight: 700; color: #2c3e50;">${level.label}</div>\n`;
                    html += '    </div>\n';
                    html += `    <p style="color: #2c3e50; line-height: 1.6; margin-bottom: 1rem;">${level.desc}</p>\n`;
                    html += '    <p style="color: #2c3e50; line-height: 1.6; margin-bottom: 1rem;">Please follow guidance below and contact authorities before taking action.</p>\n';
                    html += '    <p style="color: #666; font-size: 0.9rem; font-style: italic; margin-bottom: 1rem;">‚ÑπÔ∏è <strong>This is an educational estimate, not a confirmation.</strong></p>\n';
                    html += '    <details style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.5); border-radius: 8px;">\n';
                    html += '        <summary style="cursor: pointer; font-weight: 600; color: #2c3e50; user-select: none;">‚ÑπÔ∏è How is this calculated?</summary>\n';
                    html += '        <div style="margin-top: 1rem; color: #555; line-height: 1.6; font-size: 0.95rem;">\n';
                    html += '            <p style="margin-bottom: 0.5rem;"><strong>How this estimate works:</strong></p>\n';
                    html += '            <p style="margin-bottom: 0.5rem;">This indicator is based on publicly available historical and archaeological records, land use history, and proximity to documented sites.</p>\n';
                    html += '            <p style="margin: 0;"><strong>It does not confirm whether an item is an artifact.</strong></p>\n';
                    html += '        </div>\n';
                    html += '    </details>\n';
                    html += '</div>\n\n';
                }
            }
            
            html += '<h4>Immediate Steps to Take:</h4>\n';
            html += '<ol style="margin: 1rem 0; padding-left: 2rem; line-height: 1.8;">\n';
            html += '    <li><strong>Stop all work</strong> in the immediate area</li>\n';
            html += '    <li><strong>Do not touch or move</strong> the artifact</li>\n';
            html += '    <li><strong>Contact the above authority</strong> immediately</li>\n';
            html += '    <li><strong>Mark the location</strong> with flags or cones if available</li>\n';
            html += '    <li><strong>Take photos</strong> of the artifact in place (do not disturb)</li>\n';
            html += '    <li><strong>Record GPS coordinates</strong> of the exact location</li>\n';
            html += '    <li><strong>Secure the area</strong> to prevent disturbance by others</li>\n';
            html += '    <li><strong>Document everything</strong> - date, time, weather, surrounding features</li>\n';
            html += '</ol>\n';
            
            if (generalNotes) {
                html += '\n<div class="contact-card" style="background: #e3f2fd; border-color: #90caf9;">\n';
                html += '    <h4>üìã Additional Information</h4>\n';
                html += `    <div class="contact-info">\n`;
                html += `        <p>${generalNotes.replace(/\n/g, '<br>')}</p>\n`;
                html += '    </div>\n';
                html += '</div>\n';
            }
            
            return html;
        }
        
        // Law selection functions
        window.loadAvailableLaws = async function(containerId, previewId) {
            const container = document.getElementById(containerId);
            const preview = document.getElementById(previewId);
            
            if (!container) {
                console.error('Laws container not found:', containerId);
                return;
            }
            
            try {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Loading laws...</p>';
                container.style.display = 'block';
                
                const lawsRef = collection(db, 'archaeologyLaws');
                const lawsSnapshot = await getDocs(lawsRef);
                
                if (lawsSnapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No laws found in database</p>';
                    return;
                }
                
                const laws = [];
                lawsSnapshot.forEach((doc) => {
                    laws.push({ id: doc.id, ...doc.data() });
                });
                
                laws.sort((a, b) => {
                    const typeOrder = { federal: 1, state: 2, county: 3, local: 4 };
                    const aType = typeOrder[a.type] || 99;
                    const bType = typeOrder[b.type] || 99;
                    if (aType !== bType) return aType - bType;
                    return (a.state || '').localeCompare(b.state || '');
                });
                
                // Get currently selected laws - check tempSelectedLaws first (for editing)
                const currentlySelected = window.tempSelectedLaws || getSelectedLawIds(containerId);
                
                let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                laws.forEach((law) => {
                    const title = law.title || law.name || 'Untitled Law';
                    const type = law.type || 'unknown';
                    const state = law.state ? ` - ${law.state}` : '';
                    const county = law.county ? ` (${law.county} County)` : '';
                    const isChecked = currentlySelected.includes(law.id) ? 'checked' : '';
                    
                    html += `
                        <label style="display: flex; align-items: start; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e0e0e0; cursor: pointer; transition: all 0.2s ease;">
                            <input type="checkbox" 
                                   value="${law.id}" 
                                   ${isChecked}
                                   onchange="updateLawSelection('${containerId}', '${previewId}')"
                                   style="margin-top: 0.25rem; cursor: pointer;">
                            <span style="flex: 1;">
                                <span class="law-type ${type}" style="display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem;">${type.toUpperCase()}</span>
                                <strong>${title}</strong>${state}${county}
                            </span>
                        </label>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                updateLawSelection(containerId, previewId);
                
            } catch (error) {
                console.error('Error loading laws:', error);
                container.innerHTML = `<p style="text-align: center; color: #e74c3c;">Error loading laws: ${error.message}</p>`;
            }
        };
        
        window.updateLawSelection = function(containerId, previewId) {
            const container = document.getElementById(containerId);
            const preview = document.getElementById(previewId);
            
            if (!container || !preview) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            const count = checkboxes.length;
            
            if (count === 0) {
                preview.innerHTML = '<p style="color: #7f8c8d; font-size: 0.9rem;"><em>No laws selected - the laws section will be hidden for this instruction</em></p>';
            } else {
                preview.innerHTML = `<p style="color: #27ae60; font-weight: 600; font-size: 0.9rem;">‚úì ${count} law${count === 1 ? '' : 's'} selected</p>`;
            }
        };
        
        function getSelectedLawIds(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        // Search instructions
        window.searchInstructions = async function() {
            if (!isAuthenticated) {
                alert('You must be logged in to search instructions');
                return;
            }

            const searchInput = document.getElementById('instructionSearchInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('instructionSearchResults');

            if (!searchInput) {
                resultsDiv.innerHTML = '<p style="color: #7f8c8d;">Enter a search term to find instructions</p>';
                return;
            }

            resultsDiv.innerHTML = '<p style="color: #7f8c8d;">Searching...</p>';

            try {
                const instructionsRef = collection(db, 'artifactInstructions');
                const snapshot = await getDocs(instructionsRef);
                const instructions = [];

                snapshot.forEach(doc => {
                    const instruction = { id: doc.id, ...doc.data() };
                    const searchStr = `${instruction.state || ''} ${instruction.city || ''} ${instruction.owner || ''} ${instruction.jurisdiction || ''} ${(instruction.keywords || []).join(' ')}`.toLowerCase();
                    if (searchStr.includes(searchInput)) {
                        instructions.push(instruction);
                    }
                });

                if (instructions.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: #7f8c8d;">No instructions found matching your search</p>';
                } else {
                    resultsDiv.innerHTML = instructions.map(instruction => {
                        const location = [instruction.city, instruction.state].filter(x => x).join(', ') || 'N/A';
                        const owner = instruction.owner || 'N/A';
                        const keywords = (instruction.keywords || []).join(', ') || 'N/A';
                        
                        return `
                        <div class="search-result">
                            <h4>üè∫ ${location}</h4>
                            <p><strong>Owner:</strong> ${owner}</p>
                            <p><strong>Keywords:</strong> ${keywords}</p>
                            <p><strong>ID:</strong> ${instruction.id}</p>
                            <div class="actions">
                                <button class="edit-btn" onclick="editInstruction('${instruction.id}')">‚úèÔ∏è Edit</button>
                                <button class="delete-btn" onclick="deleteInstruction('${instruction.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (error) {
                console.error('Error searching instructions:', error);
                resultsDiv.innerHTML = '<div class="error-message">Error searching instructions. Please try again.</div>';
            }
        };

        // Edit instruction
        window.editInstruction = async function(instructionId) {
            if (!isAuthenticated) {
                alert('You must be logged in to edit instructions');
                return;
            }

            try {
                const instructionRef = doc(db, 'artifactInstructions', instructionId);
                const instructionSnap = await getDoc(instructionRef);

                if (!instructionSnap.exists()) {
                    alert('Instruction not found');
                    return;
                }

                const instruction = instructionSnap.data();

                document.getElementById('editInstructionId').value = instructionId;
                document.getElementById('editInstructionState').value = instruction.state || '';
                document.getElementById('editInstructionCity').value = instruction.city || '';
                document.getElementById('editInstructionJurisdiction').value = instruction.jurisdiction || '';
                document.getElementById('editInstructionOwner').value = instruction.owner || '';
                document.getElementById('editInstructionKeywords').value = (instruction.keywords || []).join(', ');
                document.getElementById('editInstructionProbability').value = instruction.probability || '';
                document.getElementById('editInstructionSpecial').value = instruction.specialInstructions || '';
                document.getElementById('editInstructionGeneral').value = instruction.generalNotes || '';

                // Load contacts
                const editContactsList = document.getElementById('editContactsList');
                editContactsList.innerHTML = '';
                editContactCounter = 0;
                if (instruction.contacts && instruction.contacts.length > 0) {
                    instruction.contacts.forEach(contact => {
                        addEditContactField(contact);
                    });
                } else {
                    addEditContactField();
                }
                
                // Store selected laws temporarily
                window.tempSelectedLaws = instruction.selectedLaws || [];
                
                // Load laws if they exist
                if (instruction.selectedLaws && instruction.selectedLaws.length > 0) {
                    await loadAvailableLaws('editLawsSelection', 'editSelectedLawsPreview');
                }

                document.getElementById('editInstructionSection').style.display = 'block';
                document.getElementById('editInstructionSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading instruction for edit:', error);
                alert('Error loading instruction data. Please try again.');
            }
        };

        // Update instruction
        window.updateInstruction = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to update instructions');
                return;
            }

            const messageDiv = document.getElementById('editInstructionMessage');
            const instructionId = document.getElementById('editInstructionId').value;

            if (!instructionId) {
                messageDiv.innerHTML = '<div class="error-message">No instruction selected for editing</div>';
                return;
            }

            try {
                const state = document.getElementById('editInstructionState').value.trim().toUpperCase();
                const city = document.getElementById('editInstructionCity').value.trim();
                const jurisdiction = document.getElementById('editInstructionJurisdiction').value.trim();
                const owner = document.getElementById('editInstructionOwner').value.trim();
                const keywordsInput = document.getElementById('editInstructionKeywords').value.trim();
                const probability = document.getElementById('editInstructionProbability').value.trim();
                const specialInstructions = document.getElementById('editInstructionSpecial').value.trim();
                const generalNotes = document.getElementById('editInstructionGeneral').value.trim();

                const contacts = getEditContactsData();
                if (contacts.length === 0) {
                    messageDiv.innerHTML = '<div class="error-message">Please add at least one contact</div>';
                    return;
                }

                const keywords = keywordsInput.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
                const selectedLaws = getSelectedLawIds('editLawsSelection');
                const htmlContent = generateHTMLFromContacts(contacts, selectedLaws, probability, specialInstructions, generalNotes);

                const instructionData = {
                    htmlContent: htmlContent,
                    keywords: keywords,
                    contacts: contacts,
                    probability: probability,
                    specialInstructions: specialInstructions,
                    generalNotes: generalNotes,
                    selectedLaws: selectedLaws,
                    lastModified: new Date().toISOString(),
                    lastModifiedBy: currentUser.email
                };

                if (state) instructionData.state = state;
                if (city) instructionData.city = city;
                if (jurisdiction) instructionData.jurisdiction = jurisdiction;
                if (owner) instructionData.owner = owner;

                await setDoc(doc(db, 'artifactInstructions', instructionId), instructionData, { merge: true });

                messageDiv.innerHTML = '<div class="success-message">‚úì Instruction updated successfully!</div>';

                setTimeout(() => {
                    cancelEditInstruction();
                    searchInstructions();
                }, 1500);

            } catch (error) {
                console.error('Error updating instruction:', error);
                messageDiv.innerHTML = '<div class="error-message">Error updating instruction. Please try again.</div>';
            }
        };

        // Delete instruction
        window.deleteInstruction = async function(instructionId) {
            if (!isAuthenticated) {
                alert('You must be authenticated to delete instructions');
                return;
            }

            if (!confirm('Are you sure you want to delete this instruction? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'artifactInstructions', instructionId));
                alert('Instruction deleted successfully!');
                searchInstructions();
            } catch (error) {
                console.error('Error deleting instruction:', error);
                alert('Error deleting instruction. Please try again.');
            }
        };

        // Cancel edit instruction
        window.cancelEditInstruction = function() {
            document.getElementById('editInstructionSection').style.display = 'none';
            document.getElementById('editInstructionMessage').innerHTML = '';
            document.getElementById('editContactsList').innerHTML = '';
            document.getElementById('editLawsSelection').style.display = 'none';
            document.getElementById('editLawsSelection').innerHTML = '';
            document.getElementById('editSelectedLawsPreview').innerHTML = '';
            editContactCounter = 0;
            window.tempSelectedLaws = null;
        };

        // Submit new instruction
        window.submitInstruction = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to add instructions');
                return;
            }

            const messageDiv = document.getElementById('submitInstructionMessage');
            const submitBtn = document.getElementById('submitInstructionBtn');

            try {
                const state = document.getElementById('instructionState').value.trim().toUpperCase();
                const city = document.getElementById('instructionCity').value.trim();
                const jurisdiction = document.getElementById('instructionJurisdiction').value.trim();
                const owner = document.getElementById('instructionOwner').value.trim();
                const keywordsInput = document.getElementById('instructionKeywords').value.trim();
                const probability = document.getElementById('instructionProbability').value.trim();
                const specialInstructions = document.getElementById('instructionSpecial').value.trim();
                const generalNotes = document.getElementById('instructionGeneral').value.trim();

                if (!state && !city && !jurisdiction && !owner) {
                    messageDiv.innerHTML = '<div class="error-message">Please provide at least one of: State, City, Jurisdiction, or Owner</div>';
                    return;
                }

                const contacts = getContactsData();
                if (contacts.length === 0) {
                    messageDiv.innerHTML = '<div class="error-message">Please add at least one contact</div>';
                    return;
                }

                const keywords = keywordsInput.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
                const selectedLaws = getSelectedLawIds('lawsSelection');
                const htmlContent = generateHTMLFromContacts(contacts, selectedLaws, probability, specialInstructions, generalNotes);

                const instructionData = {
                    htmlContent: htmlContent,
                    keywords: keywords,
                    contacts: contacts,
                    probability: probability,
                    specialInstructions: specialInstructions,
                    generalNotes: generalNotes,
                    selectedLaws: selectedLaws,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email
                };

                if (state) instructionData.state = state;
                if (city) instructionData.city = city;
                if (jurisdiction) instructionData.jurisdiction = jurisdiction;
                if (owner) instructionData.owner = owner;

                submitBtn.disabled = true;
                submitBtn.textContent = 'Adding Instruction...';

                const docId = `instruction_${Date.now()}`;
                await setDoc(doc(db, 'artifactInstructions', docId), instructionData);

                messageDiv.innerHTML = '<div class="success-message">‚úì Instruction added successfully!</div>';

                // Clear form
                document.getElementById('instructionState').value = '';
                document.getElementById('instructionCity').value = '';
                document.getElementById('instructionJurisdiction').value = '';
                document.getElementById('instructionOwner').value = '';
                document.getElementById('instructionKeywords').value = '';
                document.getElementById('instructionProbability').value = '';
                document.getElementById('instructionSpecial').value = '';
                document.getElementById('instructionGeneral').value = '';
                document.getElementById('contactsList').innerHTML = '';
                document.getElementById('lawsSelection').style.display = 'none';
                document.getElementById('lawsSelection').innerHTML = '';
                document.getElementById('selectedLawsPreview').innerHTML = '';
                document.getElementById('keywordPreview').innerHTML = '';
                contactCounter = 0;
                
                // Add one contact field for next entry
                addContactField();

                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Save Instruction';

                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error adding instruction:', error);
                messageDiv.innerHTML = '<div class="error-message">Error adding instruction. Please try again.</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Save Instruction';
            }
        };

        // ============== END ARTIFACT INSTRUCTIONS FUNCTIONS ==============

        // ============== EDUCATIONAL RESOURCES FUNCTIONS ==============

        // Search resources
        window.searchResources = async function() {
            const searchTerm = document.getElementById('resourceSearchInput').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('resourceSearchResults');

            if (!searchTerm) {
                resultsDiv.innerHTML = '<p style="color: #7f8c8d;">Enter a search term to find resources.</p>';
                return;
            }

            try {
                resultsDiv.innerHTML = '<p style="color: #7f8c8d;">Searching...</p>';

                const resourcesRef = collection(db, 'educationalResources');
                const snapshot = await getDocs(resourcesRef);

                if (snapshot.empty) {
                    resultsDiv.innerHTML = '<p style="color: #7f8c8d;">No resources found in database.</p>';
                    return;
                }

                const results = [];
                snapshot.forEach((doc) => {
                    const resource = doc.data();
                    const searchableText = `${resource.title} ${resource.content}`.toLowerCase();
                    
                    if (searchableText.includes(searchTerm)) {
                        results.push({ id: doc.id, ...resource });
                    }
                });

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: #7f8c8d;">No resources match your search.</p>';
                    return;
                }

                let html = '';
                results.forEach(resource => {
                    const preview = resource.content.substring(0, 150) + '...';
                    html += `
                        <div class="search-result">
                            <h4>${resource.icon || 'üìñ'} ${resource.title}</h4>
                            <p>${preview}</p>
                            <div class="actions">
                                <button onclick="editResource('${resource.id}')" class="btn-secondary">‚úèÔ∏è Edit</button>
                                <button onclick="deleteResource('${resource.id}')" class="btn" style="background: #e74c3c;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;

            } catch (error) {
                console.error('Error searching resources:', error);
                resultsDiv.innerHTML = '<p style="color: #e74c3c;">Error searching resources.</p>';
            }
        };

        // Edit resource
        window.editResource = async function(resourceId) {
            try {
                const resourceDoc = await getDoc(doc(db, 'educationalResources', resourceId));
                
                if (!resourceDoc.exists()) {
                    alert('Resource not found');
                    return;
                }

                const resource = resourceDoc.data();
                
                document.getElementById('editResourceId').value = resourceId;
                document.getElementById('editResourceIcon').value = resource.icon || '';
                document.getElementById('editResourceTitle').value = resource.title || '';
                document.getElementById('editResourceContent').value = resource.content || '';
                
                document.getElementById('editResourceSection').style.display = 'block';
                document.getElementById('editResourceSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading resource for edit:', error);
                alert('Error loading resource data');
            }
        };

        // Update resource
        window.updateResource = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to update resources');
                return;
            }

            const messageDiv = document.getElementById('editResourceMessage');
            const resourceId = document.getElementById('editResourceId').value;

            try {
                const icon = document.getElementById('editResourceIcon').value.trim();
                const title = document.getElementById('editResourceTitle').value.trim();
                const content = document.getElementById('editResourceContent').value.trim();

                if (!icon || !title || !content) {
                    messageDiv.innerHTML = '<div class="error-message">Please fill in all required fields (*)</div>';
                    return;
                }

                const resourceData = {
                    icon: icon,
                    title: title,
                    content: content,
                    lastModified: new Date().toISOString()
                };

                await setDoc(doc(db, 'educationalResources', resourceId), resourceData, { merge: true });

                messageDiv.innerHTML = '<div class="success-message">‚úì Resource updated successfully!</div>';

                setTimeout(() => {
                    cancelResourceEdit();
                    searchResources();
                }, 1500);

            } catch (error) {
                console.error('Error updating resource:', error);
                messageDiv.innerHTML = '<div class="error-message">Error updating resource. Please try again.</div>';
            }
        };

        // Cancel resource edit
        window.cancelResourceEdit = function() {
            document.getElementById('editResourceSection').style.display = 'none';
            document.getElementById('editResourceMessage').innerHTML = '';
            document.getElementById('editResourceId').value = '';
            document.getElementById('editResourceIcon').value = '';
            document.getElementById('editResourceTitle').value = '';
            document.getElementById('editResourceContent').value = '';
        };

        // Delete resource
        window.deleteResource = async function(resourceId) {
            if (!isAuthenticated) {
                alert('You must be authenticated to delete resources');
                return;
            }

            if (!confirm('Are you sure you want to delete this resource? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'educationalResources', resourceId));
                alert('Resource deleted successfully!');
                searchResources();
            } catch (error) {
                console.error('Error deleting resource:', error);
                alert('Error deleting resource. Please try again.');
            }
        };

        // Submit new resource
        window.submitResource = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to add resources');
                return;
            }

            const messageDiv = document.getElementById('submitResourceMessage');
            const submitBtn = document.getElementById('submitResourceBtn');

            try {
                const icon = document.getElementById('resourceIcon').value.trim();
                const title = document.getElementById('resourceTitle').value.trim();
                const content = document.getElementById('resourceContent').value.trim();

                if (!icon || !title || !content) {
                    messageDiv.innerHTML = '<div class="error-message">Please fill in all required fields (*)</div>';
                    return;
                }

                const docId = title.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '-' + Date.now();

                const resourceData = {
                    icon: icon,
                    title: title,
                    content: content,
                    dateAdded: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };

                submitBtn.disabled = true;
                submitBtn.textContent = 'Adding Resource...';

                await setDoc(doc(db, 'educationalResources', docId), resourceData);

                messageDiv.innerHTML = '<div class="success-message">‚úì Resource added successfully!</div>';

                // Clear form
                document.getElementById('resourceIcon').value = '';
                document.getElementById('resourceTitle').value = '';
                document.getElementById('resourceContent').value = '';

                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Resource';

                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error adding resource:', error);
                messageDiv.innerHTML = '<div class="error-message">Error adding resource. Please try again.</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Resource';
            }
        };

        // ============== END EDUCATIONAL RESOURCES FUNCTIONS ==============

        // ============== ANNOUNCEMENTS FUNCTIONS ==============

        // Load announcements
        window.loadAnnouncement = async function() {
            try {
                // Load Home page announcement from main/announcements
                const mainAnnouncementDoc = await getDoc(doc(db, 'main', 'announcements'));
                const mainTextarea = document.getElementById('mainAnnouncementText');
                
                if (mainAnnouncementDoc.exists()) {
                    const data = mainAnnouncementDoc.data();
                    mainTextarea.value = data.main || data.announcement || data.content || data.message || '';
                } else {
                    mainTextarea.value = '';
                }
                
                // Load Artifact Help page announcement from config/announcements
                const artifactAnnouncementDoc = await getDoc(doc(db, 'config', 'announcements'));
                const artifactHelpTextarea = document.getElementById('artifactHelpAnnouncementText');
                
                if (artifactAnnouncementDoc.exists()) {
                    const data = artifactAnnouncementDoc.data();
                    artifactHelpTextarea.value = data.artifactHelp || '';
                } else {
                    artifactHelpTextarea.value = '';
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                document.getElementById('announcementMessage').innerHTML = 
                    '<div class="error-message">Error loading announcements: ' + error.message + '</div>';
            }
        };

        // Save announcements
        window.saveAnnouncement = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to save announcements');
                return;
            }

            const messageDiv = document.getElementById('announcementMessage');
            const mainAnnouncementText = document.getElementById('mainAnnouncementText').value.trim();
            const artifactHelpAnnouncementText = document.getElementById('artifactHelpAnnouncementText').value.trim();

            try {
                messageDiv.innerHTML = '<div class="success-message" style="background: #e3f2fd; color: #1976d2;">Saving...</div>';

                // Save Home page announcement to main/announcements
                await setDoc(doc(db, 'main', 'announcements'), {
                    main: mainAnnouncementText,
                    announcement: mainAnnouncementText,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: currentUser.email
                });

                // Save Artifact Help page announcement to config/announcements
                await setDoc(doc(db, 'config', 'announcements'), {
                    artifactHelp: artifactHelpAnnouncementText,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: currentUser.email
                });

                messageDiv.innerHTML = '<div class="success-message">‚úì Announcements saved successfully!</div>';

                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error saving announcements:', error);
                messageDiv.innerHTML = '<div class="error-message">Error saving announcements: ' + error.message + '</div>';
            }
        };

        // ============== END ANNOUNCEMENTS FUNCTIONS ==============

        // ============== CREDITS PAGE FUNCTIONS ==============

        // Load credits content
        window.loadCredits = async function() {
            try {
                const creditsDoc = await getDoc(doc(db, 'credits', 'credits-content'));
                const textarea = document.getElementById('creditsMarkdown');
                
                if (creditsDoc.exists()) {
                    textarea.value = creditsDoc.data().markdown || '';
                } else {
                    textarea.value = '# Credits & Attributions\n\nAdd your credits content here...';
                }
            } catch (error) {
                console.error('Error loading credits:', error);
                document.getElementById('creditsMessage').innerHTML = 
                    '<div class="error-message">Error loading credits: ' + error.message + '</div>';
            }
        };

        // Save credits content
        window.saveCredits = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to save credits');
                return;
            }

            const messageDiv = document.getElementById('creditsMessage');
            const markdown = document.getElementById('creditsMarkdown').value.trim();

            try {
                messageDiv.innerHTML = '<div class="success-message" style="background: #e3f2fd; color: #1976d2;">Saving...</div>';

                await setDoc(doc(db, 'credits', 'credits-content'), {
                    markdown: markdown,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: currentUser.email
                });

                messageDiv.innerHTML = '<div class="success-message">‚úì Credits page saved successfully!</div>';

                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Error saving credits:', error);
                messageDiv.innerHTML = '<div class="error-message">Error saving credits: ' + error.message + '</div>';
            }
        };

        // ============== END CREDITS PAGE FUNCTIONS ==============
        
        // ============== PARCEL VIEWERS FUNCTIONS ==============
        
        let parcelViewersData = {};
        
        // Load parcel viewers from database
        window.loadParcelViewers = async function() {
            try {
                const messageDiv = document.getElementById('parcelViewersMessage');
                messageDiv.innerHTML = '<div class="success-message" style="background: #e3f2fd; color: #1976d2;">Loading...</div>';
                
                const parcelDoc = await getDoc(doc(db, 'config', 'parcelViewers'));
                
                if (parcelDoc.exists()) {
                    parcelViewersData = parcelDoc.data().viewers || {};
                } else {
                    parcelViewersData = {};
                }
                
                displayParcelViewers();
                messageDiv.innerHTML = '<div class="success-message">‚úì Parcel viewers loaded successfully!</div>';
                
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 2000);
                
            } catch (error) {
                console.error('Error loading parcel viewers:', error);
                document.getElementById('parcelViewersMessage').innerHTML = 
                    '<div class="error-message">Error loading parcel viewers: ' + error.message + '</div>';
            }
        };
        
        // Display parcel viewers in organized structure
        function displayParcelViewers() {
            const listDiv = document.getElementById('parcelViewersList');
            
            if (Object.keys(parcelViewersData).length === 0) {
                listDiv.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 2rem;">No parcel viewers found. Add your first one above!</p>';
                return;
            }
            
            let html = '<h3 style="color: #2c3e50; margin-bottom: 1.5rem;">üìç Parcel Viewers by State</h3>';
            
            // Sort states alphabetically
            const sortedStates = Object.keys(parcelViewersData).sort();
            
            sortedStates.forEach(state => {
                html += `
                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="color: #3498db; margin-bottom: 1rem; font-size: 1.2rem;">üå≤ ${state}</h4>
                `;
                
                // Sort counties alphabetically
                const sortedCounties = Object.keys(parcelViewersData[state]).sort();
                
                sortedCounties.forEach(county => {
                    const url = parcelViewersData[state][county];
                    const entryId = `${state}|||${county}`.replace(/\s/g, '_');
                    
                    html += `
                        <div style="background: #f8f9fa; border-left: 4px solid #27ae60; padding: 1rem; margin-bottom: 0.75rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">${county}</div>
                                <div style="font-size: 0.9rem; color: #7f8c8d; word-break: break-all;">
                                    <a href="${url}" target="_blank" style="color: #3498db; text-decoration: none;">üîó ${url}</a>
                                </div>
                            </div>
                            <button onclick="removeParcelViewer('${state}', '${county}')" 
                                    style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 1rem; white-space: nowrap;">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            listDiv.innerHTML = html;
        }
        
        // Add new parcel viewer
        window.addParcelViewer = function() {
            const state = document.getElementById('newParcelState').value.trim();
            const county = document.getElementById('newParcelCounty').value.trim();
            const url = document.getElementById('newParcelUrl').value.trim();
            const messageDiv = document.getElementById('parcelViewersMessage');
            
            if (!state || !county || !url) {
                messageDiv.innerHTML = '<div class="error-message">Please fill in all fields</div>';
                return;
            }
            
            // Validate URL
            try {
                new URL(url);
            } catch (e) {
                messageDiv.innerHTML = '<div class="error-message">Please enter a valid URL</div>';
                return;
            }
            
            // Add to data structure
            if (!parcelViewersData[state]) {
                parcelViewersData[state] = {};
            }
            
            parcelViewersData[state][county] = url;
            
            // Clear inputs
            document.getElementById('newParcelState').value = '';
            document.getElementById('newParcelCounty').value = '';
            document.getElementById('newParcelUrl').value = '';
            
            // Update display
            displayParcelViewers();
            
            messageDiv.innerHTML = '<div class="success-message">‚úì Parcel viewer added! Don\'t forget to click "Save All Changes"</div>';
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        };
        
        // Remove parcel viewer
        window.removeParcelViewer = function(state, county) {
            if (!confirm(`Remove parcel viewer for ${county}, ${state}?`)) {
                return;
            }
            
            if (parcelViewersData[state] && parcelViewersData[state][county]) {
                delete parcelViewersData[state][county];
                
                // If state has no counties left, remove state
                if (Object.keys(parcelViewersData[state]).length === 0) {
                    delete parcelViewersData[state];
                }
                
                displayParcelViewers();
                
                const messageDiv = document.getElementById('parcelViewersMessage');
                messageDiv.innerHTML = '<div class="success-message">‚úì Parcel viewer removed! Don\'t forget to click "Save All Changes"</div>';
                
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
            }
        };
        
        // Save all parcel viewers to database
        window.saveParcelViewers = async function() {
            if (!isAuthenticated) {
                alert('You must be authenticated to save parcel viewers');
                return;
            }
            
            const messageDiv = document.getElementById('parcelViewersMessage');
            
            try {
                messageDiv.innerHTML = '<div class="success-message" style="background: #e3f2fd; color: #1976d2;">Saving...</div>';
                
                await setDoc(doc(db, 'config', 'parcelViewers'), {
                    viewers: parcelViewersData,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: currentUser.email
                });
                
                messageDiv.innerHTML = '<div class="success-message">‚úì Parcel viewers saved successfully!</div>';
                
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error saving parcel viewers:', error);
                messageDiv.innerHTML = '<div class="error-message">Error saving parcel viewers: ' + error.message + '</div>';
            }
        };
        
        // ============== END PARCEL VIEWERS FUNCTIONS ==============

        // ============== ARTIFACT OF THE DAY FUNCTIONS ==============
        
        // Helper function to format date as YYYY-MM-DD
        function formatDateString(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Load today's artifact
        window.loadTodaysArtifact = async function() {
            if (!isAuthenticated) {
                alert('You must be logged in to view artifacts');
                return;
            }

            const displayDiv = document.getElementById('currentArtifactDisplay');
            displayDiv.innerHTML = '<p style="color: #7f8c8d;">Loading...</p>';

            try {
                const today = formatDateString(new Date());
                const docRef = doc(db, 'artifactOfDay', today);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const artifact = data.artifact;
                    displayDiv.innerHTML = `
                        <div style="border-left: 4px solid #2196f3; padding-left: 1rem;">
                            <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">${artifact.title || 'Untitled'}</h4>
                            ${artifact.culture ? `<p><strong>Culture:</strong> ${artifact.culture}</p>` : ''}
                            ${artifact.date ? `<p><strong>Date:</strong> ${artifact.date}</p>` : ''}
                            ${artifact.place ? `<p><strong>Place:</strong> ${artifact.place}</p>` : ''}
                            ${artifact.unitCode ? `<p><strong>Collection:</strong> ${artifact.unitCode}</p>` : ''}
                            ${artifact.description ? `<p style="margin-top: 0.5rem;">${artifact.description}</p>` : ''}
                            ${artifact.image ? `<p><strong>Image:</strong> <a href="${artifact.image}" target="_blank" style="color: #2196f3; text-decoration: underline;">View Image</a></p>` : ''}
                            ${artifact.recordLink ? `<p><strong>Record:</strong> <a href="${artifact.recordLink}" target="_blank" style="color: #2196f3; text-decoration: underline;">View Record</a></p>` : ''}
                            <p style="color: #7f8c8d; font-size: 0.85rem; margin-top: 0.5rem;">Saved: ${data.timestamp || 'Unknown'}</p>
                        </div>
                    `;
                } else {
                    displayDiv.innerHTML = '<p style="color: #7f8c8d;">No artifact set for today. The system will automatically fetch one when a user visits the homepage.</p>';
                }
            } catch (error) {
                console.error('Error loading artifact:', error);
                displayDiv.innerHTML = `<div class="error-message">Error loading artifact: ${error.message}</div>`;
            }
        };

        // Clear today's artifact
        window.clearTodaysArtifact = async function() {
            if (!isAuthenticated) {
                alert('You must be logged in to clear artifacts');
                return;
            }

            if (!confirm('Are you sure you want to clear today\'s artifact? A new one will be automatically fetched when a user visits the homepage.')) {
                return;
            }

            try {
                const today = formatDateString(new Date());
                const docRef = doc(db, 'artifactOfDay', today);
                await deleteDoc(docRef);
                
                document.getElementById('currentArtifactDisplay').innerHTML = '<div class="success-message">‚úì Today\'s artifact has been cleared!</div>';
                setTimeout(loadTodaysArtifact, 2000);
            } catch (error) {
                console.error('Error clearing artifact:', error);
                alert(`Error clearing artifact: ${error.message}`);
            }
        };

        // Set artifact for specific date
        window.setArtifactForDate = async function() {
            if (!isAuthenticated) {
                alert('You must be logged in to set artifacts');
                return;
            }

            const dateInput = document.getElementById('artifactDate').value;
            const title = document.getElementById('artifactTitle').value.trim();
            const culture = document.getElementById('artifactCulture').value.trim();
            const period = document.getElementById('artifactPeriod').value.trim();
            const description = document.getElementById('artifactDescription').value.trim();
            const place = document.getElementById('artifactPlace').value.trim();
            const unitCode = document.getElementById('artifactUnitCode').value.trim();
            const imageUrl = document.getElementById('artifactImageUrl').value.trim();
            const recordLink = document.getElementById('artifactRecordLink').value.trim();
            const url = document.getElementById('artifactUrl').value.trim();
            const id = document.getElementById('artifactId').value.trim();
            const messageDiv = document.getElementById('artifactMessage');

            if (!dateInput) {
                messageDiv.innerHTML = '<div class="error-message">Please select a date</div>';
                return;
            }

            if (!title) {
                messageDiv.innerHTML = '<div class="error-message">Please enter an artifact title</div>';
                return;
            }

            const artifact = {
                title: title,
                culture: culture || "Unknown",
                date: period || "Date unknown",
                description: description || "No description available",
                place: place || "",
                unitCode: unitCode || "",
                image: imageUrl || "",
                recordLink: recordLink || "",
                url: url || "",
                id: id || `manual-${Date.now()}`
            };

            try {
                const docRef = doc(db, 'artifactOfDay', dateInput);
                await setDoc(docRef, {
                    artifact: artifact,
                    date: dateInput,
                    timestamp: new Date().toISOString()
                });

                messageDiv.innerHTML = '<div class="success-message">‚úì Artifact saved successfully!</div>';
                clearArtifactForm();
                
                // Refresh today's artifact if we just set it
                const today = formatDateString(new Date());
                if (dateInput === today) {
                    setTimeout(loadTodaysArtifact, 1000);
                }
            } catch (error) {
                console.error('Error saving artifact:', error);
                messageDiv.innerHTML = `<div class="error-message">Error saving artifact: ${error.message}</div>`;
            }
        };

        // Clear artifact form
        window.clearArtifactForm = function() {
            document.getElementById('artifactDate').value = '';
            document.getElementById('artifactTitle').value = '';
            document.getElementById('artifactCulture').value = '';
            document.getElementById('artifactPeriod').value = '';
            document.getElementById('artifactDescription').value = '';
            document.getElementById('artifactPlace').value = '';
            document.getElementById('artifactUnitCode').value = '';
            document.getElementById('artifactImageUrl').value = '';
            document.getElementById('artifactRecordLink').value = '';
            document.getElementById('artifactUrl').value = '';
            document.getElementById('artifactId').value = '';
            document.getElementById('artifactMessage').innerHTML = '';
        };

        // View artifact by date
        window.viewArtifactByDate = async function() {
            if (!isAuthenticated) {
                alert('You must be logged in to view artifacts');
                return;
            }

            const dateInput = document.getElementById('viewArtifactDate').value;
            const displayDiv = document.getElementById('viewArtifactDisplay');
            const actionsDiv = document.getElementById('viewArtifactActions');

            if (!dateInput) {
                displayDiv.innerHTML = '<div class="error-message">Please select a date</div>';
                actionsDiv.style.display = 'none';
                return;
            }

            displayDiv.innerHTML = '<p style="color: #7f8c8d;">Loading...</p>';
            actionsDiv.style.display = 'none';

            try {
                const docRef = doc(db, 'artifactOfDay', dateInput);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const artifact = data.artifact;
                    displayDiv.innerHTML = `
                        <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem;">
                            <h4 style="color: #2c3e50; margin-bottom: 1rem;">${artifact.title || 'Untitled'}</h4>
                            ${artifact.culture ? `<p><strong>Culture:</strong> ${artifact.culture}</p>` : ''}
                            ${artifact.date ? `<p><strong>Date:</strong> ${artifact.date}</p>` : ''}
                            ${artifact.place ? `<p><strong>Place:</strong> ${artifact.place}</p>` : ''}
                            ${artifact.unitCode ? `<p><strong>Collection:</strong> ${artifact.unitCode}</p>` : ''}
                            ${artifact.description ? `<p style="margin-top: 0.5rem;">${artifact.description}</p>` : ''}
                            ${artifact.image ? `<p><strong>Image:</strong> <a href="${artifact.image}" target="_blank" style="color: #2196f3; text-decoration: underline;">View Image</a></p>` : ''}
                            ${artifact.recordLink ? `<p><strong>Record Link:</strong> <a href="${artifact.recordLink}" target="_blank" style="color: #2196f3; text-decoration: underline;">View Record</a></p>` : ''}
                            ${artifact.url ? `<p><strong>EDAN ID:</strong> ${artifact.url}</p>` : ''}
                            <p style="color: #7f8c8d; font-size: 0.85rem; margin-top: 1rem; border-top: 1px solid #e0e0e0; padding-top: 0.5rem;">Saved: ${data.timestamp || 'Unknown'}</p>
                        </div>
                    `;
                    actionsDiv.style.display = 'flex';
                    // Store the viewed artifact data for potential editing
                    window.viewedArtifactData = { date: dateInput, artifact: artifact };
                } else {
                    displayDiv.innerHTML = '<p style="color: #7f8c8d;">No artifact found for this date.</p>';
                    actionsDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error viewing artifact:', error);
                displayDiv.innerHTML = `<div class="error-message">Error loading artifact: ${error.message}</div>`;
                actionsDiv.style.display = 'none';
            }
        };

        // Edit viewed artifact
        window.editViewedArtifact = function() {
            if (!window.viewedArtifactData) {
                alert('No artifact data to edit');
                return;
            }

            const { date, artifact } = window.viewedArtifactData;
            
            // Populate the form
            document.getElementById('artifactDate').value = date;
            document.getElementById('artifactTitle').value = artifact.title || '';
            document.getElementById('artifactCulture').value = artifact.culture || '';
            document.getElementById('artifactPeriod').value = artifact.date || '';
            document.getElementById('artifactDescription').value = artifact.description || '';
            document.getElementById('artifactPlace').value = artifact.place || '';
            document.getElementById('artifactUnitCode').value = artifact.unitCode || '';
            document.getElementById('artifactImageUrl').value = artifact.image || '';
            document.getElementById('artifactRecordLink').value = artifact.recordLink || '';
            document.getElementById('artifactUrl').value = artifact.url || '';
            document.getElementById('artifactId').value = artifact.id || '';

            // Scroll to form
            document.querySelector('#artifactOfDaySection .section-card > div:nth-of-type(3)').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Show message
            document.getElementById('artifactMessage').innerHTML = '<div style="background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 1rem; border-radius: 8px;">Editing artifact for ' + date + '. Make your changes and click Save.</div>';
        };

        // Clear viewed artifact
        window.clearViewedArtifact = async function() {
            if (!window.viewedArtifactData) {
                alert('No artifact data to clear');
                return;
            }

            const { date } = window.viewedArtifactData;
            
            if (!confirm(`Are you sure you want to clear the artifact for ${date}?`)) {
                return;
            }

            try {
                const docRef = doc(db, 'artifactOfDay', date);
                await deleteDoc(docRef);
                
                document.getElementById('viewArtifactDisplay').innerHTML = '<div class="success-message">‚úì Artifact cleared successfully!</div>';
                document.getElementById('viewArtifactActions').style.display = 'none';
                window.viewedArtifactData = null;
                
                // Refresh today's artifact if we just cleared it
                const today = formatDateString(new Date());
                if (date === today) {
                    setTimeout(loadTodaysArtifact, 1000);
                }
            } catch (error) {
                console.error('Error clearing artifact:', error);
                alert(`Error clearing artifact: ${error.message}`);
            }
        };

        // ============== END ARTIFACT OF THE DAY FUNCTIONS ==============

        // Switch between admin sections
        window.switchAdminSection = function(sectionName) {
            // Hide all sections
            document.querySelectorAll('.admin-section-content').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.admin-nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.classList.add('active');
            }
            
            // Activate clicked tab
            event.target.classList.add('active');
            
            // Close mobile menu after selection
            if (window.innerWidth <= 968) {
                closeMobileMenu();
            }
            
            // Load data for specific sections
            if (sectionName === 'announcements') {
                loadAnnouncement();
            } else if (sectionName === 'credits') {
                loadCredits();
            } else if (sectionName === 'artifactOfDay') {
                loadTodaysArtifact();
                // Set today's date as default in the date input
                const today = formatDateString(new Date());
                document.getElementById('artifactDate').value = today;
            }
        };
        
        // Mobile menu toggle functions
        window.toggleMobileMenu = function() {
            const nav = document.getElementById('adminNav');
            const overlay = document.querySelector('.mobile-menu-overlay');
            nav.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        };
        
        window.closeMobileMenu = function() {
            const nav = document.getElementById('adminNav');
            const overlay = document.querySelector('.mobile-menu-overlay');
            nav.classList.remove('mobile-open');
            overlay.classList.remove('active');
        };

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            populateStateDropdowns();
        });
    </script>
</body>
</html>
