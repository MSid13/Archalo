<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Found an Artifact - Archalo</title>
    <link rel="icon" type="image/png" href="owlcheologists.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
        }
        
        /* Navigation */
        nav {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .logo {
            color: #ecf0f1;
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            gap: clamp(1rem, 3vw, 2rem);
        }
        
        .nav-links a {
            color: #ecf0f1;
            text-decoration: none;
            font-weight: 500;
            font-size: clamp(0.9rem, 2vw, 1rem);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
            transform: translateY(-1px);
        }
        
        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.5rem;
            z-index: 1001;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background-color: #ecf0f1;
            margin: 3px 0;
            transition: all 0.3s ease;
            border-radius: 2px;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }
        
        /* Mobile Navigation */
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            
            .nav-links {
                position: fixed;
                left: -100%;
                top: 70px;
                flex-direction: column;
                background: linear-gradient(135deg, #2c3e50, #34495e);
                width: 100%;
                text-align: center;
                transition: left 0.3s ease;
                box-shadow: 0 10px 27px rgba(0,0,0,0.3);
                padding: 1rem 0;
                gap: 0;
            }
            
            .nav-links.active {
                left: 0;
            }
            
            .nav-links li {
                padding: 0.5rem 0;
                width: 100%;
            }
            
            .nav-links a {
                display: block;
                padding: 1rem;
                width: 100%;
            }
            
            .nav-container {
                padding: 0 1rem;
            }
            
            .location-options {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr !important;
            }
            
            .contact-fields {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Tablet responsive */
        @media (max-width: 1024px) and (min-width: 769px) {
            .location-options {
                gap: 1rem;
            }
            
            .main-container {
                padding: 2rem 1.5rem;
            }
        }
        
        /* Hero section */
        .hero {
            background: linear-gradient(135deg, #d4704a, #c0603c);
            color: white;
            padding: clamp(3rem, 6vw, 5rem) 2rem;
            text-align: center;
        }
        
        .hero h1 {
            font-size: clamp(2.5rem, 6vw, 4rem);
            margin-bottom: 1rem;
            font-weight: 700;
            letter-spacing: -1px;
        }
        
        .hero p {
            font-size: clamp(1.1rem, 3vw, 1.3rem);
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        /* Main content */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: clamp(3rem, 6vw, 5rem) 2rem;
        }
        
        .location-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .location-section h2 {
            color: #2c3e50;
            margin-bottom: 2rem;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            text-align: center;
        }
        
        .location-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .location-option {
            padding: 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .location-option:hover, .location-option.active {
            border-color: #3498db;
            background-color: #f8f9fa;
        }
        
        .location-option h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .location-form {
            display: block; /* Change from none to block to show by default */
            margin-top: 2rem;
        }
        
        .location-form.active {
            display: block;
        }
        
        .location-form.inactive {
            display: none;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .form-group input {
            padding: 0.8rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            border-color: #3498db;
        }
        
        .btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .location-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .location-btn:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .results-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            display: none;
        }
        
        .results-section.active {
            display: block;
        }
        
        .property-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .property-info h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .info-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
            word-wrap: break-word;
        }
        
        .guidance-section {
            margin-top: 2rem;
        }
        
        .guidance-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .contact-card {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .contact-card h4 {
            color: #856404;
            margin-bottom: 0.5rem;
        }
        
        .contact-info {
            color: #856404;
        }
        
        .emergency-note {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 2rem;
        }
        
        /* Map Styles */
        .parcel-map-section {
            margin: 2rem 0;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
        }
        
        .parcel-map-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        #parcelMap {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .map-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* View Toggle Styles */
        .view-toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            width: fit-content;
        }
        
        .view-toggle-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-weight: 600;
        }
        
        .view-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: #bdc3c7;
            border-radius: 13px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .view-toggle.active {
            background-color: #3498db;
        }
        
        .view-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .view-toggle.active .view-toggle-slider {
            transform: translateX(24px);
        }
        
        .view-type-label {
            font-size: 0.85rem;
            color: #2c3e50;
            font-weight: 500;
        }
        
        /* Tabbed View Styles */
        .tabbed-view {
            display: none;
        }
        
        .tabbed-view.active {
            display: block;
        }
        
        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #7f8c8d;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: -2px;
        }
        
        .tab-button:hover {
            color: #3498db;
            background-color: #f8f9fa;
        }
        
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        /* List View Styles */
        .list-view {
            display: block;
        }
        
        .list-view.inactive {
            display: none;
        }
        
        /* Relevant Laws Section Styles */
        .relevant-laws-section {
            margin: 2rem 0;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
        }
        
        .relevant-laws-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .laws-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .law-item {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .law-item:hover {
            background: #e8f4f8;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        
        .law-item.federal {
            border-left-color: #e74c3c;
        }
        
        .law-item.state {
            border-left-color: #27ae60;
        }
        
        .law-item.local {
            border-left-color: #f39c12;
        }
        
        .law-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .law-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        .law-type.federal {
            background: #fee;
            color: #e74c3c;
        }
        
        .law-type.state {
            background: #efe;
            color: #27ae60;
        }
        
        .law-type.local {
            background: #ffeaa7;
            color: #f39c12;
        }
        
        .law-description {
            color: #666;
            font-size: 0.95rem;
            margin-top: 0.5rem;
        }
        
        .law-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e0e0e0;
        }
        
        .law-details.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .law-full-text {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            color: #2c3e50;
            line-height: 1.6;
            margin-top: 0.5rem;
        }
        
        .law-reference {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .law-reference a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
        }
        
        .law-reference a:hover {
            text-decoration: underline;
        }
        
        /* Admin Modal Styles */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .admin-modal.active {
            display: flex;
        }
        
        .admin-modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .admin-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .admin-modal-header h2 {
            color: #2c3e50;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: #95a5a6;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            background-color: #ecf0f1;
            color: #e74c3c;
        }
        
        .admin-login-form, .admin-panel {
            display: none;
        }
        
        .admin-login-form.active, .admin-panel.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .keyword-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .keyword-tag {
            background-color: #3498db;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .keyword-tag button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .contact-item {
            background-color: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .contact-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .contact-item-header h5 {
            color: #2c3e50;
            margin: 0;
        }
        
        .remove-contact-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .remove-contact-btn:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }
        
        .contact-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .contact-fields .form-group {
            margin-bottom: 0;
        }
        
        .contact-fields .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .admin-user-info {
            background-color: #e8f5e9;
            border: 1px solid #81c784;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .admin-user-info p {
            margin: 0.5rem 0;
            color: #2e7d32;
        }
        
        .btn-logout {
            background-color: #e74c3c;
            margin-top: 1rem;
        }
        
        .btn-logout:hover {
            background-color: #c0392b;
        }
        
        /* Footer Styles */
        footer {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            padding: 2rem 1rem;
            margin-top: 3rem;
            text-align: center;
        }
        
        .footer-disclaimer {
            max-width: 900px;
            margin: 0 auto 1rem;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #bdc3c7;
        }
        
        .admin-link {
            color: #bdc3c7;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px dotted transparent;
        }
        
        .admin-link:hover {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        @media (max-width: 768px) {
            .location-options {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-navigation {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-button {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
                white-space: nowrap;
            }
            
            .view-toggle-container {
                width: 100%;
                justify-content: center;
            }
            
            .admin-modal-content {
                padding: 1.5rem;
                margin: 1rem;
                max-width: 95%;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Make buttons stack on mobile */
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* Admin panel search section */
            #searchBtn, #loadAllBtn {
                width: 48%;
                display: inline-block;
                margin: 0.25rem 1%;
            }
            
            /* Edit form buttons */
            #editFormContainer .btn {
                width: 100%;
                margin: 0.5rem 0;
                float: none !important;
            }
            
            /* Hero section */
            .hero {
                padding: 2rem 1rem;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            /* Sample location buttons */
            .btn[onclick*="loadSampleCoords"] {
                font-size: 0.85rem;
                padding: 0.5rem 0.8rem;
            }
        }
        
        /* Sample Locations Styles */
        .sample-locations-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e0e0e0;
        }
        
        .sample-locations-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .state-section {
            margin-bottom: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            transition: all 0.3s ease;
        }
        
        .state-section:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
        }
        
        .state-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            width: 100%;
            text-align: left;
        }
        
        .state-header:hover {
            background: linear-gradient(135deg, #e8f4f8, #f0f8ff);
        }
        
        .state-header.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .state-name {
            font-weight: 600;
            font-size: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .state-header.active .state-name {
            color: white;
        }
        
        .toggle-icon {
            font-size: 1.5rem;
            transition: all 0.3s ease;
            color: #7f8c8d;
            font-weight: 700;
            line-height: 1;
        }
        
        .toggle-icon::before {
            content: '+';
        }
        
        .state-header.active .toggle-icon {
            color: white;
        }
        
        .state-header.active .toggle-icon::before {
            content: '‚àí';
        }
        
        .state-locations {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            background: #fafafa;
        }
        
        .state-locations.active {
            max-height: 1000px;
            padding: 1rem;
        }
        
        .location-btn-sample {
            width: 100%;
            padding: 0.85rem 1.2rem;
            margin-bottom: 0.6rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .location-btn-sample:hover {
            transform: translateX(5px);
            border-color: #3498db;
            box-shadow: 0 3px 12px rgba(52, 152, 219, 0.2);
            background: linear-gradient(135deg, #ffffff, #f0f8ff);
        }
        
        .location-btn-sample:last-child {
            margin-bottom: 0;
        }
        
        .location-icon {
            font-size: 1.3rem;
            min-width: 24px;
        }
        
        .location-type {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            background: #e8f4f8;
            color: #2980b9;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
        }
        
        /* Timeline Styles */
        .timeline-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .timeline-section h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .timeline {
            position: relative;
            padding: 1rem 0;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #3498db, #2c3e50);
        }
        
        .timeline-item {
            position: relative;
            padding-left: 60px;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .timeline-marker {
            position: absolute;
            left: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #3498db;
            z-index: 1;
        }
        
        .timeline-marker.historic {
            border-color: #e74c3c;
        }
        
        .timeline-marker.modern {
            border-color: #27ae60;
        }
        
        .timeline-content {
            background: #f8f9fa;
            padding: 1.25rem;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .timeline-content:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .timeline-content.historic {
            border-left-color: #e74c3c;
        }
        
        .timeline-content.modern {
            border-left-color: #27ae60;
        }
        
        .timeline-year {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .timeline-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 0.5rem;
        }
        
        .timeline-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }
        
        .timeline-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .timeline-tag {
            background: #3498db;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Quick Navigation Bar Styles */
        .quick-nav {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.08);
            display: none; /* Hidden by default, shown when results are available */
        }
        
        .quick-nav.active {
            display: block;
            animation: fadeInDown 0.6s ease-out;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .quick-nav h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            text-align: center;
            font-weight: 700;
        }
        
        .quick-nav-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        
        .quick-nav-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            color: #2c3e50;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .quick-nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #3498db, #2980b9);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .quick-nav-link:hover:not(.disabled) {
            color: white;
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .quick-nav-link:hover:not(.disabled)::before {
            opacity: 1;
        }
        
        .quick-nav-link:active:not(.disabled) {
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(52, 152, 219, 0.3);
        }
        
        .quick-nav-link span {
            font-size: 1.2rem;
        }
        
        .quick-nav-link.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            background: #f5f5f5;
            color: #999;
        }
        
        @media (max-width: 992px) {
            .quick-nav-links {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .quick-nav {
                padding: 1.5rem;
                position: relative;
                top: 0;
            }
            
            .quick-nav h3 {
                font-size: 1.1rem;
                margin-bottom: 1rem;
            }
            
            .quick-nav-links {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .quick-nav-link {
                padding: 0.875rem 1.25rem;
                font-size: 0.95rem;
            }
        }

        
        .timeline-tag.purchase {
            background: #27ae60;
        }
        
        .timeline-tag.resident {
            background: #e67e22;
        }
        
        .timeline-tag.event {
            background: #9b59b6;
        }
        
        /* Responsive Timeline */
        @media (max-width: 768px) {
            .timeline::before {
                left: 15px;
            }
            
            .timeline-item {
                padding-left: 45px;
            }
            
            .timeline-marker {
                left: 6px;
                width: 20px;
                height: 20px;
            }
            
            .timeline-year {
                font-size: 1.1rem;
            }
            
            .timeline-title {
                font-size: 1rem;
            }
            
            .timeline-content {
                padding: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .timeline-section {
                padding: 1rem;
            }
            
            .timeline-section h3 {
                font-size: 1.25rem;
            }
            
            .timeline::before {
                left: 12px;
            }
            
            .timeline-item {
                padding-left: 35px;
                margin-bottom: 1.5rem;
            }
            
            .timeline-marker {
                left: 4px;
                width: 18px;
                height: 18px;
                border-width: 2px;
            }
            
            .timeline-tags {
                gap: 0.35rem;
            }
            
            .timeline-tag {
                font-size: 0.75rem;
                padding: 0.2rem 0.6rem;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .logo {
                font-size: 1.3rem;
            }
            
            .nav-container {
                padding: 0 0.5rem;
            }
            
            .main-container {
                padding: 1.5rem 1rem;
            }
            
            .location-section,
            .results-section {
                padding: 1rem;
            }
            
            .admin-modal-content {
                margin: 0.5rem;
                padding: 1rem;
            }
            
            /* Stack search buttons vertically on very small screens */
            #searchBtn, #loadAllBtn {
                width: 100%;
                margin: 0.25rem 0;
            }
            
            .form-group label {
                font-size: 0.9rem;
            }
            
            .form-group input,
            .form-group textarea {
                font-size: 0.9rem;
            }
        }
        
        /* Sample Locations Styles */
        .sample-locations-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e0e0e0;
        }
        
        .sample-locations-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .state-section {
            margin-bottom: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            transition: all 0.3s ease;
        }
        
        .state-section:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
        }
        
        .state-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            width: 100%;
            text-align: left;
        }
        
        .state-header:hover {
            background: linear-gradient(135deg, #e8f4f8, #f0f8ff);
        }
        
        .state-header.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .state-name {
            font-weight: 600;
            font-size: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .state-header.active .state-name {
            color: white;
        }
        
        .toggle-icon {
            font-size: 1.5rem;
            transition: all 0.3s ease;
            color: #7f8c8d;
            font-weight: 700;
            line-height: 1;
        }
        
        .toggle-icon::before {
            content: '+';
        }
        
        .state-header.active .toggle-icon {
            color: white;
        }
        
        .state-header.active .toggle-icon::before {
            content: '‚àí';
        }
        
        .state-locations {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            background: #fafafa;
        }
        
        .state-locations.active {
            max-height: 1000px;
            padding: 1rem;
        }
        
        .location-btn-sample {
            width: 100%;
            padding: 0.85rem 1.2rem;
            margin-bottom: 0.6rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .location-btn-sample:hover {
            transform: translateX(5px);
            border-color: #3498db;
            box-shadow: 0 3px 12px rgba(52, 152, 219, 0.2);
            background: linear-gradient(135deg, #ffffff, #f0f8ff);
        }
        
        .location-btn-sample:last-child {
            margin-bottom: 0;
        }
        
        .location-icon {
            font-size: 1.3rem;
            min-width: 24px;
        }
        
        .location-type {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            background: #e8f4f8;
            color: #2980b9;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="index.html" style="text-decoration: none; color: inherit;">
                <div class="logo">Archalo</div>
            </a>
            <button class="hamburger" id="hamburger" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="laws.html">Laws</a></li>
                <li><a href="artifactHelp.html" class="active">I Found an Artifact</a></li>
                <li><a href="edu-resources.html">Educational Resources</a></li>
            </ul>
        </div>
    </nav>

    <section class="hero">
        <h1>I Found an Artifact!</h1>
        <p>Get location-specific guidance on what to do when you discover archaeological artifacts</p>
    </section>

    <section class="main-container">
        <div class="location-section">
            <h2>First, let's determine your location</h2>
            
            <div class="location-options">
                <div class="location-option" id="manualOption">
                    <h3>üìç Enter Coordinates</h3>
                    <p>Manually input latitude and longitude</p>
                </div>
                <div class="location-option" id="gpsOption">
                    <h3>üåê Use Current Location</h3>
                    <p>Allow GPS access to get precise location</p>
                </div>
            </div>
            
            <div id="manualForm" class="location-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="latitude">Latitude:</label>
                        <input type="number" id="latitude" step="any" placeholder="" required>
                    </div>
                    <div class="form-group">
                        <label for="longitude">Longitude:</label>
                        <input type="number" id="longitude" step="any" placeholder="" required>
                    </div>
                </div>
                <button class="btn" onclick="lookupLocation()">Find Property Information</button>
                
                <!-- Sample Coordinates -->
                <div class="sample-locations-container">
                    <p class="sample-locations-title">üìç Try Sample Locations:</p>
                    
                    <!-- Washington State -->
                    <div class="state-section">
                        <button class="state-header" onclick="toggleState(this)">
                            <span class="state-name">üå≤ Washington State</span>
                            <span class="toggle-icon"></span>
                        </button>
                        <div class="state-locations">
                            <button class="location-btn-sample" onclick="loadSampleCoords(46.8523, -121.7603, 'National Park Service')">
                                <span class="location-icon">üèûÔ∏è</span>
                                <span>Mt. Rainier National Park</span>
                                <span class="location-type">Federal</span>
                            </button>
                            <button class="location-btn-sample" onclick="loadSampleCoords(48.052727359509, -121.3570518501979, 'National Forest Service')">
                                <span class="location-icon">üå≤</span>
                                <span>Mt. Baker-Snoqualmie National Forest</span>
                                <span class="location-type">Federal</span>
                            </button>
                            <button class="location-btn-sample" onclick="loadSampleCoords(47.55858371570509, -122.05892874774389, 'Washington State Parks')">
                                <span class="location-icon">üèïÔ∏è</span>
                                <span>Lake Sammamish State Park</span>
                                <span class="location-type">State</span>
                            </button>
                            <button class="location-btn-sample" onclick="loadSampleCoords(47.668265406752234, -122.1461806080578, 'City of Redmond Park')">
                                <span class="location-icon">üé°</span>
                                <span>Grass Lawn Park, Redmond</span>
                                <span class="location-type">City</span>
                            </button>
                            <button class="location-btn-sample" onclick="loadSampleCoords(47.6611, -122.1133, 'King County Park')">
                                <span class="location-icon">üå≥</span>
                                <span>Marymoor Park</span>
                                <span class="location-type">County</span>
                            </button>
                            <button class="location-btn-sample" onclick="loadSampleCoords(47.6062, -122.3321, 'Private Property - Seattle')">
                                <span class="location-icon">üè†</span>
                                <span>Private Property, Seattle</span>
                                <span class="location-type">Private</span>
                            </button>
                            <button class="location-btn-sample" onclick="loadSampleCoords(47.6611, -122.1133, 'Private Property - King County')">
                                <span class="location-icon">üèòÔ∏è</span>
                                <span>Private Property, King County</span>
                                <span class="location-type">Private</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="gpsForm" class="location-form">
                <button class="btn location-btn" onclick="getCurrentLocation()">Get My Current Location</button>
            </div>
            
            <!-- View Toggle for Results -->
            <div class="view-toggle-container" style="margin-top: 2rem;">
                <span class="view-toggle-label">Results View:</span>
                <span class="view-type-label">List</span>
                <div class="view-toggle" id="viewToggle">
                    <div class="view-toggle-slider"></div>
                </div>
                <span class="view-type-label">Tabs</span>
            </div>
        </div>
        
        <!-- Quick Navigation Bar -->
        <div id="quickNav" class="quick-nav">
            <h3>üîç Jump to Section</h3>
            <div class="quick-nav-links">
                <a href="#guidanceContent" class="quick-nav-link" id="navGuidance">
                    <span>üìã</span> What to Do
                </a>
                <a href="#relevantLawsSection" class="quick-nav-link" id="navLaws">
                    <span>‚öñÔ∏è</span> Relevant Laws
                </a>
                <a href="#parcelMapSection" class="quick-nav-link" id="navMap">
                    <span>üó∫Ô∏è</span> Map
                </a>
                <a href="#timelineSection" class="quick-nav-link" id="navTimeline">
                    <span>üìú</span> Timeline
                </a>
                <a href="#propertyInfoGrid" class="quick-nav-link" id="navProperty">
                    <span>üè†</span> Property Info
                </a>
            </div>
        </div>
        
        <div id="resultsSection" class="results-section">
            <div id="loadingIndicator" class="loading">
                Looking up property information...
            </div>
            
            <div id="propertyResults" style="display: none;">
                <div class="guidance-section">
                    <h3>What to do next:</h3>
                    
                    <!-- List View (Current View) -->
                    <div id="guidanceContent" class="list-view">
                        <!-- Guidance content will be populated here -->
                    </div>
                    
                    <!-- Tabbed View -->
                    <div id="tabbedGuidanceContent" class="tabbed-view">
                        <div class="tab-navigation" id="tabNavigation">
                            <!-- Tabs will be generated dynamically -->
                        </div>
                        <div id="tabContentContainer">
                            <!-- Tab content will be generated dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Relevant Laws Section -->
                <div id="relevantLawsSection" class="relevant-laws-section" style="display: none;">
                    <h3>‚öñÔ∏è Relevant Archaeological Laws</h3>
                    <p style="color: #666; font-size: 0.95rem; margin-bottom: 1rem;">
                        <em>This section shows state and county laws specific to your location. Federal laws are not included here. 
                        Please visit the <a href="laws.html" style="color: #3498db; font-weight: 600; text-decoration: none;">Laws page</a> for comprehensive federal and state law information.</em>
                    </p>
                    <div id="relevantLawsContent">
                        <!-- Laws will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Parcel Map Section -->
                <div id="parcelMapSection" class="parcel-map-section" style="display: none;">
                    <h3>üìç Parcel Boundary</h3>
                    <div id="parcelMap"></div>
                    <div class="map-info">
                        <strong>‚ÑπÔ∏è Map shows the property boundary.</strong> The highlighted area represents the parcel where the artifact was found.<br><br>OpenStreetMap is open data, licensed under the Open Data Commons Open Database License (ODbL) by the OpenStreetMap Foundation (OSMF). 
                    </div>
                </div>
                
                <!-- Timeline Section -->
                <div id="timelineSection" class="timeline-section" style="display: none;">
                    <h3>üìú Location History Timeline</h3>
                    <div id="timelineContent" class="timeline">
                        <!-- Timeline will be populated dynamically -->
                    </div>
                </div>
                
                <div class="property-info">
                    <h3>Property Information</h3>
                    <div class="info-grid" id="propertyInfoGrid">
                        <!-- Property info will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </section>
                    <div style="max-width: 1200px; margin: 2rem auto; padding: 0 2rem;"></div>
                        <div style="background: linear-gradient(135deg, #fff9e6, #fff3cd); border-left: 4px solid #ffc107; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
                            <div style="display: flex; align-items: start; gap: 1rem;">
                                <div style="flex: 1;">


                    <p style="margin: 0; color: #856404; line-height: 1.6;">
                        The data, including but not limited to contact information provided on this page, while public, is intended strictly for the non-profit purpose of reporting artifact discoveries and connecting finders with the appropriate contacts; respect for the privacy of those listed is mandatory. Any misuse of this information, including commercial solicitation, spamming, harassment, or any activity unrelated to the proper reporting and management of artifacts, constitutes a severe violation of this website's terms and the privacy of the individuals listed, and may result in permanent ban and/or other action under applicable law</p>
                    </p>
                </div>
                                </div>
                            </div>
                        </div>
                    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-disclaimer">
            <p style="margin: 1rem 0; font-size: 0.95rem;">
                <strong>Data Sources:</strong> To view the data sources and attributions used on this page, please visit our 
                <a href="credits.html" style="color: #3498db; text-decoration: none; font-weight: 600; border-bottom: 2px solid transparent; transition: border-color 0.3s ease;" 
                   onmouseover="this.style.borderColor='#3498db'" 
                   onmouseout="this.style.borderColor='transparent'">
                    Credits & Attributions
                </a> page.
            </p>
            <br></p>
            <p><strong>Disclaimer:</strong> We strive to provide the most accurate and up-to-date data available; however, we cannot guarantee its completeness, accuracy, or fitness for any particular purpose. This guidance is advisory only and should never be relied upon as a substitute for official legal, regulatory, or professional advice. We assume no responsibility or liability for any losses, damages, or consequences resulting directly or indirectly from the use of this information. Users assume all risk and must always verify all information with the relevant governmental or legal authorities.

</p>
            <p><br>Report data inaccuracies and/or website bugs <a href="https://forms.gle/NN3anqoQDDi9g5vD7" style="color: #3498db; text-decoration: underline; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.color='#5dade2'; this.style.textDecoration='none'" onmouseout="this.style.color='#3498db'; this.style.textDecoration='underline'">here</a>.</p>

        </div>
        <a href="#" class="admin-link" id="adminLoginBtn">Login</a>
    </footer>

    <!-- Admin Modal -->
    <div id="adminModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2>üîê Admin Panel</h2>
                <button class="close-modal" id="closeAdminModal">&times;</button>
            </div>
            
            <!-- Login Form -->
            <div id="adminLoginForm" class="admin-login-form active">
                <div class="form-group">
                    <label for="adminEmail">Email</label>
                    <input type="email" id="adminEmail" placeholder="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter password" required>
                </div>
                <button class="btn" id="loginBtn">Login</button>
            </div>
            
            <!-- Admin Panel (shown after login) -->
            <div id="adminPanelContent" class="admin-panel">
                <div class="admin-user-info">
                    <p><strong>üë§ Logged in as:</strong> <span id="userEmail"></span></p>
                    <button class="btn btn-logout" id="logoutBtn">Logout</button>
                    <br><br><p> ‚ö†Ô∏è <b> Please ensure to verify the information is accurate before you create, edit, or delete location-specific instructions.</b></p>
                </div>
                
                <!-- Search and Edit Section -->
                <div style="background: #f8f9fa; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #e0e0e0;">
                    <h3 style="margin-bottom: 1rem;">üîç Search & Edit Instructions</h3>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="searchInput">Search by Owner, Jurisdiction, or State</label>
                        <input type="text" id="searchInput" placeholder="Type to search...">
                        <small style="color: #7f8c8d;">Search across all property instructions</small>
                    </div>
                    <button type="button" class="btn" id="searchBtn" style="background: #3498db;">üîç Search</button>
                    <button type="button" class="btn" id="loadAllBtn" style="background: #95a5a6; margin-left: 0.5rem;">üìã Load All</button>
                    
                    <!-- Search Results -->
                    <div id="searchResults" style="margin-top: 1.5rem; display: none;">
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">Search Results</h4>
                        <div id="searchResultsList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <!-- Edit Form (hidden by default) -->
                <div id="editFormContainer" style="display: none; background: #fff3cd; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #ffc107;">
                    <h3 style="margin-bottom: 1rem;">‚úèÔ∏è Edit Instruction</h3>
                    <form id="editInstructionForm">
                        <input type="hidden" id="editDocId">
                        
                        <div class="form-group">
                            <label for="editOwner">Property Owner (optional)</label>
                            <input type="text" id="editOwner" placeholder="e.g., City of Redmond">
                            <small style="color: #7f8c8d;">For TIER 1 matching - specific property owner</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editCity">City (optional)</label>
                            <input type="text" id="editCity" placeholder="e.g., Philadelphia">
                            <small style="color: #7f8c8d;">For TIER 2 matching - city-wide guidance (leave Owner & Jurisdiction blank for city-only entries)</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editJurisdiction">Jurisdiction/County (optional)</label>
                            <input type="text" id="editJurisdiction" placeholder="e.g., King">
                            <small style="color: #7f8c8d;">For TIER 3 matching - county or jurisdiction name (leave Owner & City blank for county-only entries)</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editState">State Abbreviation(s) (optional)</label>
                            <input type="text" id="editState" placeholder="e.g., WA or WA, OR, CA" style="text-transform: uppercase;">
                            <small style="color: #7f8c8d;">For TIER 4 matching - state-wide fallback. Use commas for multiple states (e.g., WA, OR, CA). Leave Owner, City & Jurisdiction blank for state-only entries.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editKeywords">Keywords (comma-separated)</label>
                            <input type="text" id="editKeywords" placeholder="e.g., redmond, city of redmond">
                            <small style="color: #7f8c8d;">Keywords to match against owner/jurisdiction</small>
                            <div id="editKeywordPreview" class="keyword-list"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSpecialInstructions">Special Instructions</label>
                            <textarea id="editSpecialInstructions" placeholder="Enter special instructions (optional)" rows="3"></textarea>
                        </div>
                        
                        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                        
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìû Contacts</h4>
                        <div id="editContactsList"></div>
                        <button type="button" class="btn" id="editAddContactBtn" style="background: #27ae60; margin-bottom: 1rem;">‚ûï Add Contact</button>
                        
                        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                        
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìù General Instructions</h4>
                        <div class="form-group">
                            <label for="editGeneralNotes">General Notes & Instructions (optional)</label>
                            <textarea id="editGeneralNotes" placeholder="Enter any general instructions..." rows="4"></textarea>
                        </div>
                        
                        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                        
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">‚öñÔ∏è Applicable Laws</h4>
                        <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Select which laws apply to this location. If no laws are selected, the laws section will be hidden for this instruction.</p>
                        <button type="button" class="btn" id="editLoadLawsBtn" style="background: #9b59b6; margin-bottom: 1rem;">üìú Load Available Laws</button>
                        <div id="editLawsSelection" style="display: none; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <!-- Laws checkboxes will be loaded here -->
                        </div>
                        <div id="editSelectedLawsPreview" style="margin-top: 1rem;"></div>
                        
                        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                        
                        <button type="submit" class="btn" style="background: #f39c12;">üíæ Update Instruction</button>
                        <button type="button" class="btn" id="cancelEditBtn" style="background: #95a5a6; margin-left: 0.5rem;">‚ùå Cancel</button>
                        <button type="button" class="btn" id="deleteBtn" style="background: #e74c3c; float: right;">üóëÔ∏è Delete</button>
                    </form>
                </div>
                
                <h3>Add New Property Instructions</h3>
                <p style="color: #666; margin-bottom: 1.5rem; font-size: 0.95rem;">
                    <strong>Note:</strong> Provide at least one of Owner, City, Jurisdiction, or State. 
                    For state-wide entries (e.g., State Archaeologist), fill in State(s) and leave Owner/City/Jurisdiction blank. For multi-state coverage, use commas (e.g., WA, OR, CA).
                </p>
                <form id="addInstructionForm">
                    <div class="form-group">
                        <label for="instructionOwner">Property Owner (optional)</label>
                        <input type="text" id="instructionOwner" placeholder="e.g., City of Redmond">
                        <small style="color: #7f8c8d;">For TIER 1 matching - specific property owner</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionCity">City (optional)</label>
                        <input type="text" id="instructionCity" placeholder="e.g., Philadelphia">
                        <small style="color: #7f8c8d;">For TIER 2 matching - city-wide guidance (leave Owner & Jurisdiction blank for city-only entries)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionJurisdiction">Jurisdiction/County (optional)</label>
                        <input type="text" id="instructionJurisdiction" placeholder="e.g., King">
                        <small style="color: #7f8c8d;">For TIER 3 matching - county or jurisdiction name (leave Owner & City blank for county-only entries)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionState">State Abbreviation(s) (optional)</label>
                        <input type="text" id="instructionState" placeholder="e.g., WA or WA, OR, CA" style="text-transform: uppercase;">
                        <small style="color: #7f8c8d;">For TIER 4 matching - state-wide fallback (e.g., State Archaeologist). Use commas for multiple states. Leave Owner, City & Jurisdiction blank for state-only entries.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionKeywords">Keywords (comma-separated)</label>
                        <input type="text" id="instructionKeywords" placeholder="e.g., redmond, city of redmond, redmond city">
                        <small style="color: #7f8c8d;">Keywords to match against owner/jurisdiction</small>
                        <div id="keywordPreview" class="keyword-list"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionSpecialInstructions">Special Instructions</label>
                        <textarea id="instructionSpecialInstructions" placeholder="Enter special instructions (optional)" rows="3"></textarea>
                        <small style="color: #7f8c8d;">Any additional guidance or warnings</small>
                    </div>
                    
                    <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                    
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìû Contacts</h4>
                    <small style="color: #7f8c8d; display: block; margin-bottom: 1rem;">Add one or more contacts for this property</small>
                    <div id="contactsList">
                        <!-- Contacts will be added here dynamically -->
                    </div>
                    
                    <button type="button" class="btn" id="addContactBtn" style="background: #27ae60; margin-bottom: 1rem;">
                        ‚ûï Add Contact
                    </button>
                    
                    <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                    
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">‚öñÔ∏è Applicable Laws</h4>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">Select which laws apply to this location. If no laws are selected, the laws section will be hidden for this instruction.</p>
                    <button type="button" class="btn" id="loadLawsBtn" style="background: #9b59b6; margin-bottom: 1rem;">üìú Load Available Laws</button>
                    <div id="lawsSelection" style="display: none; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 8px; border: 1px solid #e0e0e0;">
                        <!-- Laws checkboxes will be loaded here -->
                    </div>
                    <div id="selectedLawsPreview" style="margin-top: 1rem;"></div>
                    
                    <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                    
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìù General Instructions</h4>
                    <div class="form-group">
                        <label for="instructionGeneralNotes">General Notes & Instructions (optional)</label>
                        <textarea id="instructionGeneralNotes" placeholder="Enter any general instructions, procedures, or important information not specific to contacts..." rows="4"></textarea>
                        <small style="color: #7f8c8d;">Additional guidance, procedures, legal requirements, or general information for this property</small>
                    </div>
                    
                    <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                    
                    <button type="submit" class="btn">üíæ Save Instruction</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCCYpXOczp5nRRP1S2Gdb1ADjIAHeJQVq0",
            authDomain: "owlcheologists.firebaseapp.com",
            projectId: "owlcheologists",
            storageBucket: "owlcheologists.firebasestorage.app",
            messagingSenderId: "323297596743",
            appId: "1:323297596743:web:c9455e40779b7c09522862",
            measurementId: "G-2CFYWTQCQ4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ============== VIEW TOGGLE FUNCTIONALITY ==============
        let currentView = 'list'; // 'list' or 'tabbed'
        let currentGuidanceData = null;
        
        document.getElementById('viewToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            
            const listView = document.getElementById('guidanceContent');
            const tabbedView = document.getElementById('tabbedGuidanceContent');
            const quickNav = document.getElementById('quickNav');
            const lawsSection = document.getElementById('relevantLawsSection');
            const mapSection = document.getElementById('parcelMapSection');
            const timelineSection = document.getElementById('timelineSection');
            const propertyInfo = document.getElementById('propertyInfoGrid').parentElement;
            
            if (currentView === 'list') {
                currentView = 'tabbed';
                listView.classList.add('inactive');
                tabbedView.classList.add('active');
                
                // Hide quick navigation in tabbed view
                if (quickNav) {
                    quickNav.style.display = 'none';
                }
                
                // Generate tabbed view FIRST (before hiding sections)
                if (currentGuidanceData) {
                    generateTabbedView(currentGuidanceData);
                }
                
                // Then hide all standalone sections in tabbed view
                if (lawsSection) lawsSection.style.display = 'none';
                if (mapSection) mapSection.style.display = 'none';
                if (timelineSection) timelineSection.style.display = 'none';
                if (propertyInfo) propertyInfo.style.display = 'none';
            } else {
                currentView = 'list';
                listView.classList.remove('inactive');
                tabbedView.classList.remove('active');
                
                // Show quick navigation in list view (if it was previously active)
                if (quickNav && quickNav.classList.contains('active')) {
                    quickNav.style.display = 'block';
                }
                
                // Restore standalone sections visibility in list view
                if (lawsSection && lawsSection.dataset.wasVisible === 'true') {
                    lawsSection.style.display = 'block';
                }
                if (mapSection && mapSection.dataset.wasVisible === 'true') {
                    mapSection.style.display = 'block';
                }
                if (timelineSection && timelineSection.dataset.wasVisible === 'true') {
                    timelineSection.style.display = 'block';
                }
                if (propertyInfo && propertyInfo.dataset.wasVisible === 'true') {
                    propertyInfo.style.display = 'block';
                }
            }
        });
        
        function generateTabbedView(data) {
            const tabNavigation = document.getElementById('tabNavigation');
            const tabContentContainer = document.getElementById('tabContentContainer');
            
            // Clear existing content
            tabNavigation.innerHTML = '';
            tabContentContainer.innerHTML = '';
            
            // Get content from all sections to match quick nav structure
            const guidanceContent = document.getElementById('guidanceContent').innerHTML;
            const lawsSection = document.getElementById('relevantLawsSection');
            const mapSection = document.getElementById('parcelMapSection');
            const timelineSection = document.getElementById('timelineSection');
            const propertyInfo = document.getElementById('propertyInfoGrid').parentElement;
            
            // Store visibility state before checking
            if (lawsSection && lawsSection.style.display !== 'none') {
                lawsSection.dataset.wasVisible = 'true';
            }
            if (mapSection && mapSection.style.display !== 'none') {
                mapSection.dataset.wasVisible = 'true';
            }
            if (timelineSection && timelineSection.style.display !== 'none') {
                timelineSection.dataset.wasVisible = 'true';
            }
            if (propertyInfo && propertyInfo.style.display !== 'none') {
                propertyInfo.dataset.wasVisible = 'true';
            }
            
            // Create tabs matching quick nav sections
            const sections = [
                { 
                    id: 'tabWhatToDo', 
                    title: '\ud83d\udccb What to Do', 
                    content: guidanceContent,
                    available: true
                },
                { 
                    id: 'tabLaws', 
                    title: '\u2696\ufe0f Relevant Laws', 
                    content: lawsSection ? lawsSection.innerHTML : null,
                    available: lawsSection && lawsSection.style.display !== 'none'
                },
                { 
                    id: 'tabMap', 
                    title: '\ud83d\uddfa\ufe0f Map', 
                    content: mapSection ? mapSection.innerHTML : null,
                    available: mapSection && mapSection.style.display !== 'none'
                },
                { 
                    id: 'tabTimeline', 
                    title: '\ud83d\udcdc Timeline', 
                    content: timelineSection ? timelineSection.innerHTML : null,
                    available: timelineSection && timelineSection.style.display !== 'none'
                },
                { 
                    id: 'tabProperty', 
                    title: '\ud83c\udfe0 Property Info', 
                    content: propertyInfo ? propertyInfo.innerHTML : null,
                    available: true
                }
            ];
            
            let firstTab = true;
            sections.forEach((section) => {
                if (section.content && section.available) {
                    // Create tab button
                    const tabButton = document.createElement('button');
                    tabButton.className = 'tab-button' + (firstTab ? ' active' : '');
                    tabButton.textContent = section.title;
                    tabButton.onclick = () => switchTab(section.id);
                    tabNavigation.appendChild(tabButton);
                    
                    // Create tab content
                    const tabContent = document.createElement('div');
                    tabContent.id = section.id;
                    tabContent.className = 'tab-content' + (firstTab ? ' active' : '');
                    tabContent.innerHTML = `<div class="tab-panel">${section.content}</div>`;
                    tabContentContainer.appendChild(tabContent);
                    
                    firstTab = false;
                }
            });
        }
        
        function switchTab(tabId) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // ============== ADMIN AUTHENTICATION & PERMISSIONS ==============
        let currentUser = null;
        let userPermissions = {
            laws: true,
            deletion: true,
            found: true
        };

        /* PERMISSIONS SYSTEM:
         * To restrict user access, create a document in Firebase:
         * Collection: config
         * Document ID: user's email (e.g., user@example.com)
         * Fields:
         *   - laws: false (blocks access to Laws admin panel)
         *   - deletion: false (prevents deleting laws, resources, and artifact instructions)
         *   - found: false (hides "I Found an Artifact" page link and restricts access)
         *   - edu: false (prevents adding/editing educational resources)
         * 
         * If no config document exists for a user, all permissions default to true.
         */

        // Load user permissions from Firebase
        async function loadUserPermissions(email) {
            try {
                const configRef = doc(db, 'config', email);
                const configSnap = await getDoc(configRef);
                
                if (configSnap.exists()) {
                    const permData = configSnap.data();
                    userPermissions = {
                        laws: permData.laws !== false,
                        deletion: permData.deletion !== false,
                        found: permData.found !== false
                    };
                    console.log('User permissions loaded:', userPermissions);
                } else {
                    // Default permissions if no config exists
                    userPermissions = { laws: true, deletion: true, found: true };
                    console.log('No permission config found, using defaults:', userPermissions);
                }
                
                applyPermissions();
            } catch (error) {
                console.error('Error loading permissions:', error);
                // Default to all permissions on error
                userPermissions = { laws: true, deletion: true, found: true };
                applyPermissions();
            }
        }

        // Apply permissions to UI
        function applyPermissions() {
            // Hide/disable Laws link
            const lawsLinks = document.querySelectorAll('a[href="laws.html"]');
            lawsLinks.forEach(link => {
                if (!userPermissions.laws) {
                    link.style.display = 'none';
                } else {
                    link.style.display = '';
                }
            });

            // Hide/disable Delete button
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) {
                if (!userPermissions.deletion) {
                    deleteBtn.style.display = 'none';
                } else {
                    deleteBtn.style.display = '';
                }
            }

            // Hide "I Found an Artifact" navigation links if found: false
            // Users can still access the page directly, but can't use admin panel
            if (!userPermissions.found) {
                const foundLinks = document.querySelectorAll('a[href="artifactHelp.html"]');
                foundLinks.forEach(link => {
                    link.style.display = 'none';
                });
            }
        }

        // Check auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log('User logged in:', user.email);
                await loadUserPermissions(user.email);
                
                // Check if user has found permission
                if (!userPermissions.found) {
                    console.log('User does not have found permission');
                    alert('‚õî You do not have permission to access the admin panel for artifact instructions.\n\nContact your administrator to request access.');
                    // Sign out the user
                    await signOut(auth);
                    showLoginForm();
                    return;
                }
                
                showAdminPanel(user);
            } else {
                currentUser = null;
                console.log('User logged out');
                // Reset to default permissions when logged out
                userPermissions = { laws: true, deletion: true, found: true };
                applyPermissions();
                showLoginForm();
            }
        });

        // Admin modal controls
        document.getElementById('adminLoginBtn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Check if user has permission to access admin panel
            if (currentUser && !userPermissions.found) {
                alert('‚õî You do not have permission to access the admin panel for artifact instructions.\n\nContact your administrator to request access.');
                return;
            }
            
            document.getElementById('adminModal').classList.add('active');
        });

        document.getElementById('closeAdminModal').addEventListener('click', function() {
            document.getElementById('adminModal').classList.remove('active');
        });

        // Close modal when clicking outside
        document.getElementById('adminModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });

        // Login functionality
        document.getElementById('loginBtn').addEventListener('click', async function() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Login successful:', userCredential.user.email);
                // onAuthStateChanged will handle UI update
            } catch (error) {
                console.error('Login error:', error);
                alert(`Login failed: ${error.message}`);
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await signOut(auth);
                console.log('Logout successful');
                // onAuthStateChanged will handle UI update
            } catch (error) {
                console.error('Logout error:', error);
                alert(`Logout failed: ${error.message}`);
            }
        });

        // Show login form
        function showLoginForm() {
            document.getElementById('adminLoginForm').classList.add('active');
            document.getElementById('adminPanelContent').classList.remove('active');
        }

        // Show admin panel
        function showAdminPanel(user) {
            document.getElementById('adminLoginForm').classList.remove('active');
            document.getElementById('adminPanelContent').classList.add('active');
            document.getElementById('userEmail').textContent = user.email;
            
            // Add first contact field automatically if no contacts exist
            if (document.getElementById('contactsList').children.length === 0) {
                addContactField();
            }
        }

        // ============== CONTACT MANAGEMENT ==============
        let contactCounter = 0;
        
        function addContactField() {
            contactCounter++;
            const contactsList = document.getElementById('contactsList');
            
            const contactItem = document.createElement('div');
            contactItem.className = 'contact-item';
            contactItem.dataset.contactId = contactCounter;
            
            contactItem.innerHTML = `
                <div class="contact-item-header">
                    <h5>Contact ${contactCounter}</h5>
                    <button type="button" class="remove-contact-btn" onclick="removeContact(${contactCounter})">
                        üóëÔ∏è Remove
                    </button>
                </div>
                <div class="contact-fields">
                    <div class="form-group">
                        <label>Contact Name *</label>
                        <input type="text" class="contact-name" placeholder="e.g., John Smith" required>
                    </div>
                    <div class="form-group">
                        <label>Role/Title</label>
                        <input type="text" class="contact-role" placeholder="e.g., County Archaeologist">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="contact-email" placeholder="e.g., contact@example.com">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" class="contact-phone" placeholder="e.g., (555) 123-4567">
                    </div>
                    <div class="form-group full-width">
                        <label>Physical Address</label>
                        <input type="text" class="contact-address" placeholder="e.g., 123 Main St, City, State ZIP">
                    </div>
                    <div class="form-group full-width">
                        <label>Special Instructions</label>
                        <textarea class="contact-instructions" placeholder="e.g., Call between 9 AM - 5 PM" rows="2"></textarea>
                    </div>
                </div>
            `;
            
            contactsList.appendChild(contactItem);
        }
        
        window.removeContact = function(contactId) {
            const contactItem = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (contactItem) {
                contactItem.remove();
            }
        };
        
        function getContactsData() {
            const contacts = [];
            const contactItems = document.querySelectorAll('.contact-item');
            
            contactItems.forEach((item) => {
                const name = item.querySelector('.contact-name').value.trim();
                const role = item.querySelector('.contact-role').value.trim();
                const email = item.querySelector('.contact-email').value.trim();
                const phone = item.querySelector('.contact-phone').value.trim();
                const address = item.querySelector('.contact-address').value.trim();
                const instructions = item.querySelector('.contact-instructions').value.trim();
                
                if (name) { // Only add if name is provided
                    contacts.push({
                        name: name,
                        role: role || '',
                        email: email || '',
                        phone: phone || '',
                        address: address || '',
                        specialInstructions: instructions || ''
                    });
                }
            });
            
            return contacts;
        }
        // ============== END CONTACT MANAGEMENT ==============

        // Initialize admin panel event listeners (called after DOM is ready)
        function initializeAdminEventListeners() {
            console.log('üîß Initializing admin event listeners...');
            
            // Auto-uppercase state abbreviation input
            const stateInput = document.getElementById('instructionState');
            if (stateInput) {
                stateInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase();
                });
                console.log('‚úì State input listener attached');
            } else {
                console.error('‚ùå instructionState element not found');
            }

            // Keyword preview
            const keywordsInput = document.getElementById('instructionKeywords');
            if (keywordsInput) {
                keywordsInput.addEventListener('input', function() {
                    const keywords = this.value.split(',').map(k => k.trim()).filter(k => k);
                    const preview = document.getElementById('keywordPreview');
                    preview.innerHTML = keywords.map(keyword => 
                        `<span class="keyword-tag">${keyword}</span>`
                    ).join('');
                });
                console.log('‚úì Keywords input listener attached');
            } else {
                console.error('‚ùå instructionKeywords element not found');
            }

            // Add contact button handler
            const addContactBtn = document.getElementById('addContactBtn');
            if (addContactBtn) {
                addContactBtn.addEventListener('click', function() {
                    console.log('Add contact clicked');
                    addContactField();
                });
                console.log('‚úì Add contact button listener attached');
            } else {
                console.error('‚ùå addContactBtn element not found');
            }

            // Add instruction form submission
            const form = document.getElementById('addInstructionForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    console.log('üöÄ Form submit event triggered!');
                    e.preventDefault();

                    if (!currentUser) {
                        alert('You must be logged in to add instructions');
                        return;
                    }

                    // Check found permission
                    if (!userPermissions.found) {
                        alert('‚õî You do not have permission to add artifact instructions.\n\nContact your administrator to request access.');
                        return;
                    }

                    console.log('User authenticated:', currentUser.email);

                    const owner = document.getElementById('instructionOwner').value.trim();
                    const city = document.getElementById('instructionCity').value.trim();
                    const jurisdiction = document.getElementById('instructionJurisdiction').value.trim();
                    const state = document.getElementById('instructionState').value.trim().toUpperCase();
                    const keywordsInput = document.getElementById('instructionKeywords').value.trim();
                    const specialInstructions = document.getElementById('instructionSpecialInstructions').value.trim();
                    const generalNotes = document.getElementById('instructionGeneralNotes').value.trim();

                    console.log('Form values:', { owner, city, jurisdiction, state, keywordsInput, specialInstructions, generalNotes });

                    // Validation: Require at least owner, city, jurisdiction, OR state
                    if (!owner && !city && !jurisdiction && !state) {
                        alert('Please provide at least one of: Owner, City, Jurisdiction, or State');
                        return;
                    }

                    // Get contacts data
                    const contacts = getContactsData();
                    console.log('Contacts:', contacts);
                    
                    if (contacts.length === 0) {
                        alert('Please add at least one contact');
                        return;
                    }

                    // Parse keywords
                    const keywords = keywordsInput.split(',')
                        .map(k => k.trim().toLowerCase())
                        .filter(k => k);

                    console.log('Generating HTML content...');
                    // Get selected laws
                    const selectedLaws = getSelectedLawIds('lawsSelection');
                    console.log('Selected laws:', selectedLaws);
                    
                    const probability = document.getElementById('probability').value.trim();
                    // Generate HTML content from contacts
                    const htmlContent = generateHTMLFromContacts(contacts, selectedLaws, probability, specialInstructions, generalNotes);

                    // Create instruction document
                    const instructionData = {
                        htmlContent: htmlContent,
                        keywords: keywords,
                        contacts: contacts,
                        specialInstructions: specialInstructions,
                        generalNotes: generalNotes,
                        selectedLaws: selectedLaws,
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.email
                    };

                    // Add optional fields
                    if (owner) instructionData.owner = owner;
                    if (city) instructionData.city = city;
                    if (jurisdiction) instructionData.jurisdiction = jurisdiction;
                    if (state) instructionData.state = state;

                    console.log('Saving to Firebase...', instructionData);

                    try {
                        // Generate a unique ID
                        const docId = `instruction_${Date.now()}`;
                        await setDoc(doc(db, 'artifactInstructions', docId), instructionData);
                        
                        console.log('‚úÖ Saved successfully!');
                        alert('‚úÖ Instruction added successfully!');
                        
                        // Reset form
                        document.getElementById('addInstructionForm').reset();
                        document.getElementById('keywordPreview').innerHTML = '';
                        document.getElementById('contactsList').innerHTML = '';
                        document.getElementById('lawsSelection').style.display = 'none';
                        document.getElementById('lawsSelection').innerHTML = '';
                        document.getElementById('selectedLawsPreview').innerHTML = '';
                        contactCounter = 0;
                        
                        console.log('Instruction added:', docId, instructionData);
                    } catch (error) {
                        console.error('‚ùå Error adding instruction:', error);
                        alert(`Failed to add instruction: ${error.message}`);
                    }
                });
                console.log('‚úì Form submit listener attached');
            } else {
                console.error('‚ùå addInstructionForm element not found');
            }
            
            // Search button
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    searchInstructions(searchTerm);
                });
                console.log('‚úì Search button listener attached');
            }
            
            // Load all button
            const loadAllBtn = document.getElementById('loadAllBtn');
            if (loadAllBtn) {
                loadAllBtn.addEventListener('click', function() {
                    searchInstructions('');
                });
                console.log('‚úì Load all button listener attached');
            }
            
            // Search input enter key
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchInstructions(this.value.trim());
                    }
                });
                console.log('‚úì Search input listener attached');
            }
            
            // Edit form submit
            const editForm = document.getElementById('editInstructionForm');
            if (editForm) {
                editForm.addEventListener('submit', updateInstruction);
                console.log('‚úì Edit form listener attached');
            }
            
            // Edit keyword preview
            const editKeywordsInput = document.getElementById('editKeywords');
            if (editKeywordsInput) {
                editKeywordsInput.addEventListener('input', function() {
                    const keywords = this.value.split(',').map(k => k.trim()).filter(k => k);
                    const preview = document.getElementById('editKeywordPreview');
                    preview.innerHTML = keywords.map(keyword => 
                        `<span class="keyword-tag">${keyword}</span>`
                    ).join('');
                });
                console.log('‚úì Edit keywords input listener attached');
            }
            
            // Edit state auto-uppercase
            const editStateInput = document.getElementById('editState');
            if (editStateInput) {
                editStateInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase();
                });
                console.log('‚úì Edit state input listener attached');
            }
            
            // Edit add contact button
            const editAddContactBtn = document.getElementById('editAddContactBtn');
            if (editAddContactBtn) {
                editAddContactBtn.addEventListener('click', function() {
                    addEditContactField();
                });
                console.log('‚úì Edit add contact button listener attached');
            }
            
            // Cancel edit button
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', cancelEdit);
                console.log('‚úì Cancel edit button listener attached');
            }
            
            // Delete button
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', deleteInstruction);
                console.log('‚úì Delete button listener attached');
            }
            
            // Load Laws button for Add form
            const loadLawsBtn = document.getElementById('loadLawsBtn');
            if (loadLawsBtn) {
                loadLawsBtn.addEventListener('click', function() {
                    loadAvailableLaws('lawsSelection', 'selectedLawsPreview');
                });
                console.log('‚úì Load laws button listener attached');
            }
            
            // Load Laws button for Edit form
            const editLoadLawsBtn = document.getElementById('editLoadLawsBtn');
            if (editLoadLawsBtn) {
                editLoadLawsBtn.addEventListener('click', function() {
                    loadAvailableLaws('editLawsSelection', 'editSelectedLawsPreview');
                });
                console.log('‚úì Edit load laws button listener attached');
            }
            
            console.log('‚úÖ Admin event listeners initialization complete');
        }

        // Generate HTML content from contacts
        function generateHTMLFromContacts(contacts, selectedLaws, probability, specialInstructions, generalNotes) {
            let html = '<div class="emergency-note">\n';
            html += '    <strong>‚ö†Ô∏è STOP! Do not disturb the artifact or the surrounding area.</strong>\n';
            html += '</div>\n\n';
            
            if (specialInstructions) {
                html += '<div class="contact-card" style="background: #fff3cd; border-color: #ffeaa7;">\n';
                html += '    <h4>‚ö†Ô∏è Special Instructions</h4>\n';
                html += `    <div class="contact-info"><p>${specialInstructions.replace(/\n/g, '<br>')}</p></div>\n`;
                html += '</div>\n\n';
            }
            
            contacts.forEach((contact, index) => {
                html += '<div class="contact-card">\n';
                html += `    <h4>üìû Contact ${index + 1}: ${contact.name}</h4>\n`;
                html += '    <div class="contact-info">\n';
                
                if (contact.role) {
                    html += `        <p><strong>Role:</strong> ${contact.role}</p>\n`;
                }
                if (contact.email) {
                    html += `        <p><strong>Email:</strong> <a href="mailto:${contact.email}">${contact.email}</a></p>\n`;
                }
                if (contact.phone) {
                    html += `        <p><strong>Phone:</strong> <a href="tel:${contact.phone}">${contact.phone}</a></p>\n`;
                }
                if (contact.address) {
                    html += `        <p><strong>Address:</strong> ${contact.address}</p>\n`;
                }
                if (contact.specialInstructions) {
                    html += `        <p><strong>Instructions:</strong> ${contact.specialInstructions}</p>\n`;
                }
                
                html += '    </div>\n';
                html += '</div>\n\n';
            });
            
            // Add artifact likelihood indicator if provided
            if (probability && probability.trim()) {
                const levels = {
                    low: { emoji: 'üü¢', label: 'Low', desc: 'Few known archaeological findings in this area', bg: '#d4edda', border: '#c3e6cb' },
                    moderate: { emoji: 'üü°', label: 'Moderate', desc: 'Some historical or archaeological activity nearby', bg: '#fff3cd', border: '#ffeaa7' },
                    elevated: { emoji: 'üü†', label: 'Elevated', desc: 'Area with documented archaeological sensitivity', bg: '#ffe5cc', border: '#ffcc99' },
                    high: { emoji: 'üî¥', label: 'High', desc: 'Area known for significant archaeological presence', bg: '#f8d7da', border: '#f5c6cb' }
                };
                
                const level = levels[probability.toLowerCase()];
                if (level) {
                    html += `<div class="contact-card" style="background: ${level.bg}; border-color: ${level.border}; border-width: 2px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">\n`;
                    html += '    <h4 style="margin-bottom: 1rem; font-size: 1.1rem;">Artifact Likelihood Indicator</h4>\n';
                    html += `    <div style="text-align: center; padding: 1rem 0; border-bottom: 2px solid ${level.border}; margin-bottom: 1rem;">\n`;
                    html += `        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${level.emoji}</div>\n`;
                    html += `        <div style="font-size: 1.3rem; font-weight: 700; color: #2c3e50;">${level.label}</div>\n`;
                    html += '    </div>\n';
                    html += `    <p style="color: #2c3e50; line-height: 1.6; margin-bottom: 1rem;">${level.desc}</p>\n`;
                    html += '    <p style="color: #2c3e50; line-height: 1.6; margin-bottom: 1rem;">Please follow guidance below and contact authorities before taking action.</p>\n';
                    html += '    <p style="color: #666; font-size: 0.9rem; font-style: italic; margin-bottom: 1rem;">‚ÑπÔ∏è <strong>This is an educational estimate, not a confirmation.</strong></p>\n';
                    html += '    <details style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.5); border-radius: 8px;">\n';
                    html += '        <summary style="cursor: pointer; font-weight: 600; color: #2c3e50; user-select: none;">‚ÑπÔ∏è How is this calculated?</summary>\n';
                    html += '        <div style="margin-top: 1rem; color: #555; line-height: 1.6; font-size: 0.95rem;">\n';
                    html += '            <p style="margin-bottom: 0.5rem;"><strong>How this estimate works:</strong></p>\n';
                    html += '            <p style="margin-bottom: 0.5rem;">This indicator is based on publicly available historical and archaeological records, land use history, and proximity to documented sites.</p>\n';
                    html += '            <p style="margin: 0;"><strong>It does not confirm whether an item is an artifact.</strong></p>\n';
                    html += '        </div>\n';
                    html += '    </details>\n';
                    html += '</div>\n\n';
                }
            }
            
            html += '<h4>Immediate Steps to Take:</h4>\n';
            html += '<ol style="margin: 1rem 0; padding-left: 2rem; line-height: 1.8;">\n';
            html += '    <li><strong>Stop all work</strong> in the immediate area</li>\n';
            html += '    <li><strong>Do not touch or move</strong> the artifact</li>\n';
            html += '    <li><strong>Contact the above authority</strong> immediately</li>\n';
            html += '    <li><strong>Mark the location</strong> with flags or cones if available</li>\n';
            html += '    <li><strong>Take photos</strong> of the artifact in place (do not disturb)</li>\n';
            html += '    <li><strong>Record GPS coordinates</strong> of the exact location</li>\n';
            html += '    <li><strong>Secure the area</strong> to prevent disturbance by others</li>\n';
            html += '    <li><strong>Document everything</strong> - date, time, weather, surrounding features</li>\n';
            html += '</ol>\n';
            
            if (generalNotes) {
                html += '\n<div class="contact-card" style="background: #e3f2fd; border-color: #90caf9;">\n';
                html += '    <h4>üìã Additional Information</h4>\n';
                html += `    <div class="contact-info">\n`;
                html += `        <p>${generalNotes.replace(/\n/g, '<br>')}</p>\n`;
                html += '    </div>\n';
                html += '</div>\n';
            }
            
            return html;
        }

        // ============== LAW SELECTION FUNCTIONS ==============
        // Load available laws for admin to select
        async function loadAvailableLaws(containerId, previewId) {
            const container = document.getElementById(containerId);
            const preview = document.getElementById(previewId);
            
            if (!container) {
                console.error('Laws container not found:', containerId);
                return;
            }
            
            try {
                // Show loading
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Loading laws...</p>';
                container.style.display = 'block';
                
                // Fetch all laws from database
                const lawsRef = collection(db, 'archaeologyLaws');
                const lawsSnapshot = await getDocs(lawsRef);
                
                if (lawsSnapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No laws found in database</p>';
                    return;
                }
                
                const laws = [];
                lawsSnapshot.forEach((doc) => {
                    laws.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort laws by type and state
                laws.sort((a, b) => {
                    const typeOrder = { federal: 1, state: 2, county: 3, local: 4 };
                    const aType = typeOrder[a.type] || 99;
                    const bType = typeOrder[b.type] || 99;
                    if (aType !== bType) return aType - bType;
                    return (a.state || '').localeCompare(b.state || '');
                });
                
                // Get currently selected laws if editing
                const currentlySelected = window.tempSelectedLaws || getSelectedLawIds(containerId);
                
                // Generate checkboxes
                let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                laws.forEach((law) => {
                    const title = law.title || law.name || 'Untitled Law';
                    const type = law.type || 'unknown';
                    const state = law.state ? ` - ${law.state}` : '';
                    const county = law.county ? ` (${law.county} County)` : '';
                    const isChecked = currentlySelected.includes(law.id) ? 'checked' : '';
                    
                    html += `
                        <label style="display: flex; align-items: start; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e0e0e0; cursor: pointer; transition: all 0.2s ease;">
                            <input type="checkbox" 
                                   value="${law.id}" 
                                   ${isChecked}
                                   onchange="updateLawSelection('${containerId}', '${previewId}')"
                                   style="margin-top: 0.25rem; cursor: pointer;">
                            <span style="flex: 1;">
                                <span class="law-type ${type}" style="display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem;">${type.toUpperCase()}</span>
                                <strong>${title}</strong>${state}${county}
                            </span>
                        </label>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
                
                // Update preview
                updateLawSelection(containerId, previewId);
                
            } catch (error) {
                console.error('Error loading laws:', error);
                container.innerHTML = `<p style="text-align: center; color: #e74c3c;">Error loading laws: ${error.message}</p>`;
            }
        }
        
        // Update law selection preview
        window.updateLawSelection = function(containerId, previewId) {
            const container = document.getElementById(containerId);
            const preview = document.getElementById(previewId);
            
            if (!container || !preview) return;
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            const count = checkboxes.length;
            
            if (count === 0) {
                preview.innerHTML = '<p style="color: #7f8c8d; font-size: 0.9rem;"><em>No laws selected - the laws section will be hidden for this instruction</em></p>';
            } else {
                preview.innerHTML = `<p style="color: #27ae60; font-weight: 600; font-size: 0.9rem;">‚úì ${count} law${count === 1 ? '' : 's'} selected</p>`;
            }
        };
        
        // Get selected law IDs from a container
        function getSelectedLawIds(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        // ============== END LAW SELECTION FUNCTIONS ==============

        // ============== SEARCH AND EDIT FUNCTIONS ==============
        let editContactCounter = 0;
        let currentEditDocId = null;

        // Search for instructions
// Search for instructions
async function searchInstructions(searchTerm = '') {
    try {
        const instructionsRef = collection(db, 'artifactInstructions');
        const snapshot = await getDocs(instructionsRef);
        
        let results = [];
        snapshot.forEach((doc) => {
            const data = doc.data();
            const docId = doc.id;
            
            if (!searchTerm) {
                // Load all if no search term
                results.push({ id: docId, ...data });
                return;
            }
            
            const term = searchTerm.toLowerCase().trim();
            
            // Check if searching by document ID (exact match)
            if (docId.toLowerCase() === term) {
                results.push({ id: docId, ...data });
                return;
            }
            
            // Check if document ID starts with search term (partial match)
            if (docId.toLowerCase().startsWith(term)) {
                results.push({ id: docId, ...data });
                return;
            }
            
            // Otherwise search in other fields
            const owner = (data.owner || '').toLowerCase();
            const jurisdiction = (data.jurisdiction || '').toLowerCase();
            const state = (data.state || '').toLowerCase();
            const keywords = (data.keywords || []).map(k => k.toLowerCase());
            
            if (owner.includes(term) || 
                jurisdiction.includes(term) || 
                state.includes(term) ||
                keywords.some(k => k.includes(term))) {
                results.push({ id: docId, ...data });
            }
        });
        
        displaySearchResults(results);
    } catch (error) {
        console.error('Error searching instructions:', error);
        alert('Failed to search instructions: ' + error.message);
    }
}
        // Display search results
        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            const resultsList = document.getElementById('searchResultsList');
            
            if (results.length === 0) {
                resultsList.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 2rem;">No results found</p>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                const owner = result.owner || 'N/A';
                const city = result.city || 'N/A';
                const jurisdiction = result.jurisdiction || 'N/A';
                const state = result.state || 'N/A';
                const contactCount = result.contacts ? result.contacts.length : 0;
                
                html += `
                    <div style="background: white; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; border: 1px solid #e0e0e0; cursor: pointer; transition: all 0.3s ease;"
                         onmouseover="this.style.borderColor='#3498db'; this.style.boxShadow='0 2px 8px rgba(52,152,219,0.2)'"
                         onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"
                         onclick="loadInstructionForEdit('${result.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: #2c3e50;">Owner:</strong> ${owner}<br>
                                <strong style="color: #2c3e50;">City:</strong> ${city}<br>
                                <strong style="color: #2c3e50;">Jurisdiction:</strong> ${jurisdiction}<br>
                                <strong style="color: #2c3e50;">State:</strong> ${state}<br>
                                <small style="color: #7f8c8d;">${contactCount} contact(s) ‚Ä¢ Created ${new Date(result.createdAt).toLocaleDateString()}</small>
                            </div>
                            <button class="btn" style="padding: 0.5rem 1rem; background: #3498db;">‚úèÔ∏è Edit</button>
                        </div>
                    </div>
                `;
            });
            
            resultsList.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        // Load instruction for editing
        async function loadInstructionForEdit(docId) {
            if (!currentUser) {
                alert('You must be logged in to edit instructions');
                return;
            }

            // Check found permission
            if (!userPermissions.found) {
                alert('‚õî You do not have permission to edit artifact instructions.\n\nContact your administrator to request access.');
                return;
            }

            try {
                const docRef = doc(db, 'artifactInstructions', docId);
                const snapshot = await getDocs(query(collection(db, 'artifactInstructions'), where('__name__', '==', docId)));
                
                if (snapshot.empty) {
                    alert('Instruction not found');
                    return;
                }
                
                const data = snapshot.docs[0].data();
                currentEditDocId = docId;
                
                // Fill form fields
                document.getElementById('editDocId').value = docId;
                document.getElementById('editOwner').value = data.owner || '';
                document.getElementById('editCity').value = data.city || '';
                document.getElementById('editJurisdiction').value = data.jurisdiction || '';
                document.getElementById('editState').value = data.state || '';
                document.getElementById('editKeywords').value = (data.keywords || []).join(', ');
                document.getElementById('editSpecialInstructions').value = data.specialInstructions || '';
                document.getElementById('editGeneralNotes').value = data.generalNotes || '';
                
                // Update keyword preview
                const keywords = (data.keywords || []).join(', ');
                document.getElementById('editKeywordPreview').innerHTML = (data.keywords || []).map(keyword => 
                    `<span class="keyword-tag">${keyword}</span>`
                ).join('');
                
                // Load contacts
                const contactsList = document.getElementById('editContactsList');
                contactsList.innerHTML = '';
                editContactCounter = 0;
                
                if (data.contacts && data.contacts.length > 0) {
                    data.contacts.forEach(contact => {
                        addEditContactField(contact);
                    });
                } else {
                    addEditContactField();
                }
                
                // Load selected laws if any
                if (data.selectedLaws && data.selectedLaws.length > 0) {
                    // Store selected laws temporarily
                    window.tempSelectedLaws = data.selectedLaws;
                    // Auto-load laws with selections
                    loadAvailableLaws('editLawsSelection', 'editSelectedLawsPreview');
                } else {
                    window.tempSelectedLaws = [];
                    document.getElementById('editLawsSelection').style.display = 'none';
                    document.getElementById('editSelectedLawsPreview').innerHTML = '<p style="color: #7f8c8d; font-size: 0.9rem;"><em>No laws selected - click "Load Available Laws" to add laws</em></p>';
                }
                
                // Show edit form and scroll to it
                document.getElementById('editFormContainer').style.display = 'block';
                document.getElementById('editFormContainer').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error loading instruction:', error);
                alert('Failed to load instruction: ' + error.message);
            }
        }

        // Add contact field to edit form
        function addEditContactField(contactData = null) {
            editContactCounter++;
            const contactsList = document.getElementById('editContactsList');
            
            const contactDiv = document.createElement('div');
            contactDiv.className = 'contact-item';
            contactDiv.id = `edit-contact-${editContactCounter}`;
            contactDiv.style.cssText = 'background: #f8f9fa; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; border: 2px solid #e0e0e0; position: relative;';
            
            contactDiv.innerHTML = `
                <button type="button" class="remove-contact-btn" onclick="removeEditContact(${editContactCounter})" 
                        style="position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; border: none; 
                               border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem; line-height: 1;">√ó</button>
                <h5 style="margin-bottom: 1rem; color: #2c3e50;">Contact ${editContactCounter}</h5>
                
                <div class="form-group">
                    <label>Contact Name *</label>
                    <input type="text" class="edit-contact-name" placeholder="e.g., John Smith" value="${contactData?.name || ''}" required>
                </div>
                
                <div class="form-group">
                    <label>Role/Title</label>
                    <input type="text" class="edit-contact-role" placeholder="e.g., State Archaeologist" value="${contactData?.role || ''}">
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="edit-contact-email" placeholder="e.g., contact@example.com" value="${contactData?.email || ''}">
                </div>
                
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" class="edit-contact-phone" placeholder="e.g., (555) 123-4567" value="${contactData?.phone || ''}">
                </div>
                
                <div class="form-group">
                    <label>Physical Address</label>
                    <textarea class="edit-contact-address" placeholder="Enter full address" rows="2">${contactData?.address || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Special Instructions (Contact-specific)</label>
                    <textarea class="edit-contact-instructions" placeholder="Any special notes for this contact" rows="2">${contactData?.specialInstructions || ''}</textarea>
                </div>
            `;
            
            contactsList.appendChild(contactDiv);
        }

        // Remove contact from edit form
        function removeEditContact(contactId) {
            const contactDiv = document.getElementById(`edit-contact-${contactId}`);
            if (contactDiv) {
                contactDiv.remove();
            }
        }

        // Get contacts data from edit form
        function getEditContactsData() {
            const contactItems = document.querySelectorAll('#editContactsList .contact-item');
            const contacts = [];
            
            contactItems.forEach((item) => {
                const name = item.querySelector('.edit-contact-name')?.value.trim();
                const role = item.querySelector('.edit-contact-role')?.value.trim();
                const email = item.querySelector('.edit-contact-email')?.value.trim();
                const phone = item.querySelector('.edit-contact-phone')?.value.trim();
                const address = item.querySelector('.edit-contact-address')?.value.trim();
                const specialInstructions = item.querySelector('.edit-contact-instructions')?.value.trim();
                
                if (name) {
                    contacts.push({
                        name,
                        role: role || '',
                        email: email || '',
                        phone: phone || '',
                        address: address || '',
                        specialInstructions: specialInstructions || ''
                    });
                }
            });
            
            return contacts;
        }

        // Update instruction
        async function updateInstruction(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('You must be logged in to update instructions');
                return;
            }

            // Check found permission
            if (!userPermissions.found) {
                alert('‚õî You do not have permission to update artifact instructions.\n\nContact your administrator to request access.');
                return;
            }
            
            const docId = document.getElementById('editDocId').value;
            const owner = document.getElementById('editOwner').value.trim();
            const city = document.getElementById('editCity').value.trim();
            const jurisdiction = document.getElementById('editJurisdiction').value.trim();
            const state = document.getElementById('editState').value.trim().toUpperCase();
            const keywordsInput = document.getElementById('editKeywords').value.trim();
            const specialInstructions = document.getElementById('editSpecialInstructions').value.trim();
            const generalNotes = document.getElementById('editGeneralNotes').value.trim();
            
            // Validation
            if (!owner && !city && !jurisdiction && !state) {
                alert('Please provide at least one of: Owner, City, Jurisdiction, or State');
                return;
            }
            
            const contacts = getEditContactsData();
            if (contacts.length === 0) {
                alert('Please add at least one contact');
                return;
            }
            
            const keywords = keywordsInput.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
            
            // Get selected laws
            const selectedLaws = getSelectedLawIds('editLawsSelection');
            console.log('Updating with selected laws:', selectedLaws);
            
            const probability = document.getElementById('editProbability').value.trim();
            const htmlContent = generateHTMLFromContacts(contacts, selectedLaws, probability, specialInstructions, generalNotes);
            
            const instructionData = {
                htmlContent: htmlContent,
                keywords: keywords,
                contacts: contacts,
                specialInstructions: specialInstructions,
                generalNotes: generalNotes,
                selectedLaws: selectedLaws,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.email
            };
            
            if (owner) instructionData.owner = owner;
            if (city) instructionData.city = city;
            if (jurisdiction) instructionData.jurisdiction = jurisdiction;
            if (state) instructionData.state = state;
            
            try {
                await updateDoc(doc(db, 'artifactInstructions', docId), instructionData);
                alert('‚úÖ Instruction updated successfully!');
                
                // Hide edit form and refresh search
                document.getElementById('editFormContainer').style.display = 'none';
                searchInstructions(document.getElementById('searchInput').value);
                
            } catch (error) {
                console.error('Error updating instruction:', error);
                alert('Failed to update instruction: ' + error.message);
            }
        }

        // Delete instruction
        async function deleteInstruction() {
            if (!currentUser) {
                alert('You must be logged in to delete instructions');
                return;
            }

            // Check deletion permission
            if (!userPermissions.deletion) {
                alert('‚õî You do not have permission to delete instructions.\n\nContact your administrator to request deletion access.');
                return;
            }
            
            const docId = document.getElementById('editDocId').value;
            const owner = document.getElementById('editOwner').value || 'N/A';
            const city = document.getElementById('editCity').value || 'N/A';
            const jurisdiction = document.getElementById('editJurisdiction').value || 'N/A';
            
            if (!confirm(`Are you sure you want to delete this instruction?\n\nOwner: ${owner}\nCity: ${city}\nJurisdiction: ${jurisdiction}\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'artifactInstructions', docId));
                alert('‚úÖ Instruction deleted successfully!');
                
                // Hide edit form and refresh search
                document.getElementById('editFormContainer').style.display = 'none';
                searchInstructions(document.getElementById('searchInput').value);
                
            } catch (error) {
                console.error('Error deleting instruction:', error);
                alert('Failed to delete instruction: ' + error.message);
            }
        }

        // Cancel edit
        function cancelEdit() {
            document.getElementById('editFormContainer').style.display = 'none';
            currentEditDocId = null;
        }
        
        // Expose functions to global scope for inline onclick handlers
        window.loadInstructionForEdit = loadInstructionForEdit;
        window.removeEditContact = removeEditContact;
        
        // ============== END SEARCH AND EDIT FUNCTIONS ==============

        // ============== END ADMIN AUTHENTICATION ==============

        // Location option selection
        document.getElementById('manualOption').addEventListener('click', function() {
            selectLocationOption('manual');
        });

        document.getElementById('gpsOption').addEventListener('click', function() {
            selectLocationOption('gps');
        });

        function selectLocationOption(type) {
            // Remove active class from all options
            document.querySelectorAll('.location-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Hide all forms
            document.querySelectorAll('.location-form').forEach(form => {
                form.classList.remove('active');
                form.classList.add('inactive');
            });
            
            // Activate selected option
            if (type === 'manual') {
                document.getElementById('manualOption').classList.add('active');
                document.getElementById('manualForm').classList.remove('inactive');
                document.getElementById('manualForm').classList.add('active');
            } else {
                document.getElementById('gpsOption').classList.add('active');
                document.getElementById('gpsForm').classList.remove('inactive');
                document.getElementById('gpsForm').classList.add('active');
            }
        }

        // Get current location using GPS
        window.getCurrentLocation = function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            const btn = document.querySelector('.location-btn');
            btn.disabled = true;
            btn.textContent = 'Getting location...';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    console.log(`GPS Location: ${lat}, ${lng}`);
                    lookupLocationByCoords(lat, lng);
                },
                function(error) {
                    console.error('Error getting location:', error);
                    alert('Unable to get your location. Please try entering coordinates manually.');
                    btn.disabled = false;
                    btn.textContent = 'Get My Current Location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        };

        // Manual location lookup
        window.lookupLocation = function() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('Please enter valid latitude and longitude values.');
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Please enter valid coordinate ranges (Lat: -90 to 90, Lng: -180 to 180).');
                return;
            }
            
            lookupLocationByCoords(lat, lng);
        };

        // Lookup location by coordinates
        async function lookupLocationByCoords(lat, lng) {
            console.log(`Looking up location: ${lat}, ${lng}`);
            
            // Show results section and loading
            document.getElementById('resultsSection').classList.add('active');
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('propertyResults').style.display = 'none';
            
            try {
                // Call King County Parcel API
                const parcelData = await fetchParcelData(lat, lng);
                
                if (parcelData) {
                    console.log('üéØ Parcel data received, processing...');
                    
                    // Add the search coordinates to parcelData since API doesn't return them
                    parcelData.lat = lat;
                    parcelData.long = lng;
                    
                    // Check for specific instructions in database
                    const specificInstructions = await checkForSpecificInstructions(parcelData);
                    
                    // Display results
                    displayPropertyInfo(parcelData, specificInstructions);
                    displayRelevantLaws(parcelData, specificInstructions); // Pass specificInstructions for law selection
                    displayParcelMap(parcelData); // Display the map with polygon
                    displayGuidance(parcelData, specificInstructions);
                } else {
                    console.log('‚ö†Ô∏è No parcel data found for coordinates');
                    displayDefaultGuidance('No property data found for these coordinates. The location might be in an area not covered by the parcel database.');
                }
            } catch (error) {
                console.error('üí• Error during lookup:', error);
                displayDefaultGuidance(`Error during property lookup: ${error.message}`);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('propertyResults').style.display = 'block';
                
                // Show quick navigation bar
                document.getElementById('quickNav').classList.add('active');
                
                // Reset buttons
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.disabled = false;
                    if (btn.classList.contains('location-btn')) {
                        btn.textContent = 'Get My Current Location';
                    }
                });
            }
        }

        // Fetch parcel data from new API
        async function fetchParcelData(lat, lng) {
            try {
                console.log('üåê Making API call to getPropertyInfo...');
                
                const apiUrl = `https://getpropertyinfo-gailic6cjq-uc.a.run.app/getPropertyInfo?lat=${lat}&long=${lng}`;
                console.log('üìç API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('üì° API Response status:', response.status);
                console.log('üì° API Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error Response:', errorText);
                    throw new Error(`API returned status ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('üìä API Response data (full):', JSON.stringify(data, null, 2));
                
                // Normalize state field - API might return 'state_abbr' or 'state'
                if (data && data.state_abbr && !data.state) {
                    data.state = data.state_abbr;
                    console.log('üîÑ Normalized state_abbr to state:', data.state);
                }
                
                // Check if we have actual property data
                if (data && (data.owner || data.jurisdiction)) {
                    console.log('‚úÖ Property data received');
                    console.log('  - Owner:', data.owner || 'Unknown');
                    console.log('  - City:', data.city || 'Unknown');
                    console.log('  - Jurisdiction:', data.jurisdiction || 'Unknown');
                    console.log('  - State:', data.state || 'Unknown');
                    return data;
                }
                
                console.log('‚ùå No property data found - API returned:', data);
                return null;
                
            } catch (error) {
                console.error('üí• Error fetching property data:', error);
                console.error('üí• Error details:', error.message);
                return null;
            }
        }

        // Check for specific instructions in database - FOUR TIER FALLBACK
        async function checkForSpecificInstructions(propertyData) {
            try {
                const owner = (propertyData.owner || '').toLowerCase().trim();
                const jurisdiction = (propertyData.jurisdiction || '').toLowerCase().trim();
                const city = (propertyData.city || '').toLowerCase().trim();
                const state = (propertyData.state || '').toUpperCase().trim();
                
                console.log('\n=== FIVE-TIER MATCHING LOGIC ===');
                console.log('üîç Property Owner:', `"${owner}"`);
                console.log('üîç Property City:', `"${city}"`);
                console.log('üîç Property Jurisdiction:', `"${jurisdiction}"`);
                console.log('üîç Property State:', `"${state}"`);
                
                // Get all instructions from database
                const querySnapshot = await getDocs(collection(db, "artifactInstructions"));
                
                if (querySnapshot.empty) {
                    console.log('‚ùå Database is empty - no instructions found');
                    console.log('üí° Add documents to "artifactInstructions" collection via Admin Panel');
                    return null;
                }
                
                console.log(`\nüìö Database has ${querySnapshot.docs.length} instruction(s)`);
                
                let ownerMatch = null;
                let cityMatch = null;
                let jurisdictionMatch = null;
                let stateMatch = null;
                
                // TIER 1, 2, 3 & 4: Loop through all instructions to find best match
                for (const docSnapshot of querySnapshot.docs) {
                    const instruction = docSnapshot.data();
                    const dbOwner = (instruction.owner || '').toLowerCase().trim();
                    const dbCity = (instruction.city || '').toLowerCase().trim();
                    const dbJurisdiction = (instruction.jurisdiction || '').toLowerCase().trim();
                    const dbState = (instruction.state || '').toUpperCase().trim();
                    const keywords = (instruction.keywords || []).map(k => k.toLowerCase().trim());
                    
                    console.log(`\nüìÑ Checking: "${docSnapshot.id}"`);
                    console.log('   Owner:', `"${dbOwner}"`, 'City:', `"${dbCity}"`, 'Jurisdiction:', `"${dbJurisdiction}"`, 'State:', `"${dbState}"`);
                    console.log('   Keywords:', keywords);
                    
                    // STATE MATCHING: If instruction has states, property state must match ONE of them
                    if (dbState) {
                        const dbStates = dbState.split(',').map(s => s.trim()).filter(s => s);
                        const stateMatches = dbStates.some(s => s === state);
                        
                        if (!state || !stateMatches) {
                            console.log(`   ‚è≠Ô∏è SKIPPED: State mismatch (instruction requires one of [${dbStates.join(', ')}], property is "${state}")`);
                            continue; // Skip this instruction entirely
                        } else {
                            console.log(`   ‚úì State match: "${state}" is in [${dbStates.join(', ')}]`);
                        }
                    }
                    
                    // TIER 1: Check Owner OR Keywords match
                    if (owner && !ownerMatch) {
                        // Direct owner match (bidirectional)
                        if (dbOwner && (owner.includes(dbOwner) || dbOwner.includes(owner))) {
                            console.log('   ‚úÖ TIER 1: Owner name match!');
                            ownerMatch = { ...instruction, matchType: 'owner', docId: docSnapshot.id };
                            break; // Found owner match, stop searching
                        }
                        
                        // Keyword match with owner
                        for (const keyword of keywords) {
                            if (owner.includes(keyword)) {
                                console.log(`   ‚úÖ TIER 1: Keyword match! ("${keyword}" found in owner)`);
                                ownerMatch = { ...instruction, matchType: 'keyword-owner', docId: docSnapshot.id };
                                break;
                            }
                        }
                        
                        if (ownerMatch) break; // Stop after finding owner/keyword match
                    }
                    
                    // TIER 2: Check City match (only if no owner match yet)
                    // City-wide entry: has city but NO owner (jurisdiction optional for disambiguating cities with same name)
                    if (city && !ownerMatch && !cityMatch) {
                        if (!dbOwner || dbOwner === '') {
                            // This is a city-wide entry (applies to all properties in city)
                            if (dbCity && (city.includes(dbCity) || dbCity.includes(city))) {
                                // If jurisdiction is specified in DB, verify it matches (for disambiguation)
                                // If jurisdiction is not specified in DB, match any property in that city
                                if (!dbJurisdiction || dbJurisdiction === '' || 
                                    (jurisdiction && (jurisdiction.includes(dbJurisdiction) || dbJurisdiction.includes(jurisdiction)))) {
                                    console.log('   ‚úÖ TIER 2: City-wide match (no specific owner required)');
                                    cityMatch = { ...instruction, matchType: 'city', docId: docSnapshot.id };
                                }
                            }
                            
                            // Check keywords against city for city-wide entries
                            if (!cityMatch) {
                                for (const keyword of keywords) {
                                    // Bidirectional keyword matching
                                    if (city.includes(keyword) || keyword.includes(city)) {
                                        // If jurisdiction is specified in DB, verify it matches
                                        if (!dbJurisdiction || dbJurisdiction === '' || 
                                            (jurisdiction && (jurisdiction.includes(dbJurisdiction) || dbJurisdiction.includes(jurisdiction)))) {
                                            console.log(`   ‚úÖ TIER 2: City keyword match! ("${keyword}" matches "${city}")`);
                                            cityMatch = { ...instruction, matchType: 'keyword-city', docId: docSnapshot.id };
                                            break;
                                        }
                                    }
                                }
                            }
                        } else {
                            // This entry has a specific owner requirement, skip for TIER 2
                            console.log(`   ‚è≠Ô∏è TIER 2: Skipped (entry requires specific owner)`);
                        }
                    }
                    
                    // TIER 3: Check Jurisdiction/County match (only if no owner or city match yet)
                    // STRICT: Only match jurisdiction-only entries (no specific owner or city required)
                    if (jurisdiction && !ownerMatch && !cityMatch && !jurisdictionMatch) {
                        // Only match if this is a jurisdiction-wide entry (no specific owner or city in DB)
                        
                        if ((!dbOwner || dbOwner === '') && (!dbCity || dbCity === '')) {
                            // This is a jurisdiction-wide entry (applies to all properties in jurisdiction)
                            if (dbJurisdiction && (jurisdiction.includes(dbJurisdiction) || dbJurisdiction.includes(jurisdiction))) {
                                console.log('   ‚úÖ TIER 3: Jurisdiction-wide match (no specific owner/city required)');
                                jurisdictionMatch = { ...instruction, matchType: 'jurisdiction', docId: docSnapshot.id };
                            }
                            
                            // Check keywords against jurisdiction for jurisdiction-wide entries
                            if (!jurisdictionMatch) {
                                for (const keyword of keywords) {
                                    // Bidirectional keyword matching
                                    if (jurisdiction.includes(keyword) || keyword.includes(jurisdiction)) {
                                        console.log(`   ‚úÖ TIER 3: Jurisdiction keyword match! ("${keyword}" matches "${jurisdiction}")`);
                                        jurisdictionMatch = { ...instruction, matchType: 'keyword-jurisdiction', docId: docSnapshot.id };
                                        break;
                                    }
                                }
                            }
                        } else {
                            // This entry has a specific owner or city requirement, skip for TIER 3
                            console.log(`   ‚è≠Ô∏è TIER 3: Skipped (entry requires specific owner/city)`);
                        }
                    }
                    
                    // TIER 4: Check State-only match (State Archaeologist fallback)
                    // Only if no owner/city/jurisdiction match, and entry has state but NO owner, NO city, and NO jurisdiction
                    if (state && !ownerMatch && !cityMatch && !jurisdictionMatch && !stateMatch) {
                        // This is a state-wide entry (e.g., State Archaeologist) - no owner, city, or jurisdiction specified
                        if ((!dbOwner || dbOwner === '') && (!dbCity || dbCity === '') && (!dbJurisdiction || dbJurisdiction === '')) {
                            if (dbState && state === dbState) {
                                console.log('   ‚úÖ TIER 4: State-wide match (State Archaeologist)');
                                stateMatch = { ...instruction, matchType: 'state', docId: docSnapshot.id };
                            }
                        }
                    }
                }
                
                // Return best match in priority order
                if (ownerMatch) {
                    console.log(`\nüéØ TIER 1 MATCH FOUND: ${ownerMatch.matchType}`);
                    console.log('   Using:', ownerMatch.docId);
                    return ownerMatch;
                } else if (cityMatch) {
                    console.log(`\nüéØ TIER 2 MATCH FOUND (CITY): ${cityMatch.matchType}`);
                    console.log('   Using:', cityMatch.docId);
                    return cityMatch;
                } else if (jurisdictionMatch) {
                    console.log(`\nüéØ TIER 3 MATCH FOUND (COUNTY): ${jurisdictionMatch.matchType}`);
                    console.log('   Using:', jurisdictionMatch.docId);
                    return jurisdictionMatch;
                } else if (stateMatch) {
                    console.log(`\nüéØ TIER 4 MATCH FOUND (STATE): ${stateMatch.matchType}`);
                    console.log('   Using:', stateMatch.docId);
                    return stateMatch;
                } else {
                    console.log('\n‚ö†Ô∏è NO MATCH FOUND');
                    console.log('üìã TIER 5: Falling back to default nationwide guidance');
                    return null;
                }
                
            } catch (error) {
                console.error('üí• Error checking database:', error);
                return null;
            }
        }

        // Display property information
        function displayPropertyInfo(propertyData, specificInstructions) {
            const grid = document.getElementById('propertyInfoGrid');
            
            console.log('üìä Displaying property data:', propertyData);
            
            const info = [
                { label: 'Owner', value: 'XXXXXX' }, // Hidden for privacy/safety reasons
                { label: 'Jurisdiction', value: propertyData.jurisdiction || 'Unknown' },
                { label: 'Coordinates', value: `${propertyData.lat || 'N/A'}, ${propertyData.long || 'N/A'}` }
            ];
            
            // Add city if available
            if (propertyData.city) {
                info.push({ label: 'City', value: propertyData.city });
            }
            
            // Add state if available
            if (propertyData.state) {
                info.push({ label: 'State', value: propertyData.state });
            }
            
            // Add any additional fields from the API response
            if (propertyData.address) {
                info.push({ label: 'Address', value: propertyData.address });
            }
            if (propertyData.parcelNumber) {
                info.push({ label: 'Parcel Number', value: propertyData.parcelNumber });
            }
            
            let htmlContent = info.map(item => `
                <div class="info-item">
                    <span class="info-label">${item.label}:</span>
                    <span class="info-value">${item.value}</span>
                </div>
            `).join('');
            
            // Add doc ID at the bottom if available
            if (specificInstructions && specificInstructions.docId) {
                htmlContent += `
                    <div style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid rgba(0,0,0,0.1); text-align: center;">
                        <span style="font-size: 0.75rem; color: #999;">${specificInstructions.docId}</span>
                    </div>
                `;
            }
            
            grid.innerHTML = htmlContent;
            grid.parentElement.dataset.wasVisible = 'true';
            
            // Display timeline for specific locations
            displayTimeline(propertyData);
        }
        
        // Timeline data for sample locations
        const locationTimelines = {
            'Philadelphia County': [
                {
                    year: '1682',
                    title: 'William Penn Founds Philadelphia',
                    description: 'William Penn established Philadelphia as the capital of Pennsylvania Colony, creating a planned city with grid streets.',
                    tags: ['Historic', 'Founding'],
                    type: 'historic'
                },
                {
                    year: '1701',
                    title: 'City Charter Granted',
                    description: 'Philadelphia received its official city charter, establishing local governance and municipal rights.',
                    tags: ['Government', 'Historic'],
                    type: 'historic'
                },
                {
                    year: '1776',
                    title: 'Declaration of Independence',
                    description: 'The Declaration of Independence was signed in Philadelphia at Independence Hall, marking a pivotal moment in American history.',
                    tags: ['Historic', 'Event'],
                    type: 'historic'
                },
                {
                    year: '1787',
                    title: 'Constitutional Convention',
                    description: 'The U.S. Constitution was drafted and signed in Philadelphia during the Constitutional Convention.',
                    tags: ['Historic', 'Event'],
                    type: 'historic'
                },
                {
                    year: '1854',
                    title: 'Philadelphia Consolidation',
                    description: 'The city expanded significantly through the Consolidation Act, merging surrounding districts and townships.',
                    tags: ['Government', 'Expansion'],
                    type: 'modern'
                },
                {
                    year: '1876',
                    title: 'Centennial Exposition',
                    description: 'Philadelphia hosted the first official World\'s Fair in the United States, celebrating the nation\'s 100th anniversary.',
                    tags: ['Event', 'Cultural'],
                    type: 'modern'
                },
                {
                    year: '1952',
                    title: 'City Charter Reform',
                    description: 'A new city charter established a strong-mayor system and modernized city governance.',
                    tags: ['Government', 'Reform'],
                    type: 'modern'
                }
            ],
            'Cook County': [
                {
                    year: '1831',
                    title: 'Cook County Established',
                    description: 'Cook County was organized and named after Daniel Pope Cook, an Illinois statesman.',
                    tags: ['Historic', 'Founding'],
                    type: 'historic'
                },
                {
                    year: '1837',
                    title: 'Chicago Incorporated',
                    description: 'Chicago was incorporated as a city within Cook County with a population of about 4,000.',
                    tags: ['Historic', 'Municipal'],
                    type: 'historic'
                },
                {
                    year: '1871',
                    title: 'Great Chicago Fire',
                    description: 'The devastating fire destroyed much of Chicago, leading to massive reconstruction and urban development.',
                    tags: ['Event', 'Historic'],
                    type: 'historic'
                },
                {
                    year: '1893',
                    title: 'World\'s Columbian Exposition',
                    description: 'Chicago hosted the World\'s Fair, showcasing innovations and establishing the city as a global metropolis.',
                    tags: ['Event', 'Cultural'],
                    type: 'modern'
                },
                {
                    year: '1955',
                    title: 'Richard J. Daley Elected',
                    description: 'Richard J. Daley became mayor, beginning an era of significant urban development and political influence.',
                    tags: ['Government', 'Leadership'],
                    type: 'modern'
                },
                {
                    year: '2008',
                    title: 'Modern Development',
                    description: 'Continued growth in technology, finance, and cultural sectors solidified Cook County\'s position as a major metropolitan area.',
                    tags: ['Modern', 'Development'],
                    type: 'modern'
                }
            ],
            'King County Park': [
                {
                    year: 'Historical',
                    title: 'Indigenous Peoples - SdukÃì ∑albix ∑ (Snoqualmie)',
                    description: 'View more at: https://native-land.ca/listings/territories/sduk%ca%b7albix%ca%b7-snoqualmie',
                    tags: ['Indigenous', 'Historic'],
                    type: 'historic'
                }
            ],
            'Default': [
                {
                    year: 'Historical',
                    title: 'Indigenous Peoples',
                    description: 'This land was originally inhabited by indigenous peoples who lived here for thousands of years before European colonization.',
                    tags: ['Historic', 'Indigenous'],
                    type: 'historic'
                },
                {
                    year: 'Colonial Era',
                    title: 'European Settlement',
                    description: 'European settlers arrived and established communities, fundamentally changing the landscape and land use.',
                    tags: ['Historic', 'Settlement'],
                    type: 'historic'
                },
                {
                    year: '19th Century',
                    title: 'Land Development',
                    description: 'The property was developed as part of the expansion of settlements and agriculture in the region.',
                    tags: ['Development', 'Historic'],
                    type: 'historic'
                },
                {
                    year: '20th Century',
                    title: 'Modern Ownership',
                    description: 'The property transitioned through various owners as the area modernized and urbanized.',
                    tags: ['Modern', 'Ownership'],
                    type: 'modern'
                }
            ]
        };
        
        // Display timeline based on location
        function displayTimeline(propertyData) {
            const timelineSection = document.getElementById('timelineSection');
            const timelineContent = document.getElementById('timelineContent');
            
            // Determine which timeline to show based on jurisdiction or location
            let timeline = null;
            const jurisdiction = propertyData.jurisdiction || '';
            const owner = propertyData.owner || '';
            
            // Match jurisdiction to timeline
            if (jurisdiction.includes('Philadelphia')) {
                timeline = locationTimelines['Philadelphia County'];
            } else if (jurisdiction.includes('Cook')) {
                timeline = locationTimelines['Cook County'];
            } else if (owner.includes('KING COUNTY-PARKS')) {
                timeline = locationTimelines['King County Park'];
            } else {
                timeline = locationTimelines['Default'];
            }
            
            if (!timeline) {
                timelineSection.style.display = 'none';
                return;
            }
            
            // Generate timeline HTML
            const timelineHTML = timeline.map((item, index) => `
                <div class="timeline-item" style="animation-delay: ${index * 0.1}s">
                    <div class="timeline-marker ${item.type}"></div>
                    <div class="timeline-content ${item.type}">
                        <div class="timeline-year">${item.year}</div>
                        <div class="timeline-title">${item.title}</div>
                        <div class="timeline-description">${item.description}</div>
                        <div class="timeline-tags">
                            ${item.tags.map(tag => {
                                let tagClass = 'timeline-tag';
                                if (tag.toLowerCase() === 'purchase' || tag.toLowerCase() === 'ownership') tagClass += ' purchase';
                                else if (tag.toLowerCase().includes('resident') || tag.toLowerCase().includes('resident')) tagClass += ' resident';
                                else if (tag.toLowerCase() === 'event') tagClass += ' event';
                                return `<span class="${tagClass}">${tag}</span>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            timelineContent.innerHTML = timelineHTML;
            timelineSection.style.display = 'block';
            timelineSection.dataset.wasVisible = 'true';
        }

        // Display relevant laws for the location
        async function displayRelevantLaws(propertyData, specificInstructions) {
            const lawsSection = document.getElementById('relevantLawsSection');
            const lawsContent = document.getElementById('relevantLawsContent');
            
            // Check if instruction has selected laws
            const selectedLawIds = specificInstructions?.selectedLaws || [];
            
            if (selectedLawIds.length === 0) {
                console.log('No laws selected for this instruction');
                lawsSection.style.display = 'none';
                return;
            }
            
            try {
                // Fetch only the selected laws
                const lawsRef = collection(db, 'archaeologyLaws');
                const lawsSnapshot = await getDocs(lawsRef);
                
                const relevantLaws = [];
                
                lawsSnapshot.forEach((doc) => {
                    // Only include laws that were selected by admin
                    if (selectedLawIds.includes(doc.id)) {
                        relevantLaws.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                console.log(`Displaying ${relevantLaws.length} admin-selected laws`);
                
                if (relevantLaws.length === 0) {
                    lawsSection.style.display = 'none';
                    return;
                }
                
                // Sort laws: state first, then county
                relevantLaws.sort((a, b) => {
                    const order = { state: 1, county: 2 };
                    const aType = a.type || 'state';
                    const bType = b.type || 'state';
                    return (order[aType] || 3) - (order[bType] || 3);
                });
                
                // Generate HTML
                let html = '<ul class="laws-list">';
                
                relevantLaws.forEach((law, index) => {
                    const lawType = law.type || 'state';
                    const title = law.title || law.name || 'Untitled Law';
                    const description = law.description || law.summary || '';
                    const fullText = law.fullText || law.text || '';
                    const reference = law.reference || law.citation || '';
                    const link = law.link || law.url || '';
                    
                    html += `
                        <li class="law-item ${lawType}" onclick="toggleLawDetails('law-${index}')">
                            <div class="law-title">
                                <span class="law-type ${lawType}">${lawType.toUpperCase()}</span>
                                ${title}
                            </div>
                            ${description ? `<div class="law-description">${description}</div>` : ''}
                            <div id="law-${index}" class="law-details">
                                ${fullText ? `<div class="law-full-text">${fullText}</div>` : ''}
                                ${reference || link ? `
                                    <div class="law-reference">
                                        ${reference ? `<strong>Reference:</strong> ${reference}` : ''}
                                        ${link ? `<br><a href="${link}" target="_blank">View Full Text ‚Üí</a>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </li>
                    `;
                });
                
                html += '</ul>';
                
                lawsContent.innerHTML = html;
                lawsSection.style.display = 'block';
                lawsSection.dataset.wasVisible = 'true';
                
            } catch (error) {
                console.error('Error fetching laws:', error);
                lawsSection.style.display = 'none';
            }
        }
        
        // Toggle law details visibility
        window.toggleLawDetails = function(lawId) {
            const detailsElement = document.getElementById(lawId);
            if (detailsElement) {
                detailsElement.classList.toggle('active');
            }
        };

        // Global map instance tracker
        let parcelMapInstance = null;

        // Display parcel polygon on map
        function displayParcelMap(propertyData) {
            const mapSection = document.getElementById('parcelMapSection');
            
            console.log('üó∫Ô∏è displayParcelMap called with:', propertyData);
            console.log('üó∫Ô∏è Polygon field exists?', !!propertyData.polygon);
            console.log('üó∫Ô∏è Polygon value:', propertyData.polygon);
            
            // Check if polygon data exists
            if (!propertyData.polygon) {
                console.log('‚ö†Ô∏è No polygon data in API response - map will not display');
                console.log('üí° The API needs to return a "polygon" field with WKT MULTIPOLYGON data');
                mapSection.style.display = 'none';
                return;
            }
            
            console.log('üó∫Ô∏è Polygon data found! Rendering map...');
            console.log('Polygon WKT:', propertyData.polygon.substring(0, 100) + '...');
            
            // Remove existing map instance if it exists
            if (parcelMapInstance) {
                console.log('üóëÔ∏è Removing existing map instance...');
                parcelMapInstance.remove();
                parcelMapInstance = null;
            }
            
            // Show map section FIRST
            mapSection.style.display = 'block';
            mapSection.dataset.wasVisible = 'true';
            
            // Wait for DOM to update before creating map
            setTimeout(() => {
                try {
                    // Parse WKT MULTIPOLYGON
                    const coordinates = parseWKT(propertyData.polygon);
                    
                    if (!coordinates || coordinates.length === 0) {
                        console.error('‚ùå Failed to parse polygon coordinates');
                        mapSection.style.display = 'none';
                        return;
                    }
                    
                    console.log('‚úÖ Parsed', coordinates.length, 'coordinate points');
                    console.log('First coordinate:', coordinates[0]);
                    console.log('Last coordinate:', coordinates[coordinates.length - 1]);
                    
                    // Create the map with initial view (store in global variable)
                    parcelMapInstance = L.map('parcelMap').setView([coordinates[0][0], coordinates[0][1]], 15);
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(parcelMapInstance);
                    
                    console.log('Map created, adding polygon...');
                    
                    // Create polygon from coordinates
                    const polygon = L.polygon(coordinates, {
                        color: '#e74c3c',
                        fillColor: '#e74c3c',
                        fillOpacity: 0.3,
                        weight: 3
                    }).addTo(parcelMapInstance);
                    
                    console.log('Polygon added, fitting bounds...');
                    console.log('Polygon bounds:', polygon.getBounds());
                    
                    // Fit map to polygon bounds with padding
                    parcelMapInstance.fitBounds(polygon.getBounds(), { padding: [50, 50] });
                    
                    // Add marker at search location if available
                    if (propertyData.lat && propertyData.long) {
                        L.marker([propertyData.lat, propertyData.long])
                            .addTo(parcelMapInstance)
                            .bindPopup('üìç Search Location')
                            .openPopup();
                    }
                    
                    // Force map to recalculate size
                    setTimeout(() => {
                        parcelMapInstance.invalidateSize();
                        console.log('‚úÖ Map displayed successfully!');
                    }, 100);
                    
                } catch (error) {
                    console.error('üí• Error displaying map:', error);
                    console.error('Error details:', error.message, error.stack);
                    mapSection.style.display = 'none';
                }
            }, 100);
        }

        // Parse WKT MULTIPOLYGON format to Leaflet coordinates
        function parseWKT(wkt) {
            try {
                console.log('üîç Parsing WKT polygon...');
                console.log('Raw WKT length:', wkt.length);
                
                // Remove "MULTIPOLYGON(((" prefix and ")))" suffix
                const coordString = wkt
                    .replace(/^MULTIPOLYGON\(\(\(/i, '')
                    .replace(/\)\)\)$/, '')
                    .trim();
                
                console.log('Cleaned coord string (first 200 chars):', coordString.substring(0, 200));
                
                // Split by coordinate pairs
                const pairs = coordString.split(',');
                console.log('Found', pairs.length, 'coordinate pairs');
                
                // Convert to [lat, lng] format (Leaflet expects lat first, but WKT is lng lat)
                const coordinates = pairs.map((pair, index) => {
                    // Remove extra whitespace and split by space
                    const parts = pair.trim().split(/\s+/);
                    
                    if (parts.length !== 2) {
                        console.warn(`‚ö†Ô∏è Coordinate pair ${index} has ${parts.length} parts:`, pair);
                        return null;
                    }
                    
                    const lng = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    
                    if (isNaN(lng) || isNaN(lat)) {
                        console.error(`‚ùå Invalid coordinate at index ${index}:`, parts);
                        console.error(`   lng: ${parts[0]} -> ${lng}`);
                        console.error(`   lat: ${parts[1]} -> ${lat}`);
                        return null;
                    }
                    
                    return [lat, lng]; // Swap for Leaflet
                }).filter(coord => coord !== null); // Remove invalid coordinates
                
                console.log('‚úÖ Successfully parsed', coordinates.length, 'valid coordinates');
                
                if (coordinates.length < 3) {
                    console.error('‚ùå Not enough valid coordinates for a polygon (need at least 3)');
                    return null;
                }
                
                console.log('First 3 coordinates:', coordinates.slice(0, 3));
                console.log('Last 3 coordinates:', coordinates.slice(-3));
                
                return coordinates;
                
            } catch (error) {
                console.error('üí• Error parsing WKT:', error);
                console.error('Error stack:', error.stack);
                return null;
            }
        }

        // Display guidance based on property and instructions
        function displayGuidance(propertyData, specificInstructions) {
            const guidanceContent = document.getElementById('guidanceContent');
            
            if (specificInstructions && specificInstructions.htmlContent) {
                // TIER 1, TIER 2, or TIER 2.5: Display custom instructions from database
                console.log('üìÑ Displaying custom instructions');
                console.log('Match type:', specificInstructions.matchType);
                
                const matchTypeLabels = {
                    'owner': 'Owner Match',
                    'keyword-owner': 'Keyword Match (Owner)',
                    'jurisdiction': 'Jurisdiction Match',
                    'keyword-jurisdiction': 'Keyword Match (Jurisdiction)',
                    'state': 'State Archaeologist'
                };
                
                const matchLabel = matchTypeLabels[specificInstructions.matchType] || specificInstructions.matchType;
                
                // Determine tier based on match type
                let tier = 'TIER 3';
                if (specificInstructions.matchType.includes('owner') || specificInstructions.matchType === 'owner') {
                    tier = 'TIER 1';
                } else if (specificInstructions.matchType.includes('jurisdiction') || specificInstructions.matchType === 'jurisdiction') {
                    tier = 'TIER 2';
                } else if (specificInstructions.matchType === 'state') {
                    tier = 'TIER 2.5';
                }
                
                // Build additional info HTML
                let additionalInfoHTML = '';
                if (specificInstructions.additionalInfo) {
                    additionalInfoHTML = `<p>${specificInstructions.additionalInfo}</p>`;
                }
                
                // Store data for tabbed view (htmlContent already includes contacts)
                currentGuidanceData = {
                    immediateSteps: specificInstructions.htmlContent,
                    contacts: '<p><em>See "What to Do" tab for contact information.</em></p>',
                    additionalInfo: additionalInfoHTML || '<p><em>No additional information available.</em></p>'
                };
                
                // Display in list view (htmlContent already includes all contacts from generateHTMLFromContacts)
                guidanceContent.innerHTML = `
                    <div class="custom-instructions-content">
                        ${specificInstructions.htmlContent}
                        ${additionalInfoHTML ? `<div class="contact-card" style="background: #e3f2fd; border-color: #90caf9;"><h4>‚ÑπÔ∏è Additional Information</h4><div class="contact-info">${additionalInfoHTML}</div></div>` : ''}
                    </div>
                `;
            } else {
                // TIER 3: Display default basic steps
                console.log('üìÑ TIER 3: Displaying default basic steps');
                displayDefaultGuidance();
            }
        }

        // Display default guidance
        function displayDefaultGuidance(errorInfo = null) {
            const guidanceContent = document.getElementById('guidanceContent');
            const propertyGrid = document.getElementById('propertyInfoGrid');
            
            // Show error info in property section if available
            if (errorInfo) {
                propertyGrid.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value">${errorInfo}</span>
                    </div>
                `;
            }
            
            const defaultHTML = getDefaultGuidanceHTML();
            guidanceContent.innerHTML = defaultHTML;
            
            // Store data for tabbed view (split default guidance into sections)
            const immediateStepsHTML = `
                <div class="emergency-note">
                    <strong>‚ö†Ô∏è STOP! Do not disturb the artifact or the surrounding area.</strong>
                </div>
                <h4>Immediate Steps to Take:</h4>
                <ol style="margin: 1rem 0; padding-left: 2rem; line-height: 1.8;">
                    <li><strong>Stop all work</strong> in the immediate area</li>
                    <li><strong>Do not touch or move</strong> the artifact</li>
                    <li><strong>Mark the location</strong> with flags or cones if available</li>
                    <li><strong>Take photos</strong> of the artifact in place (do not disturb)</li>
                    <li><strong>Record GPS coordinates</strong> of the exact location</li>
                    <li><strong>Contact local authorities</strong> (county archaeologist, SHPO, or tribal office)</li>
                    <li><strong>Secure the area</strong> to prevent disturbance by others</li>
                    <li><strong>Document everything</strong> - date, time, weather, surrounding features</li>
                </ol>
            `;
            
            const contactsHTML = `
                <div class="contact-card">
                    <h4>üìû Contact Your Local Authorities</h4>
                    <div class="contact-info">
                        <p><strong>County Archaeologist or Planning Department</strong></p>
                        <p>Search online for: "[Your County Name] archaeologist" or "[Your County Name] planning department"</p>
                        <p style="margin-top: 1rem;"><strong>State Historic Preservation Office (SHPO)</strong></p>
                        <p>Every state has a SHPO - search: "[Your State] historic preservation office"</p>
                    </div>
                </div>
                
                <div class="contact-card">
                    <h4>üèõÔ∏è Federal Resources</h4>
                    <div class="contact-info">
                        <p><strong>If on Federal Land:</strong></p>
                        <p>National Park Service, Bureau of Land Management, U.S. Forest Service, etc.</p>
                        <p style="margin-top: 1rem;"><strong>If Native American artifacts:</strong></p>
                        <p>Contact local tribal authorities and NAGPRA coordinator</p>
                    </div>
                </div>
            `;
            
            const additionalInfoHTML = `
                <div class="emergency-note">
                    <strong>‚öñÔ∏è Legal Notice:</strong> Federal and state laws protect archaeological resources. The Archaeological Resources Protection Act (ARPA) and similar state laws make it illegal to excavate, remove, damage, or otherwise alter archaeological sites on public or tribal lands without a permit. Violations can result in criminal penalties including fines and imprisonment.
                </div>
                
                <div class="contact-card" style="background: #e3f2fd; border-color: #90caf9;">
                    <h4>üìö Learn More</h4>
                    <div class="contact-info">
                        <p>Visit the <a href="laws.html" style="color: #1976d2; font-weight: 600;">Federal Archaeology Laws</a> page to learn about your legal responsibilities.</p>
                    </div>
                </div>
            `;
            
            currentGuidanceData = {
                immediateSteps: immediateStepsHTML,
                contacts: contactsHTML,
                additionalInfo: additionalInfoHTML
            };
        }

        // Get default guidance HTML - Generic for anywhere in the US
        function getDefaultGuidanceHTML() {
            return `
                <div class="emergency-note">
                    <strong>‚ö†Ô∏è STOP! Do not disturb the artifact or the surrounding area.</strong>
                </div>
                
                <div class="contact-card">
                    <h4>üìû Contact Your Local Authorities</h4>
                    <div class="contact-info">
                        <p><strong>County Archaeologist or Planning Department</strong></p>
                        <p>Search online for: "[Your County Name] archaeologist" or "[Your County Name] planning department"</p>
                        <p style="margin-top: 1rem;"><strong>State Historic Preservation Office (SHPO)</strong></p>
                        <p>Every state has a SHPO - search: "[Your State] historic preservation office"</p>
                    </div>
                </div>
                
                <div class="contact-card">
                    <h4>üèõÔ∏è Federal Resources</h4>
                    <div class="contact-info">
                        <p><strong>If on Federal Land:</strong></p>
                        <p>National Park Service, Bureau of Land Management, U.S. Forest Service, etc.</p>
                        <p style="margin-top: 1rem;"><strong>If Native American artifacts:</strong></p>
                        <p>Contact local tribal authorities and NAGPRA coordinator</p>
                    </div>
                </div>
                
                <h4>Immediate Steps to Take:</h4>
                <ol style="margin: 1rem 0; padding-left: 2rem; line-height: 1.8;">
                    <li><strong>Stop all work</strong> in the immediate area</li>
                    <li><strong>Do not touch or move</strong> the artifact</li>
                    <li><strong>Mark the location</strong> with flags or cones if available</li>
                    <li><strong>Take photos</strong> of the artifact in place (do not disturb)</li>
                    <li><strong>Record GPS coordinates</strong> of the exact location</li>
                    <li><strong>Contact local authorities</strong> (county archaeologist, SHPO, or tribal office)</li>
                    <li><strong>Secure the area</strong> to prevent disturbance by others</li>
                    <li><strong>Document everything</strong> - date, time, weather, surrounding features</li>
                </ol>
                
                <div class="emergency-note">
                    <strong>‚öñÔ∏è Legal Notice:</strong> Federal and state laws protect archaeological resources. The Archaeological Resources Protection Act (ARPA) and similar state laws make it illegal to excavate, remove, damage, or otherwise alter archaeological sites on public or tribal lands without a permit. Violations can result in criminal penalties including fines and imprisonment.
                </div>
                
                <div class="contact-card" style="background: #e3f2fd; border-color: #90caf9;">
                    <h4>üìö Learn More</h4>
                    <div class="contact-info">
                        <p>Visit the <a href="laws.html" style="color: #1976d2; font-weight: 600;">Federal Archaeology Laws</a> page to learn about your legal responsibilities.</p>
                    </div>
                </div>
            `;
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded! Initializing...');
            
            // Initialize admin panel event listeners
            initializeAdminEventListeners();
            
            // Auto-fill coordinates for testing and make it obvious
            const lat = document.getElementById('latitude');
            const lng = document.getElementById('longitude');
            if (lat && lng) {
            }
            
            // Force select the manual option and make it visible
            setTimeout(() => {
                selectLocationOption('manual');
                console.log('Manual option selected');
            }, 100);
        });

        // Make sure functions are available globally - move outside the module
        window.lookupLocation = function() {
            console.log('üî• LOOKUP BUTTON CLICKED! üî•');
            
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            console.log('Manual lookup clicked with values:', lat, lng);
            
            if (isNaN(lat) || isNaN(lng)) {
                console.error('Invalid coordinates!', {lat, lng});
                alert('Please enter valid latitude and longitude values.');
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                console.error('Coordinates out of range!', {lat, lng});
                alert('Please enter valid coordinate ranges (Lat: -90 to 90, Lng: -180 to 180).');
                return;
            }
            
            console.log('Calling lookupLocationByCoords...');
            lookupLocationByCoords(lat, lng);
        };

        // Expose getCurrentLocation globally as well
        window.getCurrentLocation = function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            const btn = document.querySelector('.location-btn');
            btn.disabled = true;
            btn.textContent = 'Getting location...';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    console.log(`GPS Location: ${lat}, ${lng}`);
                    lookupLocationByCoords(lat, lng);
                },
                function(error) {
                    console.error('Error getting location:', error);
                    alert('Unable to get your location. Please try entering coordinates manually.');
                    btn.disabled = false;
                    btn.textContent = 'Get My Current Location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        };

        // Load sample coordinates into the form
        window.loadSampleCoords = function(lat, lng, locationName) {
            console.log(`üìç Loading sample location: ${locationName}`);
            console.log(`   Coordinates: ${lat}, ${lng}`);
            
            // Fill in the form fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Automatically trigger the lookup
            lookupLocationByCoords(lat, lng);
        };
        
        // Toggle state section collapse/expand
        window.toggleState = function(headerElement) {
            const stateSection = headerElement.parentElement;
            const stateLocations = stateSection.querySelector('.state-locations');
            
            // Toggle active class on header and locations
            headerElement.classList.toggle('active');
            stateLocations.classList.toggle('active');
        };

        // ============== HAMBURGER MENU ==============
        const hamburger = document.getElementById('hamburger');
        const navLinks = document.getElementById('navLinks');
        
        if (hamburger) {
            hamburger.addEventListener('click', function() {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
            });
            
            // Close menu when clicking on a link
            const navLinkItems = navLinks.querySelectorAll('a');
            navLinkItems.forEach(link => {
                link.addEventListener('click', function() {
                    hamburger.classList.remove('active');
                    navLinks.classList.remove('active');
                });
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                const isClickInsideNav = navLinks.contains(event.target);
                const isClickOnHamburger = hamburger.contains(event.target);
                
                if (!isClickInsideNav && !isClickOnHamburger && navLinks.classList.contains('active')) {
                    hamburger.classList.remove('active');
                    navLinks.classList.remove('active');
                }
            });
        }
        // ============== END HAMBURGER MENU ==============
        
        // ============== QUICK NAVIGATION ==============
        // Smooth scroll to sections
        document.querySelectorAll('.quick-nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const targetId = this.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    // Check if the target section is visible (not display: none)
                    const targetSection = targetElement.closest('[id*="Section"]') || targetElement;
                    
                    if (targetSection && window.getComputedStyle(targetSection).display !== 'none') {
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            });
        });
        
        // Function to update quick nav link states based on visible sections
        function updateQuickNavLinks() {
            const sections = {
                navGuidance: 'guidanceContent',
                navLaws: 'relevantLawsSection',
                navMap: 'parcelMapSection',
                navTimeline: 'timelineSection',
                navProperty: 'propertyInfoGrid'
            };
            
            Object.entries(sections).forEach(([navId, sectionId]) => {
                const navLink = document.getElementById(navId);
                const section = document.getElementById(sectionId);
                
                if (navLink && section) {
                    const sectionParent = section.closest('[id*="Section"]') || section.parentElement;
                    const isVisible = sectionParent && window.getComputedStyle(sectionParent).display !== 'none';
                    
                    if (isVisible) {
                        navLink.classList.remove('disabled');
                    } else {
                        navLink.classList.add('disabled');
                    }
                }
            });
        }
        
        // Call updateQuickNavLinks whenever results are displayed
        // We'll use a MutationObserver to watch for changes in the results section
        const resultsSection = document.getElementById('resultsSection');
        if (resultsSection) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' || mutation.type === 'childList') {
                        // Small delay to ensure DOM has updated
                        setTimeout(updateQuickNavLinks, 100);
                    }
                });
            });
            
            observer.observe(resultsSection, {
                attributes: true,
                childList: true,
                subtree: true,
                attributeFilter: ['style', 'class']
            });
        }
        // ============== END QUICK NAVIGATION ==============
    </script>
</body>
</html>