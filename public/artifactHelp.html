<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Found an Artifact - Archalo</title>
    <link rel="icon" type="image/png" href="owlcheologists.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
        }
        
        /* Navigation */
        nav {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }
        
        .logo {
            color: #ecf0f1;
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            gap: clamp(1rem, 3vw, 2rem);
        }
        
        .nav-links a {
            color: #ecf0f1;
            text-decoration: none;
            font-weight: 500;
            font-size: clamp(0.9rem, 2vw, 1rem);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .nav-links a:hover, .nav-links a.active {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
            transform: translateY(-1px);
        }
        
        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.5rem;
            z-index: 1001;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background-color: #ecf0f1;
            margin: 3px 0;
            transition: all 0.3s ease;
            border-radius: 2px;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }
        
        /* Mobile Navigation */
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            
            .nav-links {
                position: fixed;
                left: -100%;
                top: 70px;
                flex-direction: column;
                background: linear-gradient(135deg, #2c3e50, #34495e);
                width: 100%;
                text-align: center;
                transition: left 0.3s ease;
                box-shadow: 0 10px 27px rgba(0,0,0,0.3);
                padding: 1rem 0;
                gap: 0;
            }
            
            .nav-links.active {
                left: 0;
            }
            
            .nav-links li {
                padding: 0.5rem 0;
                width: 100%;
            }
            
            .nav-links a {
                display: block;
                padding: 1rem;
                width: 100%;
            }
            
            .nav-container {
                padding: 0 1rem;
            }
            
            .location-options {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr !important;
            }
            
            .contact-fields {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Tablet responsive */
        @media (max-width: 1024px) and (min-width: 769px) {
            .location-options {
                gap: 1rem;
            }
            
            .main-container {
                padding: 2rem 1.5rem;
            }
        }
        
        /* Hero section */
        .hero {
            background: linear-gradient(135deg, #d4704a, #c0603c);
            color: white;
            padding: clamp(3rem, 6vw, 5rem) 2rem;
            text-align: center;
        }
        
        .hero h1 {
            font-size: clamp(2.5rem, 6vw, 4rem);
            margin-bottom: 1rem;
            font-weight: 700;
            letter-spacing: -1px;
        }
        
        .hero p {
            font-size: clamp(1.1rem, 3vw, 1.3rem);
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        /* Main content */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: clamp(3rem, 6vw, 5rem) 2rem;
        }
        
        .location-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .location-section h2 {
            color: #2c3e50;
            margin-bottom: 2rem;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            text-align: center;
        }
        
        .location-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .location-option {
            padding: 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .location-option:hover, .location-option.active {
            border-color: #3498db;
            background-color: #f8f9fa;
        }
        
        .location-option h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .location-form {
            display: block; /* Change from none to block to show by default */
            margin-top: 2rem;
        }
        
        .location-form.active {
            display: block;
        }
        
        .location-form.inactive {
            display: none;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .form-group input {
            padding: 0.8rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            border-color: #3498db;
        }
        
        .btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .location-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        
        .location-btn:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .results-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            display: none;
        }
        
        .results-section.active {
            display: block;
        }
        
        .property-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .property-info h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .info-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 500;
            word-wrap: break-word;
        }
        
        .guidance-section {
            margin-top: 2rem;
        }
        
        .guidance-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .contact-card {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .contact-card h4 {
            color: #856404;
            margin-bottom: 0.5rem;
        }
        
        .contact-info {
            color: #856404;
        }
        
        .emergency-note {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 2rem;
        }
        
        /* Map Styles */
        .parcel-map-section {
            margin: 2rem 0;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
        }
        
        .parcel-map-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        #parcelMap {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .map-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Admin Modal Styles */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .admin-modal.active {
            display: flex;
        }
        
        .admin-modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .admin-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .admin-modal-header h2 {
            color: #2c3e50;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: #95a5a6;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            background-color: #ecf0f1;
            color: #e74c3c;
        }
        
        .admin-login-form, .admin-panel {
            display: none;
        }
        
        .admin-login-form.active, .admin-panel.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .keyword-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .keyword-tag {
            background-color: #3498db;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .keyword-tag button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .contact-item {
            background-color: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .contact-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .contact-item-header h5 {
            color: #2c3e50;
            margin: 0;
        }
        
        .remove-contact-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .remove-contact-btn:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }
        
        .contact-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .contact-fields .form-group {
            margin-bottom: 0;
        }
        
        .contact-fields .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .admin-user-info {
            background-color: #e8f5e9;
            border: 1px solid #81c784;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .admin-user-info p {
            margin: 0.5rem 0;
            color: #2e7d32;
        }
        
        .btn-logout {
            background-color: #e74c3c;
            margin-top: 1rem;
        }
        
        .btn-logout:hover {
            background-color: #c0392b;
        }
        
        /* Footer Styles */
        footer {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            padding: 2rem 1rem;
            margin-top: 3rem;
            text-align: center;
        }
        
        .footer-disclaimer {
            max-width: 900px;
            margin: 0 auto 1rem;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #bdc3c7;
        }
        
        .admin-link {
            color: #bdc3c7;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px dotted transparent;
        }
        
        .admin-link:hover {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        @media (max-width: 768px) {
            .location-options {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-modal-content {
                padding: 1.5rem;
                margin: 1rem;
                max-width: 95%;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Make buttons stack on mobile */
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            /* Admin panel search section */
            #searchBtn, #loadAllBtn {
                width: 48%;
                display: inline-block;
                margin: 0.25rem 1%;
            }
            
            /* Edit form buttons */
            #editFormContainer .btn {
                width: 100%;
                margin: 0.5rem 0;
                float: none !important;
            }
            
            /* Hero section */
            .hero {
                padding: 2rem 1rem;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            /* Sample location buttons */
            .btn[onclick*="loadSampleCoords"] {
                font-size: 0.85rem;
                padding: 0.5rem 0.8rem;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .logo {
                font-size: 1.3rem;
            }
            
            .nav-container {
                padding: 0 0.5rem;
            }
            
            .main-container {
                padding: 1.5rem 1rem;
            }
            
            .location-section,
            .results-section {
                padding: 1rem;
            }
            
            .admin-modal-content {
                margin: 0.5rem;
                padding: 1rem;
            }
            
            /* Stack search buttons vertically on very small screens */
            #searchBtn, #loadAllBtn {
                width: 100%;
                margin: 0.25rem 0;
            }
            
            .form-group label {
                font-size: 0.9rem;
            }
            
            .form-group input,
            .form-group textarea {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="Archalo.html" style="text-decoration: none; color: inherit;">
                <div class="logo">Archalo</div>
            </a>
            <button class="hamburger" id="hamburger" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-links" id="navLinks">
                <li><a href="Archalo.html">Home</a></li>
                <li><a href="laws.html">Laws</a></li>
                <li><a href="artifactHelp.html" class="active">I Found an Artifact</a></li>
                <li><a href="edu-resources.html">Educational Resources</a></li>
            </ul>
        </div>
    </nav>

    <section class="hero">
        <h1>I Found an Artifact!</h1>
        <p>Get location-specific guidance on what to do when you discover archaeological artifacts</p>
    </section>

    <section class="main-container">
        <div class="location-section">
            <h2>First, let's determine your location</h2>
            
            <div class="location-options">
                <div class="location-option" id="manualOption">
                    <h3>üìç Enter Coordinates</h3>
                    <p>Manually input latitude and longitude</p>
                </div>
                <div class="location-option" id="gpsOption">
                    <h3>üåê Use Current Location</h3>
                    <p>Allow GPS access to get precise location</p>
                </div>
            </div>
            
            <div id="manualForm" class="location-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="latitude">Latitude:</label>
                        <input type="number" id="latitude" step="any" placeholder="" required>
                    </div>
                    <div class="form-group">
                        <label for="longitude">Longitude:</label>
                        <input type="number" id="longitude" step="any" placeholder="" required>
                    </div>
                </div>
                <button class="btn" onclick="lookupLocation()">Find Property Information</button>
                
                <!-- Sample Coordinates -->
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e0e0e0;">
                    <p style="font-weight: 600; color: #2c3e50; margin-bottom: 1rem;">üìç Try Sample Locations:</p>
                    <div style="display: grid; gap: 0.5rem;">
                        <button class="btn" onclick="loadSampleCoords(46.8523, -121.7603, 'National Park Service')" 
                                style="background: #27ae60; font-size: 0.9rem; padding: 0.6rem 1rem;">
                            üèûÔ∏è National Park Service (Mt. Rainier)
                        </button>
                        <button class="btn" onclick="loadSampleCoords(48.052727359509, -121.3570518501979, 'National Forest Service')" 
                                style="background: #16a085; font-size: 0.9rem; padding: 0.6rem 1rem;">
                            üå≤ National Forest Service (Mt. Baker-Snoqualmie)
                        </button>
                        <button class="btn" onclick="loadSampleCoords(47.55858371570509, -122.05892874774389, 'Washington State Parks')" 
                                style="background: #2980b9; font-size: 0.9rem; padding: 0.6rem 1rem;">
                            üèïÔ∏è Washington State Parks (Lake Sammamish State Park)
                        </button>
                        <button class="btn" onclick="loadSampleCoords(47.668265406752234, -122.1461806080578, 'City of Redmond Park')" 
                                style="background: #8e44ad; font-size: 0.9rem; padding: 0.6rem 1rem;">
                            üé° City of Redmond Park (Grass Lawn Park)
                        </button>
                        <button class="btn" onclick="loadSampleCoords(47.6062, -122.3321, 'Private Property - King County')" 
                                style="background: #95a5a6; font-size: 0.9rem; padding: 0.6rem 1rem;">
                            üè† Private Property (King County)
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="gpsForm" class="location-form">
                <button class="btn location-btn" onclick="getCurrentLocation()">Get My Current Location</button>
            </div>
        </div>
        
        <div id="resultsSection" class="results-section">
            <div id="loadingIndicator" class="loading">
                Looking up property information...
            </div>
            
            <div id="propertyResults" style="display: none;">
                <div class="guidance-section">
                    <h3>What to do next:</h3>
                    <div id="guidanceContent">
                        <!-- Guidance content will be populated here -->
                    </div>
                </div>
                
                <!-- Parcel Map Section -->
                <div id="parcelMapSection" class="parcel-map-section" style="display: none;">
                    <h3>üìç Parcel Boundary</h3>
                    <div id="parcelMap"></div>
                    <div class="map-info">
                        <strong>‚ÑπÔ∏è Map shows the property boundary.</strong> The highlighted area represents the parcel where the artifact was found.<br><br>OpenStreetMap is open data, licensed under the Open Data Commons Open Database License (ODbL) by the OpenStreetMap Foundation (OSMF). 
                    </div>
                </div>
                
                <div class="property-info">
                    <h3>Property Information</h3>
                    <div class="info-grid" id="propertyInfoGrid">
                        <!-- Property info will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </section>
                    <div style="max-width: 1200px; margin: 2rem auto; padding: 0 2rem;"></div>
                        <div style="background: linear-gradient(135deg, #fff9e6, #fff3cd); border-left: 4px solid #ffc107; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
                            <div style="display: flex; align-items: start; gap: 1rem;">
                                <div style="flex: 1;">


                    <p style="margin: 0; color: #856404; line-height: 1.6;">
                        The data, including but not limited to contact information provided on this page, while public, is intended strictly for the non-profit purpose of reporting artifact discoveries and connecting finders with the appropriate contacts; respect for the privacy of those listed is mandatory. Any misuse of this information, including commercial solicitation, spamming, harassment, or any activity unrelated to the proper reporting and management of artifacts, constitutes a severe violation of this website's terms and the privacy of the individuals listed, and may result in permanent ban and/or other action under applicable law</p>
                    </p>
                </div>
                                </div>
                            </div>
                        </div>
                    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-disclaimer">
            <p style="margin: 1rem 0; font-size: 0.95rem;">
                <strong>Data Sources:</strong> To view the data sources and attributions used on this page, please visit our 
                <a href="credits.html" style="color: #3498db; text-decoration: none; font-weight: 600; border-bottom: 2px solid transparent; transition: border-color 0.3s ease;" 
                   onmouseover="this.style.borderColor='#3498db'" 
                   onmouseout="this.style.borderColor='transparent'">
                    Credits & Attributions
                </a> page.
            </p>
            <br></p>
            <p><strong>Disclaimer:</strong> We strive to provide the most accurate and up-to-date data available; however, we cannot guarantee its completeness, accuracy, or fitness for any particular purpose. This guidance is advisory only and should never be relied upon as a substitute for official legal, regulatory, or professional advice. We assume no responsibility or liability for any losses, damages, or consequences resulting directly or indirectly from the use of this information. Users assume all risk and must always verify all information with the relevant governmental or legal authorities.

</p>
            <p><br>Report data inaccuracies and/or website bugs <a href="https://forms.gle/NN3anqoQDDi9g5vD7" style="color: #3498db; text-decoration: underline; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.color='#5dade2'; this.style.textDecoration='none'" onmouseout="this.style.color='#3498db'; this.style.textDecoration='underline'">here</a>.</p>

        </div>
        <a href="#" class="admin-link" id="adminLoginBtn">Login</a>
    </footer>

    <!-- Admin Modal -->
    <div id="adminModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2>üîê Admin Panel</h2>
                <button class="close-modal" id="closeAdminModal">&times;</button>
            </div>
            
            <!-- Login Form -->
            <div id="adminLoginForm" class="admin-login-form active">
                <div class="form-group">
                    <label for="adminEmail">Email</label>
                    <input type="email" id="adminEmail" placeholder="admin@example.com" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter password" required>
                </div>
                <button class="btn" id="loginBtn">Login</button>
            </div>
            
            <!-- Admin Panel (shown after login) -->
            <div id="adminPanelContent" class="admin-panel">
                <div class="admin-user-info">
                    <p><strong>üë§ Logged in as:</strong> <span id="userEmail"></span></p>
                    <button class="btn btn-logout" id="logoutBtn">Logout</button>
                    <br><br><p> ‚ö†Ô∏è <b> Please ensure to verify the information is accurate before you create, edit, or delete location-specific instructions.</b></p>
                </div>
                
                <!-- Search and Edit Section -->
                <div style="background: #f8f9fa; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #e0e0e0;">
                    <h3 style="margin-bottom: 1rem;">üîç Search & Edit Instructions</h3>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="searchInput">Search by Owner, Jurisdiction, or State</label>
                        <input type="text" id="searchInput" placeholder="Type to search...">
                        <small style="color: #7f8c8d;">Search across all property instructions</small>
                    </div>
                    <button type="button" class="btn" id="searchBtn" style="background: #3498db;">üîç Search</button>
                    <button type="button" class="btn" id="loadAllBtn" style="background: #95a5a6; margin-left: 0.5rem;">üìã Load All</button>
                    
                    <!-- Search Results -->
                    <div id="searchResults" style="margin-top: 1.5rem; display: none;">
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">Search Results</h4>
                        <div id="searchResultsList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <!-- Edit Form (hidden by default) -->
                <div id="editFormContainer" style="display: none; background: #fff3cd; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #ffc107;">
                    <h3 style="margin-bottom: 1rem;">‚úèÔ∏è Edit Instruction</h3>
                    <form id="editInstructionForm">
                        <input type="hidden" id="editDocId">
                        
                        <div class="form-group">
                            <label for="editOwner">Property Owner (optional)</label>
                            <input type="text" id="editOwner" placeholder="e.g., City of Redmond">
                            <small style="color: #7f8c8d;">For TIER 1 matching - specific property owner</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editJurisdiction">Jurisdiction (optional)</label>
                            <input type="text" id="editJurisdiction" placeholder="e.g., King">
                            <small style="color: #7f8c8d;">For TIER 2 matching - county or jurisdiction name</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editState">State Abbreviation(s) (optional)</label>
                            <input type="text" id="editState" placeholder="e.g., WA or WA, OR, CA" style="text-transform: uppercase;">
                            <small style="color: #7f8c8d;">For TIER 2.5 matching - state-wide fallback. Use commas for multiple states (e.g., WA, OR, CA)</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="editKeywords">Keywords (comma-separated)</label>
                            <input type="text" id="editKeywords" placeholder="e.g., redmond, city of redmond">
                            <small style="color: #7f8c8d;">Keywords to match against owner/jurisdiction</small>
                            <div id="editKeywordPreview" class="keyword-list"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSpecialInstructions">Special Instructions</label>
                            <textarea id="editSpecialInstructions" placeholder="Enter special instructions (optional)" rows="3"></textarea>
                        </div>
                        
                        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                        
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìû Contacts</h4>
                        <div id="editContactsList"></div>
                        <button type="button" class="btn" id="editAddContactBtn" style="background: #27ae60; margin-bottom: 1rem;">‚ûï Add Contact</button>
                        
                        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                        
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìù General Instructions</h4>
                        <div class="form-group">
                            <label for="editGeneralNotes">General Notes & Instructions (optional)</label>
                            <textarea id="editGeneralNotes" placeholder="Enter any general instructions..." rows="4"></textarea>
                        </div>
                        
                        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                        
                        <button type="submit" class="btn" style="background: #f39c12;">üíæ Update Instruction</button>
                        <button type="button" class="btn" id="cancelEditBtn" style="background: #95a5a6; margin-left: 0.5rem;">‚ùå Cancel</button>
                        <button type="button" class="btn" id="deleteBtn" style="background: #e74c3c; float: right;">üóëÔ∏è Delete</button>
                    </form>
                </div>
                
                <h3>Add New Property Instructions</h3>
                <p style="color: #666; margin-bottom: 1.5rem; font-size: 0.95rem;">
                    <strong>Note:</strong> Provide at least one of Owner, Jurisdiction, or State. 
                    For state-wide entries (e.g., State Archaeologist), fill in State(s) and leave Owner/Jurisdiction blank. For multi-state coverage, use commas (e.g., WA, OR, CA).
                </p>
                <form id="addInstructionForm">
                    <div class="form-group">
                        <label for="instructionOwner">Property Owner (optional)</label>
                        <input type="text" id="instructionOwner" placeholder="e.g., City of Redmond">
                        <small style="color: #7f8c8d;">For TIER 1 matching - specific property owner</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionJurisdiction">Jurisdiction (optional)</label>
                        <input type="text" id="instructionJurisdiction" placeholder="e.g., King">
                        <small style="color: #7f8c8d;">For TIER 2 matching - county or jurisdiction name</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionState">State Abbreviation(s) (optional)</label>
                        <input type="text" id="instructionState" placeholder="e.g., WA or WA, OR, CA" style="text-transform: uppercase;">
                        <small style="color: #7f8c8d;">For TIER 2.5 matching - state-wide fallback (e.g., State Archaeologist). Use commas for multiple states. Leave Owner & Jurisdiction blank for state-only entries.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionKeywords">Keywords (comma-separated)</label>
                        <input type="text" id="instructionKeywords" placeholder="e.g., redmond, city of redmond, redmond city">
                        <small style="color: #7f8c8d;">Keywords to match against owner/jurisdiction</small>
                        <div id="keywordPreview" class="keyword-list"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructionSpecialInstructions">Special Instructions</label>
                        <textarea id="instructionSpecialInstructions" placeholder="Enter special instructions (optional)" rows="3"></textarea>
                        <small style="color: #7f8c8d;">Any additional guidance or warnings</small>
                    </div>
                    
                    <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                    
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìû Contacts</h4>
                    <small style="color: #7f8c8d; display: block; margin-bottom: 1rem;">Add one or more contacts for this property</small>
                    <div id="contactsList">
                        <!-- Contacts will be added here dynamically -->
                    </div>
                    
                    <button type="button" class="btn" id="addContactBtn" style="background: #27ae60; margin-bottom: 1rem;">
                        ‚ûï Add Contact
                    </button>
                    
                    <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                    
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">üìù General Instructions</h4>
                    <div class="form-group">
                        <label for="instructionGeneralNotes">General Notes & Instructions (optional)</label>
                        <textarea id="instructionGeneralNotes" placeholder="Enter any general instructions, procedures, or important information not specific to contacts..." rows="4"></textarea>
                        <small style="color: #7f8c8d;">Additional guidance, procedures, legal requirements, or general information for this property</small>
                    </div>
                    
                    <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
                    
                    <button type="submit" class="btn">üíæ Save Instruction</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCCYpXOczp5nRRP1S2Gdb1ADjIAHeJQVq0",
            authDomain: "owlcheologists.firebaseapp.com",
            projectId: "owlcheologists",
            storageBucket: "owlcheologists.firebasestorage.app",
            messagingSenderId: "323297596743",
            appId: "1:323297596743:web:c9455e40779b7c09522862",
            measurementId: "G-2CFYWTQCQ4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ============== ADMIN AUTHENTICATION & PERMISSIONS ==============
        let currentUser = null;
        let userPermissions = {
            laws: true,
            deletion: true,
            found: true
        };

        /* PERMISSIONS SYSTEM:
         * To restrict user access, create a document in Firebase:
         * Collection: config
         * Document ID: user's email (e.g., user@example.com)
         * Fields:
         *   - laws: false (blocks access to Laws admin panel)
         *   - deletion: false (prevents deleting laws, resources, and artifact instructions)
         *   - found: false (hides "I Found an Artifact" page link and restricts access)
         *   - edu: false (prevents adding/editing educational resources)
         * 
         * If no config document exists for a user, all permissions default to true.
         */

        // Load user permissions from Firebase
        async function loadUserPermissions(email) {
            try {
                const configRef = doc(db, 'config', email);
                const configSnap = await getDoc(configRef);
                
                if (configSnap.exists()) {
                    const permData = configSnap.data();
                    userPermissions = {
                        laws: permData.laws !== false,
                        deletion: permData.deletion !== false,
                        found: permData.found !== false
                    };
                    console.log('User permissions loaded:', userPermissions);
                } else {
                    // Default permissions if no config exists
                    userPermissions = { laws: true, deletion: true, found: true };
                    console.log('No permission config found, using defaults:', userPermissions);
                }
                
                applyPermissions();
            } catch (error) {
                console.error('Error loading permissions:', error);
                // Default to all permissions on error
                userPermissions = { laws: true, deletion: true, found: true };
                applyPermissions();
            }
        }

        // Apply permissions to UI
        function applyPermissions() {
            // Hide/disable Laws link
            const lawsLinks = document.querySelectorAll('a[href="laws.html"]');
            lawsLinks.forEach(link => {
                if (!userPermissions.laws) {
                    link.style.display = 'none';
                } else {
                    link.style.display = '';
                }
            });

            // Hide/disable Delete button
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) {
                if (!userPermissions.deletion) {
                    deleteBtn.style.display = 'none';
                } else {
                    deleteBtn.style.display = '';
                }
            }

            // Hide "I Found an Artifact" navigation links if found: false
            // Users can still access the page directly, but can't use admin panel
            if (!userPermissions.found) {
                const foundLinks = document.querySelectorAll('a[href="artifactHelp.html"]');
                foundLinks.forEach(link => {
                    link.style.display = 'none';
                });
            }
        }

        // Check auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log('User logged in:', user.email);
                await loadUserPermissions(user.email);
                
                // Check if user has found permission
                if (!userPermissions.found) {
                    console.log('User does not have found permission');
                    alert('‚õî You do not have permission to access the admin panel for artifact instructions.\n\nContact your administrator to request access.');
                    // Sign out the user
                    await signOut(auth);
                    showLoginForm();
                    return;
                }
                
                showAdminPanel(user);
            } else {
                currentUser = null;
                console.log('User logged out');
                // Reset to default permissions when logged out
                userPermissions = { laws: true, deletion: true, found: true };
                applyPermissions();
                showLoginForm();
            }
        });

        // Admin modal controls
        document.getElementById('adminLoginBtn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Check if user has permission to access admin panel
            if (currentUser && !userPermissions.found) {
                alert('‚õî You do not have permission to access the admin panel for artifact instructions.\n\nContact your administrator to request access.');
                return;
            }
            
            document.getElementById('adminModal').classList.add('active');
        });

        document.getElementById('closeAdminModal').addEventListener('click', function() {
            document.getElementById('adminModal').classList.remove('active');
        });

        // Close modal when clicking outside
        document.getElementById('adminModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });

        // Login functionality
        document.getElementById('loginBtn').addEventListener('click', async function() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Login successful:', userCredential.user.email);
                // onAuthStateChanged will handle UI update
            } catch (error) {
                console.error('Login error:', error);
                alert(`Login failed: ${error.message}`);
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await signOut(auth);
                console.log('Logout successful');
                // onAuthStateChanged will handle UI update
            } catch (error) {
                console.error('Logout error:', error);
                alert(`Logout failed: ${error.message}`);
            }
        });

        // Show login form
        function showLoginForm() {
            document.getElementById('adminLoginForm').classList.add('active');
            document.getElementById('adminPanelContent').classList.remove('active');
        }

        // Show admin panel
        function showAdminPanel(user) {
            document.getElementById('adminLoginForm').classList.remove('active');
            document.getElementById('adminPanelContent').classList.add('active');
            document.getElementById('userEmail').textContent = user.email;
            
            // Add first contact field automatically if no contacts exist
            if (document.getElementById('contactsList').children.length === 0) {
                addContactField();
            }
        }

        // ============== CONTACT MANAGEMENT ==============
        let contactCounter = 0;
        
        function addContactField() {
            contactCounter++;
            const contactsList = document.getElementById('contactsList');
            
            const contactItem = document.createElement('div');
            contactItem.className = 'contact-item';
            contactItem.dataset.contactId = contactCounter;
            
            contactItem.innerHTML = `
                <div class="contact-item-header">
                    <h5>Contact ${contactCounter}</h5>
                    <button type="button" class="remove-contact-btn" onclick="removeContact(${contactCounter})">
                        üóëÔ∏è Remove
                    </button>
                </div>
                <div class="contact-fields">
                    <div class="form-group">
                        <label>Contact Name *</label>
                        <input type="text" class="contact-name" placeholder="e.g., John Smith" required>
                    </div>
                    <div class="form-group">
                        <label>Role/Title</label>
                        <input type="text" class="contact-role" placeholder="e.g., County Archaeologist">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="contact-email" placeholder="e.g., contact@example.com">
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" class="contact-phone" placeholder="e.g., (555) 123-4567">
                    </div>
                    <div class="form-group full-width">
                        <label>Physical Address</label>
                        <input type="text" class="contact-address" placeholder="e.g., 123 Main St, City, State ZIP">
                    </div>
                    <div class="form-group full-width">
                        <label>Special Instructions</label>
                        <textarea class="contact-instructions" placeholder="e.g., Call between 9 AM - 5 PM" rows="2"></textarea>
                    </div>
                </div>
            `;
            
            contactsList.appendChild(contactItem);
        }
        
        window.removeContact = function(contactId) {
            const contactItem = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (contactItem) {
                contactItem.remove();
            }
        };
        
        function getContactsData() {
            const contacts = [];
            const contactItems = document.querySelectorAll('.contact-item');
            
            contactItems.forEach((item) => {
                const name = item.querySelector('.contact-name').value.trim();
                const role = item.querySelector('.contact-role').value.trim();
                const email = item.querySelector('.contact-email').value.trim();
                const phone = item.querySelector('.contact-phone').value.trim();
                const address = item.querySelector('.contact-address').value.trim();
                const instructions = item.querySelector('.contact-instructions').value.trim();
                
                if (name) { // Only add if name is provided
                    contacts.push({
                        name: name,
                        role: role || '',
                        email: email || '',
                        phone: phone || '',
                        address: address || '',
                        specialInstructions: instructions || ''
                    });
                }
            });
            
            return contacts;
        }
        // ============== END CONTACT MANAGEMENT ==============

        // Initialize admin panel event listeners (called after DOM is ready)
        function initializeAdminEventListeners() {
            console.log('üîß Initializing admin event listeners...');
            
            // Auto-uppercase state abbreviation input
            const stateInput = document.getElementById('instructionState');
            if (stateInput) {
                stateInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase();
                });
                console.log('‚úì State input listener attached');
            } else {
                console.error('‚ùå instructionState element not found');
            }

            // Keyword preview
            const keywordsInput = document.getElementById('instructionKeywords');
            if (keywordsInput) {
                keywordsInput.addEventListener('input', function() {
                    const keywords = this.value.split(',').map(k => k.trim()).filter(k => k);
                    const preview = document.getElementById('keywordPreview');
                    preview.innerHTML = keywords.map(keyword => 
                        `<span class="keyword-tag">${keyword}</span>`
                    ).join('');
                });
                console.log('‚úì Keywords input listener attached');
            } else {
                console.error('‚ùå instructionKeywords element not found');
            }

            // Add contact button handler
            const addContactBtn = document.getElementById('addContactBtn');
            if (addContactBtn) {
                addContactBtn.addEventListener('click', function() {
                    console.log('Add contact clicked');
                    addContactField();
                });
                console.log('‚úì Add contact button listener attached');
            } else {
                console.error('‚ùå addContactBtn element not found');
            }

            // Add instruction form submission
            const form = document.getElementById('addInstructionForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    console.log('üöÄ Form submit event triggered!');
                    e.preventDefault();

                    if (!currentUser) {
                        alert('You must be logged in to add instructions');
                        return;
                    }

                    // Check found permission
                    if (!userPermissions.found) {
                        alert('‚õî You do not have permission to add artifact instructions.\n\nContact your administrator to request access.');
                        return;
                    }

                    console.log('User authenticated:', currentUser.email);

                    const owner = document.getElementById('instructionOwner').value.trim();
                    const jurisdiction = document.getElementById('instructionJurisdiction').value.trim();
                    const state = document.getElementById('instructionState').value.trim().toUpperCase();
                    const keywordsInput = document.getElementById('instructionKeywords').value.trim();
                    const specialInstructions = document.getElementById('instructionSpecialInstructions').value.trim();
                    const generalNotes = document.getElementById('instructionGeneralNotes').value.trim();

                    console.log('Form values:', { owner, jurisdiction, state, keywordsInput, specialInstructions, generalNotes });

                    // Validation: Require at least owner, jurisdiction, OR state
                    if (!owner && !jurisdiction && !state) {
                        alert('Please provide at least one of: Owner, Jurisdiction, or State');
                        return;
                    }

                    // Get contacts data
                    const contacts = getContactsData();
                    console.log('Contacts:', contacts);
                    
                    if (contacts.length === 0) {
                        alert('Please add at least one contact');
                        return;
                    }

                    // Parse keywords
                    const keywords = keywordsInput.split(',')
                        .map(k => k.trim().toLowerCase())
                        .filter(k => k);

                    console.log('Generating HTML content...');
                    // Generate HTML content from contacts
                    const htmlContent = generateHTMLFromContacts(contacts, specialInstructions, generalNotes);

                    // Create instruction document
                    const instructionData = {
                        htmlContent: htmlContent,
                        keywords: keywords,
                        contacts: contacts,
                        specialInstructions: specialInstructions,
                        generalNotes: generalNotes,
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.email
                    };

                    // Add optional fields
                    if (owner) instructionData.owner = owner;
                    if (jurisdiction) instructionData.jurisdiction = jurisdiction;
                    if (state) instructionData.state = state;

                    console.log('Saving to Firebase...', instructionData);

                    try {
                        // Generate a unique ID
                        const docId = `instruction_${Date.now()}`;
                        await setDoc(doc(db, 'artifactInstructions', docId), instructionData);
                        
                        console.log('‚úÖ Saved successfully!');
                        alert('‚úÖ Instruction added successfully!');
                        
                        // Reset form
                        document.getElementById('addInstructionForm').reset();
                        document.getElementById('keywordPreview').innerHTML = '';
                        document.getElementById('contactsList').innerHTML = '';
                        contactCounter = 0;
                        
                        console.log('Instruction added:', docId, instructionData);
                    } catch (error) {
                        console.error('‚ùå Error adding instruction:', error);
                        alert(`Failed to add instruction: ${error.message}`);
                    }
                });
                console.log('‚úì Form submit listener attached');
            } else {
                console.error('‚ùå addInstructionForm element not found');
            }
            
            // Search button
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    searchInstructions(searchTerm);
                });
                console.log('‚úì Search button listener attached');
            }
            
            // Load all button
            const loadAllBtn = document.getElementById('loadAllBtn');
            if (loadAllBtn) {
                loadAllBtn.addEventListener('click', function() {
                    searchInstructions('');
                });
                console.log('‚úì Load all button listener attached');
            }
            
            // Search input enter key
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchInstructions(this.value.trim());
                    }
                });
                console.log('‚úì Search input listener attached');
            }
            
            // Edit form submit
            const editForm = document.getElementById('editInstructionForm');
            if (editForm) {
                editForm.addEventListener('submit', updateInstruction);
                console.log('‚úì Edit form listener attached');
            }
            
            // Edit keyword preview
            const editKeywordsInput = document.getElementById('editKeywords');
            if (editKeywordsInput) {
                editKeywordsInput.addEventListener('input', function() {
                    const keywords = this.value.split(',').map(k => k.trim()).filter(k => k);
                    const preview = document.getElementById('editKeywordPreview');
                    preview.innerHTML = keywords.map(keyword => 
                        `<span class="keyword-tag">${keyword}</span>`
                    ).join('');
                });
                console.log('‚úì Edit keywords input listener attached');
            }
            
            // Edit state auto-uppercase
            const editStateInput = document.getElementById('editState');
            if (editStateInput) {
                editStateInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase();
                });
                console.log('‚úì Edit state input listener attached');
            }
            
            // Edit add contact button
            const editAddContactBtn = document.getElementById('editAddContactBtn');
            if (editAddContactBtn) {
                editAddContactBtn.addEventListener('click', function() {
                    addEditContactField();
                });
                console.log('‚úì Edit add contact button listener attached');
            }
            
            // Cancel edit button
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', cancelEdit);
                console.log('‚úì Cancel edit button listener attached');
            }
            
            // Delete button
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', deleteInstruction);
                console.log('‚úì Delete button listener attached');
            }
            
            console.log('‚úÖ Admin event listeners initialization complete');
        }

        // Generate HTML content from contacts
        function generateHTMLFromContacts(contacts, specialInstructions, generalNotes) {
            let html = '<div class="emergency-note">\n';
            html += '    <strong>‚ö†Ô∏è STOP! Do not disturb the artifact or the surrounding area.</strong>\n';
            html += '</div>\n\n';
            
            if (specialInstructions) {
                html += '<div class="contact-card" style="background: #fff3cd; border-color: #ffeaa7;">\n';
                html += '    <h4>‚ö†Ô∏è Special Instructions</h4>\n';
                html += `    <div class="contact-info"><p>${specialInstructions.replace(/\n/g, '<br>')}</p></div>\n`;
                html += '</div>\n\n';
            }
            
            contacts.forEach((contact, index) => {
                html += '<div class="contact-card">\n';
                html += `    <h4>üìû Contact ${index + 1}: ${contact.name}</h4>\n`;
                html += '    <div class="contact-info">\n';
                
                if (contact.role) {
                    html += `        <p><strong>Role:</strong> ${contact.role}</p>\n`;
                }
                if (contact.email) {
                    html += `        <p><strong>Email:</strong> <a href="mailto:${contact.email}">${contact.email}</a></p>\n`;
                }
                if (contact.phone) {
                    html += `        <p><strong>Phone:</strong> <a href="tel:${contact.phone}">${contact.phone}</a></p>\n`;
                }
                if (contact.address) {
                    html += `        <p><strong>Address:</strong> ${contact.address}</p>\n`;
                }
                if (contact.specialInstructions) {
                    html += `        <p><strong>Instructions:</strong> ${contact.specialInstructions}</p>\n`;
                }
                
                html += '    </div>\n';
                html += '</div>\n\n';
            });
            
            html += '<h4>Immediate Steps to Take:</h4>\n';
            html += '<ol style="margin: 1rem 0; padding-left: 2rem; line-height: 1.8;">\n';
            html += '    <li><strong>Stop all work</strong> in the immediate area</li>\n';
            html += '    <li><strong>Do not touch or move</strong> the artifact</li>\n';
            html += '    <li><strong>Contact the above authority</strong> immediately</li>\n';
            html += '    <li><strong>Mark the location</strong> with flags or cones if available</li>\n';
            html += '    <li><strong>Take photos</strong> of the artifact in place (do not disturb)</li>\n';
            html += '    <li><strong>Record GPS coordinates</strong> of the exact location</li>\n';
            html += '    <li><strong>Secure the area</strong> to prevent disturbance by others</li>\n';
            html += '    <li><strong>Document everything</strong> - date, time, weather, surrounding features</li>\n';
            html += '</ol>\n';
            
            if (generalNotes) {
                html += '\n<div class="contact-card" style="background: #e3f2fd; border-color: #90caf9;">\n';
                html += '    <h4>üìã Additional Information</h4>\n';
                html += `    <div class="contact-info">\n`;
                html += `        <p>${generalNotes.replace(/\n/g, '<br>')}</p>\n`;
                html += '    </div>\n';
                html += '</div>\n';
            }
            
            return html;
        }

        // ============== SEARCH AND EDIT FUNCTIONS ==============
        let editContactCounter = 0;
        let currentEditDocId = null;

        // Search for instructions
// Search for instructions
async function searchInstructions(searchTerm = '') {
    try {
        const instructionsRef = collection(db, 'artifactInstructions');
        const snapshot = await getDocs(instructionsRef);
        
        let results = [];
        snapshot.forEach((doc) => {
            const data = doc.data();
            const docId = doc.id;
            
            if (!searchTerm) {
                // Load all if no search term
                results.push({ id: docId, ...data });
                return;
            }
            
            const term = searchTerm.toLowerCase().trim();
            
            // Check if searching by document ID (exact match)
            if (docId.toLowerCase() === term) {
                results.push({ id: docId, ...data });
                return;
            }
            
            // Check if document ID starts with search term (partial match)
            if (docId.toLowerCase().startsWith(term)) {
                results.push({ id: docId, ...data });
                return;
            }
            
            // Otherwise search in other fields
            const owner = (data.owner || '').toLowerCase();
            const jurisdiction = (data.jurisdiction || '').toLowerCase();
            const state = (data.state || '').toLowerCase();
            const keywords = (data.keywords || []).map(k => k.toLowerCase());
            
            if (owner.includes(term) || 
                jurisdiction.includes(term) || 
                state.includes(term) ||
                keywords.some(k => k.includes(term))) {
                results.push({ id: docId, ...data });
            }
        });
        
        displaySearchResults(results);
    } catch (error) {
        console.error('Error searching instructions:', error);
        alert('Failed to search instructions: ' + error.message);
    }
}
        // Display search results
        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            const resultsList = document.getElementById('searchResultsList');
            
            if (results.length === 0) {
                resultsList.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 2rem;">No results found</p>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                const owner = result.owner || 'N/A';
                const jurisdiction = result.jurisdiction || 'N/A';
                const state = result.state || 'N/A';
                const contactCount = result.contacts ? result.contacts.length : 0;
                
                html += `
                    <div style="background: white; padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; border: 1px solid #e0e0e0; cursor: pointer; transition: all 0.3s ease;"
                         onmouseover="this.style.borderColor='#3498db'; this.style.boxShadow='0 2px 8px rgba(52,152,219,0.2)'"
                         onmouseout="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"
                         onclick="loadInstructionForEdit('${result.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: #2c3e50;">Owner:</strong> ${owner}<br>
                                <strong style="color: #2c3e50;">Jurisdiction:</strong> ${jurisdiction}<br>
                                <strong style="color: #2c3e50;">State:</strong> ${state}<br>
                                <small style="color: #7f8c8d;">${contactCount} contact(s) ‚Ä¢ Created ${new Date(result.createdAt).toLocaleDateString()}</small>
                            </div>
                            <button class="btn" style="padding: 0.5rem 1rem; background: #3498db;">‚úèÔ∏è Edit</button>
                        </div>
                    </div>
                `;
            });
            
            resultsList.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        // Load instruction for editing
        async function loadInstructionForEdit(docId) {
            if (!currentUser) {
                alert('You must be logged in to edit instructions');
                return;
            }

            // Check found permission
            if (!userPermissions.found) {
                alert('‚õî You do not have permission to edit artifact instructions.\n\nContact your administrator to request access.');
                return;
            }

            try {
                const docRef = doc(db, 'artifactInstructions', docId);
                const snapshot = await getDocs(query(collection(db, 'artifactInstructions'), where('__name__', '==', docId)));
                
                if (snapshot.empty) {
                    alert('Instruction not found');
                    return;
                }
                
                const data = snapshot.docs[0].data();
                currentEditDocId = docId;
                
                // Fill form fields
                document.getElementById('editDocId').value = docId;
                document.getElementById('editOwner').value = data.owner || '';
                document.getElementById('editJurisdiction').value = data.jurisdiction || '';
                document.getElementById('editState').value = data.state || '';
                document.getElementById('editKeywords').value = (data.keywords || []).join(', ');
                document.getElementById('editSpecialInstructions').value = data.specialInstructions || '';
                document.getElementById('editGeneralNotes').value = data.generalNotes || '';
                
                // Update keyword preview
                const keywords = (data.keywords || []).join(', ');
                document.getElementById('editKeywordPreview').innerHTML = (data.keywords || []).map(keyword => 
                    `<span class="keyword-tag">${keyword}</span>`
                ).join('');
                
                // Load contacts
                const contactsList = document.getElementById('editContactsList');
                contactsList.innerHTML = '';
                editContactCounter = 0;
                
                if (data.contacts && data.contacts.length > 0) {
                    data.contacts.forEach(contact => {
                        addEditContactField(contact);
                    });
                } else {
                    addEditContactField();
                }
                
                // Show edit form and scroll to it
                document.getElementById('editFormContainer').style.display = 'block';
                document.getElementById('editFormContainer').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error loading instruction:', error);
                alert('Failed to load instruction: ' + error.message);
            }
        }

        // Add contact field to edit form
        function addEditContactField(contactData = null) {
            editContactCounter++;
            const contactsList = document.getElementById('editContactsList');
            
            const contactDiv = document.createElement('div');
            contactDiv.className = 'contact-item';
            contactDiv.id = `edit-contact-${editContactCounter}`;
            contactDiv.style.cssText = 'background: #f8f9fa; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; border: 2px solid #e0e0e0; position: relative;';
            
            contactDiv.innerHTML = `
                <button type="button" class="remove-contact-btn" onclick="removeEditContact(${editContactCounter})" 
                        style="position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; border: none; 
                               border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem; line-height: 1;">√ó</button>
                <h5 style="margin-bottom: 1rem; color: #2c3e50;">Contact ${editContactCounter}</h5>
                
                <div class="form-group">
                    <label>Contact Name *</label>
                    <input type="text" class="edit-contact-name" placeholder="e.g., John Smith" value="${contactData?.name || ''}" required>
                </div>
                
                <div class="form-group">
                    <label>Role/Title</label>
                    <input type="text" class="edit-contact-role" placeholder="e.g., State Archaeologist" value="${contactData?.role || ''}">
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="edit-contact-email" placeholder="e.g., contact@example.com" value="${contactData?.email || ''}">
                </div>
                
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" class="edit-contact-phone" placeholder="e.g., (555) 123-4567" value="${contactData?.phone || ''}">
                </div>
                
                <div class="form-group">
                    <label>Physical Address</label>
                    <textarea class="edit-contact-address" placeholder="Enter full address" rows="2">${contactData?.address || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Special Instructions (Contact-specific)</label>
                    <textarea class="edit-contact-instructions" placeholder="Any special notes for this contact" rows="2">${contactData?.specialInstructions || ''}</textarea>
                </div>
            `;
            
            contactsList.appendChild(contactDiv);
        }

        // Remove contact from edit form
        function removeEditContact(contactId) {
            const contactDiv = document.getElementById(`edit-contact-${contactId}`);
            if (contactDiv) {
                contactDiv.remove();
            }
        }

        // Get contacts data from edit form
        function getEditContactsData() {
            const contactItems = document.querySelectorAll('#editContactsList .contact-item');
            const contacts = [];
            
            contactItems.forEach((item) => {
                const name = item.querySelector('.edit-contact-name')?.value.trim();
                const role = item.querySelector('.edit-contact-role')?.value.trim();
                const email = item.querySelector('.edit-contact-email')?.value.trim();
                const phone = item.querySelector('.edit-contact-phone')?.value.trim();
                const address = item.querySelector('.edit-contact-address')?.value.trim();
                const specialInstructions = item.querySelector('.edit-contact-instructions')?.value.trim();
                
                if (name) {
                    contacts.push({
                        name,
                        role: role || '',
                        email: email || '',
                        phone: phone || '',
                        address: address || '',
                        specialInstructions: specialInstructions || ''
                    });
                }
            });
            
            return contacts;
        }

        // Update instruction
        async function updateInstruction(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('You must be logged in to update instructions');
                return;
            }

            // Check found permission
            if (!userPermissions.found) {
                alert('‚õî You do not have permission to update artifact instructions.\n\nContact your administrator to request access.');
                return;
            }
            
            const docId = document.getElementById('editDocId').value;
            const owner = document.getElementById('editOwner').value.trim();
            const jurisdiction = document.getElementById('editJurisdiction').value.trim();
            const state = document.getElementById('editState').value.trim().toUpperCase();
            const keywordsInput = document.getElementById('editKeywords').value.trim();
            const specialInstructions = document.getElementById('editSpecialInstructions').value.trim();
            const generalNotes = document.getElementById('editGeneralNotes').value.trim();
            
            // Validation
            if (!owner && !jurisdiction && !state) {
                alert('Please provide at least one of: Owner, Jurisdiction, or State');
                return;
            }
            
            const contacts = getEditContactsData();
            if (contacts.length === 0) {
                alert('Please add at least one contact');
                return;
            }
            
            const keywords = keywordsInput.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
            const htmlContent = generateHTMLFromContacts(contacts, specialInstructions, generalNotes);
            
            const instructionData = {
                htmlContent: htmlContent,
                keywords: keywords,
                contacts: contacts,
                specialInstructions: specialInstructions,
                generalNotes: generalNotes,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.email
            };
            
            if (owner) instructionData.owner = owner;
            if (jurisdiction) instructionData.jurisdiction = jurisdiction;
            if (state) instructionData.state = state;
            
            try {
                await updateDoc(doc(db, 'artifactInstructions', docId), instructionData);
                alert('‚úÖ Instruction updated successfully!');
                
                // Hide edit form and refresh search
                document.getElementById('editFormContainer').style.display = 'none';
                searchInstructions(document.getElementById('searchInput').value);
                
            } catch (error) {
                console.error('Error updating instruction:', error);
                alert('Failed to update instruction: ' + error.message);
            }
        }

        // Delete instruction
        async function deleteInstruction() {
            if (!currentUser) {
                alert('You must be logged in to delete instructions');
                return;
            }

            // Check deletion permission
            if (!userPermissions.deletion) {
                alert('‚õî You do not have permission to delete instructions.\n\nContact your administrator to request deletion access.');
                return;
            }
            
            const docId = document.getElementById('editDocId').value;
            const owner = document.getElementById('editOwner').value || 'N/A';
            const jurisdiction = document.getElementById('editJurisdiction').value || 'N/A';
            
            if (!confirm(`Are you sure you want to delete this instruction?\n\nOwner: ${owner}\nJurisdiction: ${jurisdiction}\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'artifactInstructions', docId));
                alert('‚úÖ Instruction deleted successfully!');
                
                // Hide edit form and refresh search
                document.getElementById('editFormContainer').style.display = 'none';
                searchInstructions(document.getElementById('searchInput').value);
                
            } catch (error) {
                console.error('Error deleting instruction:', error);
                alert('Failed to delete instruction: ' + error.message);
            }
        }

        // Cancel edit
        function cancelEdit() {
            document.getElementById('editFormContainer').style.display = 'none';
            currentEditDocId = null;
        }
        
        // Expose functions to global scope for inline onclick handlers
        window.loadInstructionForEdit = loadInstructionForEdit;
        window.removeEditContact = removeEditContact;
        
        // ============== END SEARCH AND EDIT FUNCTIONS ==============

        // ============== END ADMIN AUTHENTICATION ==============

        // Location option selection
        document.getElementById('manualOption').addEventListener('click', function() {
            selectLocationOption('manual');
        });

        document.getElementById('gpsOption').addEventListener('click', function() {
            selectLocationOption('gps');
        });

        function selectLocationOption(type) {
            // Remove active class from all options
            document.querySelectorAll('.location-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Hide all forms
            document.querySelectorAll('.location-form').forEach(form => {
                form.classList.remove('active');
                form.classList.add('inactive');
            });
            
            // Activate selected option
            if (type === 'manual') {
                document.getElementById('manualOption').classList.add('active');
                document.getElementById('manualForm').classList.remove('inactive');
                document.getElementById('manualForm').classList.add('active');
            } else {
                document.getElementById('gpsOption').classList.add('active');
                document.getElementById('gpsForm').classList.remove('inactive');
                document.getElementById('gpsForm').classList.add('active');
            }
        }

        // Get current location using GPS
        window.getCurrentLocation = function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            const btn = document.querySelector('.location-btn');
            btn.disabled = true;
            btn.textContent = 'Getting location...';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    console.log(`GPS Location: ${lat}, ${lng}`);
                    lookupLocationByCoords(lat, lng);
                },
                function(error) {
                    console.error('Error getting location:', error);
                    alert('Unable to get your location. Please try entering coordinates manually.');
                    btn.disabled = false;
                    btn.textContent = 'Get My Current Location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        };

        // Manual location lookup
        window.lookupLocation = function() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('Please enter valid latitude and longitude values.');
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Please enter valid coordinate ranges (Lat: -90 to 90, Lng: -180 to 180).');
                return;
            }
            
            lookupLocationByCoords(lat, lng);
        };

        // Lookup location by coordinates
        async function lookupLocationByCoords(lat, lng) {
            console.log(`Looking up location: ${lat}, ${lng}`);
            
            // Show results section and loading
            document.getElementById('resultsSection').classList.add('active');
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('propertyResults').style.display = 'none';
            
            try {
                // Call King County Parcel API
                const parcelData = await fetchParcelData(lat, lng);
                
                if (parcelData) {
                    console.log('üéØ Parcel data received, processing...');
                    
                    // Add the search coordinates to parcelData since API doesn't return them
                    parcelData.lat = lat;
                    parcelData.long = lng;
                    
                    // Check for specific instructions in database
                    const specificInstructions = await checkForSpecificInstructions(parcelData);
                    
                    // Display results
                    displayPropertyInfo(parcelData);
                    displayParcelMap(parcelData); // Display the map with polygon
                    displayGuidance(parcelData, specificInstructions);
                } else {
                    console.log('‚ö†Ô∏è No parcel data found for coordinates');
                    displayDefaultGuidance('No property data found for these coordinates. The location might be in an area not covered by the parcel database.');
                }
            } catch (error) {
                console.error('üí• Error during lookup:', error);
                displayDefaultGuidance(`Error during property lookup: ${error.message}`);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('propertyResults').style.display = 'block';
                
                // Reset buttons
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(btn => {
                    btn.disabled = false;
                    if (btn.classList.contains('location-btn')) {
                        btn.textContent = 'Get My Current Location';
                    }
                });
            }
        }

        // Fetch parcel data from new API
        async function fetchParcelData(lat, lng) {
            try {
                console.log('üåê Making API call to getPropertyInfo...');
                
                const apiUrl = `https://getpropertyinfo-gailic6cjq-uc.a.run.app/getPropertyInfo?lat=${lat}&long=${lng}`;
                console.log('üìç API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('üì° API Response status:', response.status);
                console.log('üì° API Response headers:', response.headers);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error Response:', errorText);
                    throw new Error(`API returned status ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('üìä API Response data (full):', JSON.stringify(data, null, 2));
                
                // Normalize state field - API might return 'state_abbr' or 'state'
                if (data && data.state_abbr && !data.state) {
                    data.state = data.state_abbr;
                    console.log('üîÑ Normalized state_abbr to state:', data.state);
                }
                
                // Check if we have actual property data
                if (data && (data.owner || data.jurisdiction)) {
                    console.log('‚úÖ Property data received');
                    console.log('  - Owner:', data.owner || 'Unknown');
                    console.log('  - Jurisdiction:', data.jurisdiction || 'Unknown');
                    console.log('  - State:', data.state || 'Unknown');
                    return data;
                }
                
                console.log('‚ùå No property data found - API returned:', data);
                return null;
                
            } catch (error) {
                console.error('üí• Error fetching property data:', error);
                console.error('üí• Error details:', error.message);
                return null;
            }
        }

        // Check for specific instructions in database - FOUR TIER FALLBACK
        async function checkForSpecificInstructions(propertyData) {
            try {
                const owner = (propertyData.owner || '').toLowerCase().trim();
                const jurisdiction = (propertyData.jurisdiction || '').toLowerCase().trim();
                const state = (propertyData.state || '').toUpperCase().trim();
                
                console.log('\n=== FOUR-TIER MATCHING LOGIC ===');
                console.log('üîç Property Owner:', `"${owner}"`);
                console.log('üîç Property Jurisdiction:', `"${jurisdiction}"`);
                console.log('üîç Property State:', `"${state}"`);
                
                // Get all instructions from database
                const querySnapshot = await getDocs(collection(db, "artifactInstructions"));
                
                if (querySnapshot.empty) {
                    console.log('‚ùå Database is empty - no instructions found');
                    console.log('üí° Add documents to "artifactInstructions" collection via Admin Panel');
                    return null;
                }
                
                console.log(`\nüìö Database has ${querySnapshot.docs.length} instruction(s)`);
                
                let ownerMatch = null;
                let jurisdictionMatch = null;
                let stateMatch = null;
                
                // TIER 1, 2 & 2.5: Loop through all instructions to find best match
                for (const docSnapshot of querySnapshot.docs) {
                    const instruction = docSnapshot.data();
                    const dbOwner = (instruction.owner || '').toLowerCase().trim();
                    const dbJurisdiction = (instruction.jurisdiction || '').toLowerCase().trim();
                    const dbState = (instruction.state || '').toUpperCase().trim();
                    const keywords = (instruction.keywords || []).map(k => k.toLowerCase().trim());
                    
                    console.log(`\nüìÑ Checking: "${docSnapshot.id}"`);
                    console.log('   Owner:', `"${dbOwner}"`, 'Jurisdiction:', `"${dbJurisdiction}"`, 'State:', `"${dbState}"`);
                    console.log('   Keywords:', keywords);
                    
                    // STATE MATCHING: If instruction has states, property state must match ONE of them
                    if (dbState) {
                        const dbStates = dbState.split(',').map(s => s.trim()).filter(s => s);
                        const stateMatches = dbStates.some(s => s === state);
                        
                        if (!state || !stateMatches) {
                            console.log(`   ‚è≠Ô∏è SKIPPED: State mismatch (instruction requires one of [${dbStates.join(', ')}], property is "${state}")`);
                            continue; // Skip this instruction entirely
                        } else {
                            console.log(`   ‚úì State match: "${state}" is in [${dbStates.join(', ')}]`);
                        }
                    }
                    
                    // TIER 1: Check Owner OR Keywords match
                    if (owner && !ownerMatch) {
                        // Direct owner match (bidirectional)
                        if (dbOwner && (owner.includes(dbOwner) || dbOwner.includes(owner))) {
                            console.log('   ‚úÖ TIER 1: Owner name match!');
                            ownerMatch = { ...instruction, matchType: 'owner', docId: docSnapshot.id };
                            break; // Found owner match, stop searching
                        }
                        
                        // Keyword match with owner
                        for (const keyword of keywords) {
                            if (owner.includes(keyword)) {
                                console.log(`   ‚úÖ TIER 1: Keyword match! ("${keyword}" found in owner)`);
                                ownerMatch = { ...instruction, matchType: 'keyword-owner', docId: docSnapshot.id };
                                break;
                            }
                        }
                        
                        if (ownerMatch) break; // Stop after finding owner/keyword match
                    }
                    
                    // TIER 2: Check Jurisdiction match (only if no owner match yet)
                    // STRICT: Only match jurisdiction-only entries (no specific owner required)
                    if (jurisdiction && !ownerMatch && !jurisdictionMatch) {
                        // Only match if this is a jurisdiction-wide entry (no specific owner in DB)
                        // OR if the entry has an owner but it doesn't match (skip it)
                        
                        if (!dbOwner || dbOwner === '') {
                            // This is a jurisdiction-wide entry (applies to all properties in jurisdiction)
                            if (dbJurisdiction && (jurisdiction.includes(dbJurisdiction) || dbJurisdiction.includes(jurisdiction))) {
                                console.log('   ‚úÖ TIER 2: Jurisdiction-wide match (no specific owner required)');
                                jurisdictionMatch = { ...instruction, matchType: 'jurisdiction', docId: docSnapshot.id };
                            }
                            
                            // Check keywords against jurisdiction for jurisdiction-wide entries
                            if (!jurisdictionMatch) {
                                for (const keyword of keywords) {
                                    // Bidirectional keyword matching
                                    if (jurisdiction.includes(keyword) || keyword.includes(jurisdiction)) {
                                        console.log(`   ‚úÖ TIER 2: Jurisdiction keyword match! ("${keyword}" matches "${jurisdiction}")`);
                                        jurisdictionMatch = { ...instruction, matchType: 'keyword-jurisdiction', docId: docSnapshot.id };
                                        break;
                                    }
                                }
                            }
                        } else {
                            // This entry has a specific owner requirement, skip for TIER 2
                            console.log(`   ‚è≠Ô∏è TIER 2: Skipped (entry requires specific owner: "${dbOwner}")`);
                        }
                    }
                    
                    // TIER 2.5: Check State-only match (State Archaeologist fallback)
                    // Only if no owner/jurisdiction match, and entry has state but NO owner and NO jurisdiction
                    if (state && !ownerMatch && !jurisdictionMatch && !stateMatch) {
                        // This is a state-wide entry (e.g., State Archaeologist) - no owner or jurisdiction specified
                        if ((!dbOwner || dbOwner === '') && (!dbJurisdiction || dbJurisdiction === '')) {
                            if (dbState && state === dbState) {
                                console.log('   ‚úÖ TIER 2.5: State-wide match (State Archaeologist)');
                                stateMatch = { ...instruction, matchType: 'state', docId: docSnapshot.id };
                            }
                        }
                    }
                }
                
                // Return best match in priority order
                if (ownerMatch) {
                    console.log(`\nüéØ TIER 1 MATCH FOUND: ${ownerMatch.matchType}`);
                    console.log('   Using:', ownerMatch.docId);
                    return ownerMatch;
                } else if (jurisdictionMatch) {
                    console.log(`\nüéØ TIER 2 MATCH FOUND: ${jurisdictionMatch.matchType}`);
                    console.log('   Using:', jurisdictionMatch.docId);
                    return jurisdictionMatch;
                } else if (stateMatch) {
                    console.log(`\nüéØ TIER 2.5 MATCH FOUND: ${stateMatch.matchType}`);
                    console.log('   Using:', stateMatch.docId);
                    return stateMatch;
                } else {
                    console.log('\n‚ö†Ô∏è NO MATCH FOUND');
                    console.log('üìã TIER 3: Falling back to default basic steps');
                    return null;
                }
                
            } catch (error) {
                console.error('üí• Error checking database:', error);
                return null;
            }
        }

        // Display property information
        function displayPropertyInfo(propertyData) {
            const grid = document.getElementById('propertyInfoGrid');
            
            console.log('üìä Displaying property data:', propertyData);
            
            const info = [
                { label: 'Owner', value: propertyData.owner || 'Unknown' },
                { label: 'Jurisdiction', value: propertyData.jurisdiction || 'Unknown' },
                { label: 'Coordinates', value: `${propertyData.lat || 'N/A'}, ${propertyData.long || 'N/A'}` }
            ];
            
            // Add state if available
            if (propertyData.state) {
                info.push({ label: 'State', value: propertyData.state });
            }
            
            // Add any additional fields from the API response
            if (propertyData.address) {
                info.push({ label: 'Address', value: propertyData.address });
            }
            if (propertyData.parcelNumber) {
                info.push({ label: 'Parcel Number', value: propertyData.parcelNumber });
            }
            
            grid.innerHTML = info.map(item => `
                <div class="info-item">
                    <span class="info-label">${item.label}:</span>
                    <span class="info-value">${item.value}</span>
                </div>
            `).join('');
        }

        // Global map instance tracker
        let parcelMapInstance = null;

        // Display parcel polygon on map
        function displayParcelMap(propertyData) {
            const mapSection = document.getElementById('parcelMapSection');
            
            console.log('üó∫Ô∏è displayParcelMap called with:', propertyData);
            console.log('üó∫Ô∏è Polygon field exists?', !!propertyData.polygon);
            console.log('üó∫Ô∏è Polygon value:', propertyData.polygon);
            
            // Check if polygon data exists
            if (!propertyData.polygon) {
                console.log('‚ö†Ô∏è No polygon data in API response - map will not display');
                console.log('üí° The API needs to return a "polygon" field with WKT MULTIPOLYGON data');
                mapSection.style.display = 'none';
                return;
            }
            
            console.log('üó∫Ô∏è Polygon data found! Rendering map...');
            console.log('Polygon WKT:', propertyData.polygon.substring(0, 100) + '...');
            
            // Remove existing map instance if it exists
            if (parcelMapInstance) {
                console.log('üóëÔ∏è Removing existing map instance...');
                parcelMapInstance.remove();
                parcelMapInstance = null;
            }
            
            // Show map section FIRST
            mapSection.style.display = 'block';
            
            // Wait for DOM to update before creating map
            setTimeout(() => {
                try {
                    // Parse WKT MULTIPOLYGON
                    const coordinates = parseWKT(propertyData.polygon);
                    
                    if (!coordinates || coordinates.length === 0) {
                        console.error('‚ùå Failed to parse polygon coordinates');
                        mapSection.style.display = 'none';
                        return;
                    }
                    
                    console.log('‚úÖ Parsed', coordinates.length, 'coordinate points');
                    console.log('First coordinate:', coordinates[0]);
                    console.log('Last coordinate:', coordinates[coordinates.length - 1]);
                    
                    // Create the map with initial view (store in global variable)
                    parcelMapInstance = L.map('parcelMap').setView([coordinates[0][0], coordinates[0][1]], 15);
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(parcelMapInstance);
                    
                    console.log('Map created, adding polygon...');
                    
                    // Create polygon from coordinates
                    const polygon = L.polygon(coordinates, {
                        color: '#e74c3c',
                        fillColor: '#e74c3c',
                        fillOpacity: 0.3,
                        weight: 3
                    }).addTo(parcelMapInstance);
                    
                    console.log('Polygon added, fitting bounds...');
                    console.log('Polygon bounds:', polygon.getBounds());
                    
                    // Fit map to polygon bounds with padding
                    parcelMapInstance.fitBounds(polygon.getBounds(), { padding: [50, 50] });
                    
                    // Add marker at search location if available
                    if (propertyData.lat && propertyData.long) {
                        L.marker([propertyData.lat, propertyData.long])
                            .addTo(parcelMapInstance)
                            .bindPopup('üìç Search Location')
                            .openPopup();
                    }
                    
                    // Force map to recalculate size
                    setTimeout(() => {
                        parcelMapInstance.invalidateSize();
                        console.log('‚úÖ Map displayed successfully!');
                    }, 100);
                    
                } catch (error) {
                    console.error('üí• Error displaying map:', error);
                    console.error('Error details:', error.message, error.stack);
                    mapSection.style.display = 'none';
                }
            }, 100);
        }

        // Parse WKT MULTIPOLYGON format to Leaflet coordinates
        function parseWKT(wkt) {
            try {
                console.log('üîç Parsing WKT polygon...');
                console.log('Raw WKT length:', wkt.length);
                
                // Remove "MULTIPOLYGON(((" prefix and ")))" suffix
                const coordString = wkt
                    .replace(/^MULTIPOLYGON\(\(\(/i, '')
                    .replace(/\)\)\)$/, '')
                    .trim();
                
                console.log('Cleaned coord string (first 200 chars):', coordString.substring(0, 200));
                
                // Split by coordinate pairs
                const pairs = coordString.split(',');
                console.log('Found', pairs.length, 'coordinate pairs');
                
                // Convert to [lat, lng] format (Leaflet expects lat first, but WKT is lng lat)
                const coordinates = pairs.map((pair, index) => {
                    // Remove extra whitespace and split by space
                    const parts = pair.trim().split(/\s+/);
                    
                    if (parts.length !== 2) {
                        console.warn(`‚ö†Ô∏è Coordinate pair ${index} has ${parts.length} parts:`, pair);
                        return null;
                    }
                    
                    const lng = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    
                    if (isNaN(lng) || isNaN(lat)) {
                        console.error(`‚ùå Invalid coordinate at index ${index}:`, parts);
                        console.error(`   lng: ${parts[0]} -> ${lng}`);
                        console.error(`   lat: ${parts[1]} -> ${lat}`);
                        return null;
                    }
                    
                    return [lat, lng]; // Swap for Leaflet
                }).filter(coord => coord !== null); // Remove invalid coordinates
                
                console.log('‚úÖ Successfully parsed', coordinates.length, 'valid coordinates');
                
                if (coordinates.length < 3) {
                    console.error('‚ùå Not enough valid coordinates for a polygon (need at least 3)');
                    return null;
                }
                
                console.log('First 3 coordinates:', coordinates.slice(0, 3));
                console.log('Last 3 coordinates:', coordinates.slice(-3));
                
                return coordinates;
                
            } catch (error) {
                console.error('üí• Error parsing WKT:', error);
                console.error('Error stack:', error.stack);
                return null;
            }
        }

        // Display guidance based on property and instructions
        function displayGuidance(propertyData, specificInstructions) {
            const guidanceContent = document.getElementById('guidanceContent');
            
            if (specificInstructions && specificInstructions.htmlContent) {
                // TIER 1, TIER 2, or TIER 2.5: Display custom instructions from database
                console.log('üìÑ Displaying custom instructions');
                console.log('Match type:', specificInstructions.matchType);
                
                const matchTypeLabels = {
                    'owner': 'Owner Match',
                    'keyword-owner': 'Keyword Match (Owner)',
                    'jurisdiction': 'Jurisdiction Match',
                    'keyword-jurisdiction': 'Keyword Match (Jurisdiction)',
                    'state': 'State Archaeologist'
                };
                
                const matchLabel = matchTypeLabels[specificInstructions.matchType] || specificInstructions.matchType;
                
                // Determine tier based on match type
                let tier = 'TIER 3';
                if (specificInstructions.matchType.includes('owner') || specificInstructions.matchType === 'owner') {
                    tier = 'TIER 1';
                } else if (specificInstructions.matchType.includes('jurisdiction') || specificInstructions.matchType === 'jurisdiction') {
                    tier = 'TIER 2';
                } else if (specificInstructions.matchType === 'state') {
                    tier = 'TIER 2.5';
                }
                
                // Display match information and contacts summary
                let contactsSummary = '';
                if (specificInstructions.contacts && specificInstructions.contacts.length > 0) {
                    contactsSummary = `
                        <p style="color: #155724; margin-top: 0.5rem;">
                            <strong>Contacts Available:</strong> ${specificInstructions.contacts.length} contact(s) found
                        </p>
                    `;
                }
                
                guidanceContent.innerHTML = `
                    <div class="contact-card" style="background: #d4edda; border-color: #c3e6cb;">
                        <h4>‚úì Custom Instructions Found</h4>
                        <p style="color: #155724; margin-bottom: 0.5rem;">
                            <strong>${tier}:</strong> ${matchLabel}
                        </p>
                        ${contactsSummary}
                        <p style="color: #666; font-size: 0.9rem;">
                            Document: ${specificInstructions.docId || 'N/A'}
                        </p>
                    </div>
                    
                    <div class="custom-instructions-content" style="margin-top: 1.5rem;">
                        ${specificInstructions.htmlContent}
                    </div>
                `;
            } else {
                // TIER 3: Display default basic steps
                console.log('üìÑ TIER 3: Displaying default basic steps');
                displayDefaultGuidance();
            }
        }

        // Display default guidance
        function displayDefaultGuidance(errorInfo = null) {
            const guidanceContent = document.getElementById('guidanceContent');
            const propertyGrid = document.getElementById('propertyInfoGrid');
            
            // Show error info in property section if available
            if (errorInfo) {
                propertyGrid.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value">${errorInfo}</span>
                    </div>
                `;
            }
            
            guidanceContent.innerHTML = getDefaultGuidanceHTML();
        }

        // Get default guidance HTML - Generic for anywhere in the US
        function getDefaultGuidanceHTML() {
            return `
                <div class="emergency-note">
                    <strong>‚ö†Ô∏è STOP! Do not disturb the artifact or the surrounding area.</strong>
                </div>
                
                <div class="contact-card">
                    <h4>üìû Contact Your Local Authorities</h4>
                    <div class="contact-info">
                        <p><strong>County Archaeologist or Planning Department</strong></p>
                        <p>Search online for: "[Your County Name] archaeologist" or "[Your County Name] planning department"</p>
                        <p style="margin-top: 1rem;"><strong>State Historic Preservation Office (SHPO)</strong></p>
                        <p>Every state has a SHPO - search: "[Your State] historic preservation office"</p>
                    </div>
                </div>
                
                <div class="contact-card">
                    <h4>üèõÔ∏è Federal Resources</h4>
                    <div class="contact-info">
                        <p><strong>If on Federal Land:</strong></p>
                        <p>National Park Service, Bureau of Land Management, U.S. Forest Service, etc.</p>
                        <p style="margin-top: 1rem;"><strong>If Native American artifacts:</strong></p>
                        <p>Contact local tribal authorities and NAGPRA coordinator</p>
                    </div>
                </div>
                
                <h4>Immediate Steps to Take:</h4>
                <ol style="margin: 1rem 0; padding-left: 2rem; line-height: 1.8;">
                    <li><strong>Stop all work</strong> in the immediate area</li>
                    <li><strong>Do not touch or move</strong> the artifact</li>
                    <li><strong>Mark the location</strong> with flags or cones if available</li>
                    <li><strong>Take photos</strong> of the artifact in place (do not disturb)</li>
                    <li><strong>Record GPS coordinates</strong> of the exact location</li>
                    <li><strong>Contact local authorities</strong> (county archaeologist, SHPO, or tribal office)</li>
                    <li><strong>Secure the area</strong> to prevent disturbance by others</li>
                    <li><strong>Document everything</strong> - date, time, weather, surrounding features</li>
                </ol>
                
                <div class="emergency-note">
                    <strong>‚öñÔ∏è Legal Notice:</strong> Federal and state laws protect archaeological resources. The Archaeological Resources Protection Act (ARPA) and similar state laws make it illegal to excavate, remove, damage, or otherwise alter archaeological sites on public or tribal lands without a permit. Violations can result in criminal penalties including fines and imprisonment.
                </div>
                
                <div class="contact-card" style="background: #e3f2fd; border-color: #90caf9;">
                    <h4>üìö Learn More</h4>
                    <div class="contact-info">
                        <p>Visit the <a href="laws.html" style="color: #1976d2; font-weight: 600;">Federal Archaeology Laws</a> page to learn about your legal responsibilities.</p>
                    </div>
                </div>
            `;
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded! Initializing...');
            
            // Initialize admin panel event listeners
            initializeAdminEventListeners();
            
            // Auto-fill coordinates for testing and make it obvious
            const lat = document.getElementById('latitude');
            const lng = document.getElementById('longitude');
            if (lat && lng) {
            }
            
            // Force select the manual option and make it visible
            setTimeout(() => {
                selectLocationOption('manual');
                console.log('Manual option selected');
            }, 100);
        });

        // Make sure functions are available globally - move outside the module
        window.lookupLocation = function() {
            console.log('üî• LOOKUP BUTTON CLICKED! üî•');
            
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            console.log('Manual lookup clicked with values:', lat, lng);
            
            if (isNaN(lat) || isNaN(lng)) {
                console.error('Invalid coordinates!', {lat, lng});
                alert('Please enter valid latitude and longitude values.');
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                console.error('Coordinates out of range!', {lat, lng});
                alert('Please enter valid coordinate ranges (Lat: -90 to 90, Lng: -180 to 180).');
                return;
            }
            
            console.log('Calling lookupLocationByCoords...');
            lookupLocationByCoords(lat, lng);
        };

        // Expose getCurrentLocation globally as well
        window.getCurrentLocation = function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            const btn = document.querySelector('.location-btn');
            btn.disabled = true;
            btn.textContent = 'Getting location...';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    console.log(`GPS Location: ${lat}, ${lng}`);
                    lookupLocationByCoords(lat, lng);
                },
                function(error) {
                    console.error('Error getting location:', error);
                    alert('Unable to get your location. Please try entering coordinates manually.');
                    btn.disabled = false;
                    btn.textContent = 'Get My Current Location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        };

        // Load sample coordinates into the form
        window.loadSampleCoords = function(lat, lng, locationName) {
            console.log(`üìç Loading sample location: ${locationName}`);
            console.log(`   Coordinates: ${lat}, ${lng}`);
            
            // Fill in the form fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Automatically trigger the lookup
            lookupLocationByCoords(lat, lng);
        };

        // ============== HAMBURGER MENU ==============
        const hamburger = document.getElementById('hamburger');
        const navLinks = document.getElementById('navLinks');
        
        if (hamburger) {
            hamburger.addEventListener('click', function() {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
            });
            
            // Close menu when clicking on a link
            const navLinkItems = navLinks.querySelectorAll('a');
            navLinkItems.forEach(link => {
                link.addEventListener('click', function() {
                    hamburger.classList.remove('active');
                    navLinks.classList.remove('active');
                });
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                const isClickInsideNav = navLinks.contains(event.target);
                const isClickOnHamburger = hamburger.contains(event.target);
                
                if (!isClickInsideNav && !isClickOnHamburger && navLinks.classList.contains('active')) {
                    hamburger.classList.remove('active');
                    navLinks.classList.remove('active');
                }
            });
        }
        // ============== END HAMBURGER MENU ==============
    </script>
</body>
</html>